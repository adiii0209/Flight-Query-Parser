<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Query</title>
  <link rel="icon" type="image/png" href="/static/ticket-flight.png">
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Syne:wght@700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/static/dashboard.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      max-width: 100%;
      height: 100% !important;
      min-height: 100% !important;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #0ea5e9;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.08);
      --shadow-lg: rgba(15, 23, 42, 0.15);
      --primary-dark-mode: #3b82f6;
      --primary-dark-dark-mode: #2563eb;
      --secondary-dark-mode: #38bdf8;
      --success-dark-mode: #22c55e;
      --danger-dark-mode: #f87171;
      --warning-dark-mode: #fbbf24;
      --bg-main-dark-mode: transparent;
      --bg-card-dark-mode: rgba(30, 41, 59, 0.8);
      /* Semi-transparent card for glassmorphism */
      --text-primary-dark-mode: #f1f5f9;
      --text-secondary-dark-mode: #94a3b8;
      --border-dark-mode: #334155;
      --shadow-dark-mode: rgba(0, 0, 0, 0.3);
      --shadow-lg-dark-mode: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] {
      --primary: var(--primary-dark-mode);
      --primary-dark: var(--primary-dark-dark-mode);
      --secondary: var(--secondary-dark-mode);
      --success: var(--success-dark-mode);
      --danger: var(--danger-dark-mode);
      --warning: var(--warning-dark-mode);
      --bg-main: var(--bg-main-dark-mode);
      --bg-card: var(--bg-card-dark-mode);
      --text-primary: var(--text-primary-dark-mode);
    }

    [data-theme="valentine"] {
      --primary: #ff69b4;
      --primary-dark: #ff1493;
      --secondary: #ffb6c1;
      --success: #ff8da1;
      --danger: #ff4d6d;
      --warning: #ffccd5;
      --bg-main: #fff0f3;
      --bg-card: rgba(255, 255, 255, 0.9);
      --text-primary: #590d22;
      --text-secondary: #800f2f;
      --border: #ffccd5;
      --shadow: rgba(255, 77, 109, 0.1);
      --shadow-lg: rgba(255, 77, 109, 0.2);
    }

    [data-theme="valentine"] body {
      background-image: radial-gradient(#ffccd5 2px, transparent 2px);
      background-size: 30px 30px;
    }

    [data-theme="valentine"] .app-header {
      background: linear-gradient(135deg, #ff4d6d 0%, #ff758f 50%, #ff8da1 100%) !important;
      border-bottom: 2px solid #ffccd5;
    }

    [data-theme="valentine"] .brand-name {
      background: linear-gradient(to right, #ffffff, #ffccd5, #ffb6c1, #ffffff) !important;
      -webkit-background-clip: text !important;
      background-clip: text !important;
      color: transparent !important;
      animation: shine 6s linear infinite;
    }

    /* Floating Heart Animation for Header */
    [data-theme="valentine"] .app-header::before {
      content: 'ðŸ’–';
      font-size: 20px;
      position: absolute;
      opacity: 0;
      animation: float-hearts 10s linear infinite;
      z-index: 1;
    }

    @keyframes float-hearts {
      0% {
        transform: translateY(100%) translateX(0) scale(0);
        opacity: 0;
      }

      20% {
        opacity: 0.6;
      }

      80% {
        opacity: 0.6;
      }

      100% {
        transform: translateY(-100%) translateX(100px) scale(1.5);
        opacity: 0;
      }
    }





    /* Theme Transition Curtain */
    .theme-curtain {
      position: fixed;
      top: -100%;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
      pointer-events: none;
    }

    .curtain-light {
      background: #2563eb !important;
    }

    .curtain-dark {
      background: #022c22 !important;
    }

    .curtain-valentine {
      background: #ff69b4 !important;
    }

    .theme-curtain.active {
      transform: translateY(100%);
    }

    .theme-curtain-icon {
      font-size: 5rem;
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
      animation: pulse-icon 1s ease-in-out infinite alternate;
    }

    @keyframes pulse-icon {
      from {
        transform: scale(0.8);
        opacity: 0.5;
      }

      to {
        transform: scale(1.2);
        opacity: 1;
      }
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      width: 100%;
    }

    .app-header {
      background: #04060e;
      color: white;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
      z-index: 1000;
    }

    /* Futreistic Dark Header */
    [data-theme="dark"] .app-header {
      background: linear-gradient(135deg, #022c22 0%, #052e16 50%, #000 100%);
      border-bottom: 1px solid rgba(16, 185, 129, 0.4);
    }

    /* Grid Overlay */
    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 0;
      transform-origin: center center;
    }

    /* Scanline Overlay */
    .app-header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(rgba(16, 185, 129, 0.08) 50%, transparent 50%);
      background-size: 100% 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 1;
    }

    /* Energy pulse highlight */
    .header-content {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 3rem;
    }

    .header-brand {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      white-space: nowrap;
      pointer-events: none;
    }

    .brand-name {
      font-family: 'Syne', sans-serif;
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      color: #ffffff;
      text-transform: uppercase;
      line-height: 1;
      text-shadow: 0 0 30px rgba(147, 197, 253, 0.3);
    }

    .brand-name span {
      background: linear-gradient(90deg, #60a5fa 0%, #38bdf8 50%, #67e8f9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .brand-sub {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.4);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-top: 0.2rem;
    }

    @media (max-width: 600px) {
      .brand-name {
        font-size: 1.2rem;
      }

      .brand-sub {
        font-size: 0.6rem;
        letter-spacing: 0.08em;
      }

      .app-header {
        padding: 1rem;
      }
    }

    [data-theme="dark"] .app-header::before {
      opacity: 1;
      animation: grid-move 60s linear infinite;
      transform: perspective(500px) rotateX(25deg) scale(2);
    }

    [data-theme="dark"] .app-header::after {
      opacity: 1;
      animation: scanline 8s linear infinite;
    }

    @keyframes grid-move {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 400px 400px;
      }
    }

    @keyframes scanline {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 0 100%;
      }
    }

    .app-header:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .app-header:hover {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }


    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .header-btn {
      padding: 0.625rem 1.25rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      font-size: 0.95rem;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .header-btn.primary {
      background: white;
      color: var(--primary);
      border-color: white;
    }

    .header-btn.primary:hover {
      background: #f1f5f9;
    }

    .dark-mode-toggle {
      padding: 0.625rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .dark-mode-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .dark-mode-icon {
      transition: opacity 0.3s ease;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }

    .section {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px var(--shadow);
      border: 1px solid var(--border);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .flight-block {
      background: var(--bg-main);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      position: relative;
      box-sizing: border-box;
    }

    .flight-block:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .flight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .flight-number {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }

    .remove-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .remove-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .search-results {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      max-height: 250px;
      overflow-y: auto;
      margin-top: 5px;
      position: absolute;
      width: 100%;
      z-index: 9999;
    }

    .search-item {
      padding: 10px;
      transition: background 0.2s;
    }

    .search-item:hover {
      background: var(--bg-main);
    }

    .textarea-wrapper {
      margin-bottom: 1.25rem;
    }

    .textarea-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      resize: vertical;
      transition: all 0.3s ease;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea::placeholder {
      color: #94a3b8;
    }

    .fare-types {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }

    .fare-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem;
      transition: all 0.3s ease;
      overflow: hidden;
      box-sizing: border-box;
      max-width: 100%;
    }

    .fare-card:hover {
      border-color: var(--primary);
    }

    .fare-card.disabled {
      opacity: 0.5;
      background: var(--bg-main);
    }

    .fare-card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .fare-card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .fare-card-header label {
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-primary);
    }

    .fare-card-fields {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .fare-field-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
    }

    .fare-field-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 30px;
      flex-shrink: 0;
    }

    .fare-field-input {
      flex: 1;
      min-width: 0;
      width: 100%;
      padding: 0.4rem 0.5rem;
      font-size: 0.8rem;
      border: 1.5px solid var(--border);
      border-radius: 5px;
      font-family: 'Outfit', sans-serif;
      transition: all 0.2s ease;
      background: var(--bg-main);
      color: var(--text-primary);
      box-sizing: border-box;
    }

    .fare-field-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .fare-field-input:disabled {
      background: var(--bg-card);
      cursor: not-allowed;
      color: var(--text-secondary);
    }

    .fare-field-input::placeholder {
      color: #94a3b8;
      font-size: 0.7rem;
    }

    .fare-group {
      flex: 1;
      min-width: 200px;
    }

    /* Inline Fare Editor for Cards */
    .card-wrapper {
      width: 100%;
    }

    .card-edit-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.5rem;
    }

    .card-edit-btn {
      background: var(--bg-card);
      border: 1.5px solid var(--primary);
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: all 0.2s ease;
      color: var(--primary);
      font-weight: 500;
    }

    .card-edit-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .card-edit-btn.active {
      background: var(--border);
      color: var(--text-secondary);
      border-color: var(--border);
    }

    .inline-fare-editor {
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--bg-main);
      border: 2px dashed var(--border);
      border-radius: 10px;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    .inline-fare-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .inline-fare-editor-header h4 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .inline-fare-editor-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: flex-end;
    }

    .inline-fare-editor-actions button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .inline-fare-editor-actions .btn-save {
      background: var(--success);
      color: white;
      border: none;
      font-weight: 600;
    }

    .inline-fare-editor-actions .btn-save:hover {
      background: #059669;
    }

    .inline-fare-editor-actions .btn-cancel {
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1.5px solid var(--border);
    }

    .inline-fare-editor-actions .btn-cancel:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .fare-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }

    .fare-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .fare-checkbox label {
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--text-primary);
    }

    .fare-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-card);
    }

    .fare-input:disabled {
      background: var(--bg-main);
      cursor: not-allowed;
      color: var(--text-secondary);
    }

    .fare-input:not(:disabled):focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .add-flight-btn {
      width: 100%;
      padding: 1.1rem;
      margin-top: 2rem;
      background: var(--bg-card);
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .add-flight-btn:hover {
      border-color: var(--primary);
      background: var(--bg-card);
      color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }

    .markup-section {
      display: flex;
      align-items: flex-end;
      gap: 1rem;
    }

    .input-group {
      flex: 1;
    }

    .input-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .markup-input {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-main);
      color: var(--text-primary);
    }

    .markup-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .card-delete-btn {
      background: #fee2e2;
      color: #dc2626;
      border: 1.5px solid #fecaca;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .card-delete-btn:hover {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }

    .fare-delete-icon-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      opacity: 0.6;
    }

    .fare-delete-icon-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      opacity: 1;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      /* Flexbox centering */
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .modal.show {
      display: flex !important;
    }

    .modal-content {
      background-color: var(--bg-card);
      margin: 0;
      padding: 2rem;
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      animation: modalSlideIn 0.3s ease-out;
      position: relative;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal h3 {
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Outfit', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .parse-section {
      text-align: center;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      width: 100%;
      align-items: start;
      /* Prevents neighbors from stretching in height */
    }

    @media (max-width: 900px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Remove old wrapper specific styles if they interfere, or ensure flight-card is flexible */
    .flight-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px !important;
      padding: 0 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
      overflow: hidden;
      margin-bottom: 0 !important;
      animation: fadeIn 0.5s ease;
      position: relative;
      /* Kept from original */
      width: 100%;
      /* Kept from original */
    }

    .flight-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .flight-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px var(--shadow-lg);
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .card-airline {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.3;
    }

    .card-flight-num {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .card-route {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }

    .card-city {
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-time {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .card-arrow {
      color: var(--primary);
      font-weight: 700;
    }

    .card-details {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .card-detail-item {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
    }

    .card-detail-label {
      font-weight: 500;
    }

    .card-detail-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-fares {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .card-fare-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.05em;
    }

    .fare-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .fare-item:last-child {
      margin-bottom: 0;
    }

    .fare-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .fare-value {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .output-section {
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 1.5rem;
      border-radius: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
      line-height: 1.8;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
      border: 2px solid var(--border);
    }

    .output-section::-webkit-scrollbar {
      width: 8px;
    }

    .output-section::-webkit-scrollbar-track {
      background: var(--bg-main);
      border-radius: 4px;
    }

    .output-section::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .output-section::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loader-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .loader-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--bg-card);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    #notification-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      pointer-events: none;
    }

    .notification {
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 8px 24px var(--shadow-lg);
      border-left: 4px solid var(--success);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.3s ease;
      pointer-events: auto;
      max-width: 400px;
      min-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.error {
      border-left-color: var(--danger);
    }

    .notification.warning {
      border-left-color: var(--warning);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      /* Changed from default flex to avoid overlaying before needed */
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
      overflow: hidden;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: var(--bg-main);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border);
      transform: rotate(90deg);
    }

    /* Futuristic Save Modal Improvements - Light Theme with Black Header */
    #saveModal .modal-content {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 28px;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      max-height: 96vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      /* Header will be fixed at top */
      padding: 0 !important;
      /* Move padding to body/header */
    }

    #saveModal .modal-header {
      background: #000000;
      color: #ffffff;
      padding: 1.5rem 2rem;
      border-radius: 0;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: none;
    }

    #saveModal .modal-body {
      overflow-y: auto;
      padding: 2rem;
      flex-grow: 1;
      min-height: 500px;
      display: flex;
      flex-direction: column;
    }

    #saveModal .save-step {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #saveModal .step-footer {
      margin-top: auto;
      padding-top: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #saveModal .modal-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      color: #ffffff;
      text-transform: uppercase;
      margin: 0;
    }

    #saveModal .modal-close {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    #saveModal .modal-close:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #dc2626;
    }

    #saveModal .step-indicator {
      font-family: 'Syne', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 0.75rem;
      padding: 0.8rem 0;
      border-bottom: 2px solid #eee;
    }

    #saveModal .form-input,
    #saveModal .form-select,
    #saveModal .form-textarea {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      color: var(--text-primary);
    }

    #saveModal .form-input:focus {
      background: #ffffff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    #saveModal .avatar {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    #saveModal .modal-title span {
      background: linear-gradient(90deg, #60a5fa 0%, #38bdf8 50%, #67e8f9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #saveModal .search-results {
      background: #ffffff !important;
      border: 1px solid #e2e8f0 !important;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    }

    #saveModal .search-item:hover {
      background: #f1f5f9 !important;
    }

    #saveModal .search-item {
      border-bottom: 1px solid #f1f5f9 !important;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      transition: all 0.3s ease;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
    }

    .billing-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }

    .billing-tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      margin-bottom: -2px;
    }

    .billing-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .billing-tab:hover:not(.active) {
      color: var(--text-primary);
    }

    .customer-selector {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .customer-selector select {
      flex: 1;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--border);
    }

    .modal-actions .btn {
      flex: 1;
    }

    .flight-grid {
      display: grid;
      gap: 2rem;
    }

    .flight-unit {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr;
    }

    .flight-unit.row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .flight-unit.row .flight-block {
      flex: 1;
      min-width: 300px;
      margin-bottom: 0;
    }

    .flight-unit.row .shared-fare-section {
      flex-basis: 100%;
    }

    .flight-unit.multi {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-content: flex-start;
    }

    .flight-unit.multi .flight-block {
      flex: 1;
      min-width: 280px;
      margin-bottom: 0;
    }

    .flight-unit.multi .shared-fare-section {
      flex-basis: 100%;
    }

    .flight-unit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
      margin-bottom: 0.5rem;
      width: 100%;
    }

    .flight-unit-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary);
    }

    .flight-unit-header button {
      padding: 0.5rem 1rem;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .flight-unit-header button:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    .shared-fare-section {
      border: 1.5px solid var(--border);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      /* Significant space between Fare Options and next button */
      width: 100%;
      background: var(--bg-card);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .fare-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.85rem 1.25rem;
      background: rgba(37, 99, 235, 0.03);
      cursor: pointer;
      user-select: none;
    }

    .fare-section-header:hover {
      background: rgba(37, 99, 235, 0.08);
    }

    .fare-section-header h4 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0 !important;
    }

    .fare-toggle-icon {
      font-size: 0.8rem;
      color: var(--primary);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: block;
      /* Visible on all devices to show interactivity */
    }

    .fare-section-content {
      padding: 1.25rem;
      border-top: 1.5px solid var(--border);
      display: none;
      /* CLOSED by default on ALL devices */
    }

    .shared-fare-section.expanded .fare-section-content {
      display: block !important;
    }

    .shared-fare-section:not(.expanded) .fare-toggle-icon {
      transform: rotate(0deg);
      /* Down arrow â–¼ */
    }

    .shared-fare-section.expanded .fare-toggle-icon {
      transform: rotate(180deg);
      /* Up arrow â–² */
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 1rem;
        margin: 1rem auto;
      }

      .section {
        padding: 1.5rem;
      }

      .fare-types {
        flex-direction: column;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .markup-section {
        flex-direction: column;
        align-items: stretch;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .header-actions {
        width: 100%;
        justify-content: center;
      }

    }

    /* --- New Flight Card Design (Skyscanner Style) --- */
    /* Sidebar Styles */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -320px;
      /* Adjusted from -390px */
      width: 260px;
      /* Reduced from 320px */
      height: 100vh;
      background: var(--bg-card);
      box-shadow: -4px 0 25px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    [data-theme="dark"] .sidebar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar.active {
      right: 0;
    }

    .sidebar-header {
      padding: 2rem 1.25rem 1.5rem;
      /* Reduced padding */
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-profile-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      /* Reduced gap */
      margin-bottom: 1.25rem;
    }

    .user-avatar {
      width: 40px;
      /* Reduced from 48px */
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      /* Reduced from 1.5rem */
      font-weight: 700;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .user-info {
      flex: 1;
      overflow: hidden;
    }

    .user-name {
      font-weight: 700;
      font-size: 0.95rem;
      /* Reduced from 1.1rem */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-email {
      font-size: 0.75rem;
      /* Reduced from 0.85rem */
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .auth-btn-container {
      margin-top: 1rem;
    }

    .sidebar-auth-btn {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .sidebar-auth-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .sidebar-auth-btn.logout {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      color: #fca5a5;
    }

    .sidebar-auth-btn.logout:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Sidebar Close Button */
    .sidebar-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: rgba(255, 255, 255, 0.8);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .sidebar-body {
      padding: 1rem;
      /* Reduced from 1.5rem */
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      /* Reduced from 0.75rem */
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      /* Reduced from 1rem */
      padding: 0.75rem 1rem;
      /* Reduced from 1rem 1.25rem */
      border-radius: 8px;
      /* Reduced from 12px */
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875rem;
      /* Reduced */
      transition: all 0.3s ease;
      background: var(--bg-main);
      border: 1px solid var(--border);
    }

    .sidebar-link:hover {
      background: var(--primary);
      color: white;
      transform: translateX(3px);
      /* Reduced from 5px */
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .sidebar-link.active {
      background: var(--primary);
      color: white;
    }

    .sidebar-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--bg-main);
    }

    /* Menu Toggle Button */
    .menu-toggle {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 100;
    }

    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
    }

    .menu-bar {
      width: 22px;
      height: 2px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* Update Header Actions */
    .header-actions {
      display: none !important;
      /* Move all buttons to sidebar */
    }

    .app-header .header-content {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-direction: row;
    }

    .app-header .header-left {
      text-align: left;
      flex: 1;
      margin-left: 1rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      justify-content: flex-start !important;
    }

    @media (max-width: 600px) {
      .sidebar {
        width: 100%;
        right: -100%;
      }

      .sidebar-close {
        top: 1rem !important;
        right: 1rem !important;
        width: 44px !important;
        height: 44px !important;
        font-size: 1.5rem !important;
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        z-index: 2100;
        display: flex !important;
      }

      .menu-toggle {
        position: absolute;
        left: 0.2rem;
        top: 0.2rem;
        /* More top left */
        transform: none;
        /* Remove vertical centering */
        z-index: 100;
      }

      .app-header .header-content {
        justify-content: center !important;
        position: relative;
        padding-left: 0 !important;
        /* Reset, handled by header-left margin/padding if needed or just let absolute position work */
        padding-right: 0 !important;
        min-height: 80px;
        /* Ensure height for button */
      }

      .app-header .header-left {
        text-align: center !important;
        width: 100%;
        padding: 0 3.5rem;
        /* Prevent text overlapping with the button */
      }
    }

    /* Summary Header */
    .flight-summary {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
    }

    .summary-main {
      display: flex;
      align-items: center;
      gap: 2rem;
      flex: 1;
    }

    .summary-airline {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-width: 120px;
    }

    .airline-name {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .flight-code {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    .flight-route-visual {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      max-width: 400px;
    }

    .time-group {
      text-align: center;
    }

    .time-big {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .city-code {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
      margin-top: 0.25rem;
    }

    .duration-line-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 80px;
    }

    /* Combined Card Styles */
    .combined-flight-card {
      width: 100% !important;
      max-width: 100% !important;
    }

    .flight-divider {
      height: 1px;
      background: var(--border);
      margin: 0.5rem 1.5rem;
      opacity: 0.6;
    }

    .combined-label {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom-right-radius: 8px;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    .option-label {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--bg-main);
      color: var(--text-secondary);
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-bottom-left-radius: 12px;
      border-left: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .duration-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .route-line {
      width: 100%;
      height: 2px;
      background: #cbd5e1;
      position: relative;
      border-radius: 2px;
    }

    /* Start Circle */
    .route-line::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      width: 6px;
      height: 6px;
      background: #fff;
      border: 2px solid #cbd5e1;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }

    /* End Plane */
    .route-line::after {
      content: 'âœˆ';
      position: absolute;
      top: 50%;
      right: 0;
      transform: translate(50%, -50%) rotate(90deg);
      font-size: 0.85rem;
      color: var(--primary);
      background: var(--bg-card);
      padding: 0 4px;
      line-height: 1;
      z-index: 1;
    }

    .stops-text {
      font-size: 0.75rem;
      margin-top: 0.35rem;
      color: var(--danger);
      /* Red for stops usually */
    }

    .stops-text.direct {
      color: var(--success);
    }

    /* Timeline Styles */
    .flight-timeline {
      padding: 1.5rem 2rem;
      background: var(--bg-main);
      position: relative;
    }

    .timeline-segment {
      position: relative;
      padding-left: 25px;
      margin-left: 10px;
      border-left: 2px solid var(--border);
      padding-bottom: 2rem;
    }

    .timeline-segment:last-child {
      /* Keep the border to connect to arrival dot, but we'll use a trick to make it stop */
      border-left-color: var(--border);
      padding-bottom: 1rem;
    }

    .t-dot {
      position: absolute;
      left: -7px;
      /* Center on 2px border: -1px (border center) - 6px (half dot) = -7px */
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--text-secondary);
      z-index: 2;
      box-shadow: 0 0 0 4px var(--bg-main);
      /* White/Bg halo to separate from line if needed */
    }

    .t-dot.departure {
      top: 6px;
      border-color: var(--text-primary);
    }

    .t-dot.arrival {
      bottom: 6px;
      top: auto;
      border-color: var(--text-primary);
      background: var(--bg-card);
      /* White/Hollow inside */
    }

    .t-time-row {
      display: flex;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 0.25rem;
      line-height: 1;
      padding-left: 1rem;
      /* Gap between line and text */
    }

    .t-time {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
      width: 60px;
      flex-shrink: 0;
    }

    .t-city {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .t-airport {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-left: 0.5rem;
      font-weight: 400;
    }

    .airport-code-small {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-left: 4px;
      font-weight: 400;
    }

    .t-detail-row {
      margin-left: 76px;
      /* time width + gap */
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Layover Block */
    .layover-container {
      position: relative;
      margin: 0.5rem 0 1.5rem 0;
      padding-left: 20px;
      margin-left: -2px;
      /* Pull back to overlap segment border */
      width: calc(100% + 2px);
    }

    .layover-icon-box {
      position: absolute;
      left: 1px;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background: transparent;
      border: none;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }


    .layover-icon-box img {
      width: 35px;
      height: 35px;
      opacity: 0.7;
    }

    .layover-pill {
      background: #fff1f2;
      color: #be123c;
      padding: 0.5rem 1rem;
      border-radius: 100px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: 1.5rem;
      /* Indent */
      position: relative;
      z-index: 2;
    }

    [data-theme="dark"] .layover-pill {
      background: #4c0519;
      color: #fda4af;
    }

    .flight-info-block {
      margin-left: 80px;
      /* Aligned with text */
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      margin-top: 0.5rem;
    }

    .info-row {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .info-icon {
      width: 16px;
      text-align: center;
    }

    /* Fares Footer */
    .card-footer-fares {
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .footer-fare-item {
      display: flex;
      flex-direction: column;
      padding: 0.5rem 1rem;
      background: var(--bg-main);
      border-radius: 8px;
      min-width: 100px;
    }

    /* Combined Card Specifics */
    .combined-flight-card {
      border: 2px solid var(--primary-light, rgba(79, 70, 229, 0.1));
    }

    .combined-label {
      background: var(--primary);
      color: white;
      padding: 0.25rem 1rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
      border-radius: 0;
      margin-bottom: 0;
    }

    .flight-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--border), transparent);
      margin: 0;
      width: 100%;
    }

    .footer-fare-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .footer-fare-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* Date Warning */
    .date-warning-strip {
      background: #fff7ed;
      color: #c2410c;
      padding: 0.5rem 1.5rem;
      font-size: 0.85rem;
      font-weight: 500;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid #fed7aa;
    }

    /* Distinct styles for split fares in round trips */
    .fare-footer-outbound {
      background-color: rgba(14, 79, 218, 0.12) !important;
      /* very light blue */
      border-top: 2px solid rgba(14, 79, 218, 0.6) !important;
      backdrop-filter: blur(6px);
    }

    .fare-footer-return {
      background-color: rgba(5, 171, 216, 0.12) !important;
      /* very light cyan */
      border-top: 2px solid rgba(5, 171, 216, 0.6) !important;
      backdrop-filter: blur(6px);
    }


    .date-btn {
      background: #c2410c;
      color: white;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }

    /* Stacked Airline Display */
    .airline-stack {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .airline-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      line-height: 1.2;
    }

    .airline-name-small {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .flight-code-small {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Expand/Collapse Styles */
    .flight-summary {
      cursor: pointer;
      padding-right: 2rem;
      /* Make space for arrow */
      position: relative;
    }

    .expand-icon {
      width: 10px;
      height: 10px;
      border-right: 2px solid #444;
      border-bottom: 2px solid #444;
      transform: rotate(45deg);
      transition: transform 0.25s ease;
      cursor: pointer;
    }

    /* when expanded */
    .expand-icon.rotated {
      transform: rotate(-135deg);
    }


    /* Compact Card Styles for Grid Layout */
    .flight-card {
      padding: 0 !important;
      /* Ensure border-box or similar doesn't add unexpected size */
    }

    /* Summary Header Optimized */
    .flight-summary {
      padding: 1rem 1.25rem;
      /* Reduced padding */
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      min-height: 80px;
      /* Consistent height */
    }

    .summary-main {
      display: flex;
      align-items: center;
      gap: 1rem;
      /* Reduced gap */
      flex: 1;
      width: 100%;
      /* Ensure full width usage */
    }

    .summary-airline {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 100px;
      /* slightly smaller min-width */
      flex-shrink: 0;
    }

    .airline-name {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.9rem;
      /* Smaller font */
    }

    .flight-code {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    .flight-route-visual {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* Evenly spread */
      gap: 0.5rem;
      max-width: 100%;
      /* Allow full expansion */
      padding: 0 0.5rem;
    }

    .time-group {
      text-align: center;
      min-width: 50px;
    }

    .time-big {
      font-size: 1.1rem;
      /* Smaller time font */
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .city-code {
      font-size: 0.75rem;
      /* Slightly smaller to fit "City (Code)" */
      color: var(--text-secondary);
      font-weight: 600;
      /* Bolder */
      margin-top: 0.25rem;
      line-height: 1.2;
      max-width: 80px;
      /* Constrain width but allow wrap */
      overflow-wrap: break-word;
    }

    .duration-line-container {
      flex: 1;
      /* Take available space */
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 60px;
      /* Reduced min width */
      margin: 0 0.5rem;
    }

    .duration-text {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-bottom: 0.2rem;
    }

    /* Fares Footer Compact */
    .card-footer-fares {
      padding: 0.75rem 1.25rem;
      gap: 0.75rem;
    }

    .footer-fare-item {
      padding: 0.4rem 0.75rem;
      min-width: 80px;
    }

    .footer-fare-price {
      font-size: 1rem;
    }

    /* Timeline hidden by default if using inline style, or we can use a class */
    /* Timeline hidden by default if using inline style, or we can use a class */
    .flight-timeline-container {
      border-top: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .option-label {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--primary);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-bottom-right-radius: 8px;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Capture Optimization - Clean Raw Cards */
    .capturing .flight-card {
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      transform: none !important;
      border: 1px solid #ccc !important;
      /* Simple border for definition */
    }

    .capturing {
      background: transparent !important;
    }

    /* Animated Header Styles */
    .animated-title {
      font-family: 'Outfit', sans-serif;
      font-size: 2.8rem;
      font-weight: 800;
      /* Premium gradient: White -> Gold -> Cyan -> White */
      background: linear-gradient(135deg, #ffffff 0%, #fbbf24 25%, #22d3ee 50%, #fbbf24 75%, #ffffff 100%);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      animation: shine 4s linear infinite;
      margin-bottom: 0.2rem;
      letter-spacing: -0.03em;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      text-transform: uppercase;
      white-space: nowrap;
    }

    @keyframes shine {
      0% {
        background-position: 0% center;
      }

      100% {
        background-position: 200% center;
      }
    }

    .header-subtitle {
      font-family: 'Outfit', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
      opacity: 0;
      animation: fadeIn 0.8s ease-out forwards 0.3s;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .header-left p {
      color: rgba(255, 255, 255, 0.9);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- Final Mobile Responsiveness & Overflow Fixes --- */
    @media (max-width: 600px) {
      body {
        zoom: 0.8;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }

      .container {
        padding: 0 0.5rem !important;
        margin: 1rem auto !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box;
      }

      .section {
        padding: 1rem !important;
        border-radius: 12px !important;
        margin-bottom: 1rem !important;
      }

      /* Main Header: Balanced Spacing */
      .app-header {
        padding: 1rem 0.5rem !important;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
        overflow: hidden;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box;
      }

      [data-theme="dark"] .app-header {
        background: linear-gradient(135deg, #064e3b 0%, #022c22 100%) !important;
      }

      .header-content {
        gap: 0.5rem !important;
        padding: 0 !important;
      }

      .animated-title {
        font-size: min(1.3rem, 6vw) !important;
        /* Slightly smaller to guarantee single line */
        letter-spacing: -0.02em !important;
        white-space: nowrap;
        margin-bottom: 0;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .header-subtitle {
        font-size: 0.7rem !important;
        opacity: 0.8;
        letter-spacing: 0.05em !important;
        line-height: 1.2 !important;
        margin-top: 2px;
      }

      .header-actions {
        margin-top: 0.5rem;
        gap: 0.5rem !important;
      }

      .header-btn {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
        border-radius: 8px !important;
      }

      /* Flight Summary: Clean & Structured */
      .flight-summary {
        padding: 1.25rem 1rem 1rem 1rem !important;
        /* Extra top padding for label */
        position: relative !important;
      }

      .summary-main {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }

      /* Option Label: Positioned safely */
      .option-label {
        font-size: 0.65rem !important;
        padding: 0.15rem 0.5rem !important;
        border-bottom-left-radius: 8px !important;
        border-bottom-right-radius: 0 !important;
        right: 0 !important;
        top: 0 !important;
      }

      /* Top Row: Airline & Date */
      .summary-airline {
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        padding-bottom: 0.5rem !important;
        border-bottom: 1px solid var(--border);
      }

      .airline-stack {
        gap: 0.4rem !important;
      }

      .summary-date {
        font-size: 0.75rem !important;
        font-weight: 700 !important;
        color: var(--primary) !important;
        margin: 0 !important;
        background: rgba(37, 99, 235, 0.05);
        padding: 2px 6px !important;
        border-radius: 4px;
      }

      /* Middle Row: Route Visualizer */
      .flight-route-visual {
        width: 100% !important;
        max-width: none !important;
        justify-content: space-between !important;
        gap: 0.25rem !important;
        padding: 0.5rem 0 !important;
      }

      .time-group {
        text-align: left !important;
        min-width: 70px;
      }

      .time-group:last-of-type {
        text-align: right !important;
      }

      .time-big {
        font-size: 1.15rem !important;
        display: block;
      }

      .city-code {
        font-size: 0.75rem !important;
        color: var(--text-secondary);
        font-weight: 600 !important;
        display: block;
        margin-top: 2px !important;
      }

      .duration-line-container {
        flex: 1 !important;
        padding: 0 4px;
        justify-content: center;
      }

      .duration-text {
        font-size: 0.65rem !important;
        margin-bottom: 2px !important;
      }

      .stops-text {
        font-size: 0.65rem !important;
        margin-top: 2px !important;
      }

      /* Expand Arrow */
      .expand-icon {
        top: 55% !important;
        transform: translateY(-50%) rotate(45deg);
        right: 0.75rem !important;
        border-color: var(--border) !important;
      }

      .expand-icon.rotated {
        transform: translateY(-50%) rotate(-135deg);
      }

      /* Card Content & Timeline */
      .flight-timeline {
        padding: 1rem !important;
      }

      .timeline-segment {
        margin-left: 10px !important;
        padding-left: 25px !important;
        padding-bottom: 1.5rem !important;
      }

      .t-time-row {
        gap: 0.5rem !important;
      }

      .t-time {
        width: 45px !important;
        font-size: 0.9rem !important;
      }

      .t-city {
        font-size: 0.9rem !important;
      }

      .t-airport {
        font-size: 0.75rem !important;
        display: block;
        margin: 0 !important;
      }

      .t-detail-row {
        margin-left: 55px !important;
        font-size: 0.8rem !important;
      }

      .flight-info-block {
        margin-left: 55px !important;
        width: calc(100% - 60px);
        padding: 0.6rem !important;
      }

      /* Mobile Fare Section Optimization */
      .fare-section-header {
        padding: 0.75rem 1rem !important;
      }

      .fare-toggle-icon {
        display: block !important;
      }

      .fare-section-content {
        display: none !important;
      }

      .shared-fare-section.expanded .fare-section-content {
        display: block !important;
      }

      .shared-fare-section.expanded .fare-toggle-icon {
        transform: rotate(180deg) !important;
      }

      /* Markup Configuration Side by Side */
      .markup-section {
        flex-direction: row !important;
        gap: 0.5rem !important;
        align-items: flex-end !important;
      }

      #globalMarkupSection,
      .markup-section .input-group {
        flex: 1 !important;
        min-width: 0 !important;
        /* Prevent blowout */
      }

      .markup-input {
        padding: 0.6rem 0.5rem !important;
        font-size: 0.85rem !important;
        height: 40px !important;
      }

      .input-label {
        font-size: 0.75rem !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #gstDisplay {
        font-size: 0.65rem !important;
        margin-left: -0.5rem !important;
      }

      /* Fares Footer grid restorations */
      .card-footer-fares {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 0.4rem !important;
        padding: 0.8rem !important;
      }

      .footer-fare-item {
        padding: 0.4rem !important;
      }

      .modal-content {
        width: 92% !important;
        padding: 1.25rem !important;
        margin: 1rem auto !important;
      }

      /* Very Small Screen Adjustments */
      @media (max-width: 360px) {
        .animated-title {
          font-size: 1.5rem !important;
        }

        .time-big {
          font-size: 1rem !important;
        }

        .city-code {
          font-size: 0.7rem !important;
        }

        .footer-fare-price {
          font-size: 0.85rem !important;
        }

        .markup-section {
          gap: 0.5rem !important;
        }
      }

      /* Modal Fixes for Sidebar */
      .modal {
        z-index: 2200 !important;
        /* Higher than sidebar (2001) */
      }
    }

    /* --- New Action Button Styles --- */
    .actions-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .action-row {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .btn-sm {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      border-radius: 8px;
      flex: 1;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .btn-sm:active {
      transform: scale(0.96);
    }

    .btn-copy {
      background: #3b82f6;
      color: white;
      border: none;
    }

    .btn-copy:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .badge-coming-soon {
      display: inline-block;
      font-size: 0.65rem;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.3);
      margin-left: auto;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .btn-whatsapp {
      background: #2da85a;
      color: white;
      border: none;
    }

    .btn-whatsapp:hover {
      background: #20BD5A;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .btn-gmail {
      background: #EA4335;
      color: white;
      border: none;
    }

    .btn-gmail:hover {
      background: #D93025;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
    }

    .save-row {
      display: flex;
      justify-content: center;
    }

    .btn-save {
      width: 100%;
      padding: 0.85rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(37, 99, 235, 0.3);
    }

    /* Menu Toggle Button Styling */
    .menu-toggle {
      background: rgba(255, 255, 255, 0.15);
      border: 1.5px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 40px;
      height: 40px;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      z-index: 1001;
      margin-right: 1rem;
    }

    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }

    .menu-bar {
      display: block;
      width: 22px;
      height: 2px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* Sidebar Height and Header Color Fixes */
    .sidebar {
      position: fixed !important;
      top: 0 !important;
      bottom: 0 !important;
      right: 0 !important;
      width: 300px !important;
      height: 100% !important;
      height: 100dvh !important;
      display: flex;
      flex-direction: column;
      background: #ffffff !important;
      /* Solid background to prevent filter bleed */
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.2) !important;
      z-index: 2001 !important;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;
      /* Premium snap-to transition */
      transform: translateX(101%);
      will-change: transform;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      image-rendering: -webkit-optimize-contrast;
      /* Sharpen text */
      backface-visibility: hidden;
      perspective: 1000px;
    }

    .sidebar.active {
      transform: translateX(0) !important;
    }

    [data-theme="dark"] .sidebar {
      background: #111827 !important;
      /* Solid Darker Blue */
    }

    /* Prevent overlay blur from affecting sidebar clarity */
    .sidebar-overlay {
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      background: rgba(0, 0, 0, 0.6) !important;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%) !important;
      padding: 2.5rem 1.5rem !important;
      color: white !important;
      border-bottom: none !important;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    .sidebar-header .user-name {
      color: white !important;
      font-size: 1.1rem !important;
      font-weight: 700 !important;
    }

    .sidebar-header .user-email {
      color: rgba(255, 255, 255, 0.8) !important;
    }

    .sidebar-header .user-avatar {
      background: rgba(255, 255, 255, 0.2) !important;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white !important;
    }

    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 1rem !important;
    }

    .sidebar-nav .sidebar-link {
      padding: 0.8rem 1rem !important;
      margin-bottom: 0.25rem !important;
      border-radius: 8px !important;
      transition: all 0.2s ease !important;
    }

    .sidebar-nav .sidebar-link:hover {
      background: var(--bg-main) !important;
      transform: translateX(5px);
    }

    .sidebar-nav .sidebar-link.active {
      background: rgba(37, 99, 235, 0.1) !important;
      color: var(--primary) !important;
      font-weight: 600;
    }

    [data-theme="dark"] .sidebar {
      background: #1e293b !important;
    }

    [data-theme="dark"] .sidebar-nav .sidebar-link:hover {
      background: #334155 !important;
    }

    .sidebar-close {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      z-index: 1002 !important;
    }

    .sidebar-close:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      transform: rotate(90deg);
    }

    /* Fixed for zoom causing layout issues on some browsers */
    @media (max-width: 600px) {
      body {
        zoom: 0.8;
        -webkit-text-size-adjust: 100%;
        /* Prevent font scaling issues */
      }

      .sidebar,
      .sidebar-overlay,
      .modal-overlay {
        height: 125vh !important;
        height: 125dvh !important;
        top: 0 !important;
        /* Compensate for 0.8 zoom (1/0.8 = 1.25) */
      }
    }
  </style>
  <style>
    /* ================= MODAL OVERLAY ================= */
    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      /* Changed to avoid overflow when hidden */
      align-items: center;
      justify-content: center;

      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);

      opacity: 0;
      visibility: hidden;
      pointer-events: none;

      /* ðŸ”¥ Faster fade */
      transition: opacity 0.2s ease, visibility 0.2s ease;
      z-index: 9999;
    }

    .modal-overlay.is-active,
    .modal-overlay.active {
      display: flex;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* ================= MODAL CONTENT ================= */
    .modal-content {
      background: #ffffff;
      border-radius: 14px;

      /* ðŸ”¥ INCREASED WIDTH */
      width: 96%;
      max-width: 1100px;

      /* ðŸ”¥ INCREASED HEIGHT USABILITY */
      max-height: 90vh;

      /* Comfortable spacing */
      padding: 32px;

      /* Subtle depth */
      box-shadow: 0 25px 55px rgba(0, 0, 0, 0.28);

      /* ðŸ”¥ Faster, stronger entrance animation */
      transform: translateY(-14px) scale(0.97);
      transition: transform 0.2s ease-out;
    }

    .modal-overlay.is-active .modal-content,
    .modal-overlay.active .modal-content {
      transform: translateY(0) scale(1);
    }

    /* ================= MODAL HEADER ================= */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;

      padding-bottom: 16px;
      margin-bottom: 22px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 1.45rem;
      font-weight: 700;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.6rem;
      cursor: pointer;
      color: #888;
      transition: color 0.15s ease, transform 0.15s ease;
    }

    .modal-close:hover {
      color: #222;
      transform: scale(1.12);
    }

    /* ================= MODAL BODY ================= */
    .modal-body {
      /* ðŸ”¥ MORE VERTICAL SPACE */
      max-height: 72vh;
      overflow-y: auto;
      padding-right: 6px;
    }

    /* ================= FORM LAYOUT ================= */
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
    }

    /* Stack inputs on tablets & mobile */
    @media (max-width: 900px) {
      .modal-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ================= MODAL ACTIONS ================= */
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      margin-top: 28px;
      padding-top: 18px;
      border-top: 1px solid #eee;
    }

    /* Stack buttons on small screens */
    @media (max-width: 480px) {
      .modal-actions {
        flex-direction: column-reverse;
      }

      .modal-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="theme-curtain" id="themeCurtain">
    <div class="theme-curtain-icon" id="curtainIcon">âœˆï¸</div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" id="sidebarClose">âœ•</button>
    <div class="sidebar-header">
      <div class="user-profile-section">
        <div class="user-avatar" id="sidebarAvatar">ðŸ‘¤</div>
        <div class="user-info">
          <div class="user-name" id="sidebarUserName">Guest User</div>
          <div class="user-email" id="sidebarUserEmail">Welcome!</div>
        </div>
      </div>
      <div class="auth-btn-container">
        <button class="sidebar-auth-btn" id="sidebarAuthBtn" onclick="handleAuthClick()">
          ðŸ” Login / Register
        </button>
      </div>
    </div>
    <div class="sidebar-body">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link active">ðŸ  Home</a>
        <a href="/passengers" class="sidebar-link">ðŸ‘¤ Passengers</a>
        <a href="/corporates" class="sidebar-link">ðŸ¢ Corporates</a>
        <a href="/itineraries" class="sidebar-link">ðŸ“‹ Itineraries</a>
        <a href="/billing" class="sidebar-link">ðŸ’° Billing</a>
        <div style="margin-top: 1.5rem; padding: 0 0.5rem;">
          <label class="input-label"
            style="display: block; margin-bottom: 0.75rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);">Appearance</label>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer;" id="sidebarThemeToggle">
            <span class="theme-icon-container">ðŸŒ™</span>
            <span id="themeToggleText">Dark Mode</span>
          </button>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer; margin-top: 0.5rem;"
            id="valentineToggle">
            <span class="theme-icon-container">ðŸŽ€</span>
            <span id="sidebarValToggleText">Pookie Mode</span>
          </button>

        </div>
      </nav>
    </div>
    <!-- Footer Removed -->
  </div>

  <div class="app-header">
    <div class="header-content">
      <button class="menu-toggle" id="menuToggle" aria-label="Open Menu">
        <span class="menu-bar"></span>
        <span class="menu-bar"></span>
        <span class="menu-bar"></span>
      </button>

      <div class="header-brand">
        <div class="brand-name">Time <span>Travels</span> Query</div>
        <div class="brand-sub">Travel with ease</div>
      </div>

      <div class="header-actions" style="display: flex !important;">
        <!-- Actions can go here if needed -->
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Flight Inputs Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">âœˆï¸</div>
        <h2>Flight Details</h2>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label class="input-label">Trip Type</label>

        <div style="display:flex; gap:1.5rem; margin-top:0.5rem;">
          <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
            <input type="radio" name="tripType" value="one_way" checked onchange="handleTripType()">
            <span>One Way</span>
          </label>

          <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
            <input type="radio" name="tripType" value="round_trip" onchange="handleTripType()">
            <span>Round Trip</span>
          </label>

          <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
            <input type="radio" name="tripType" value="multi_city" onchange="handleTripType()">
            <span>Multi City</span>
          </label>
        </div>
      </div>



      <div id="flightInputs" class="flight-grid"></div>
      <button id="addUnitBtn" class="add-flight-btn" onclick="addUnit()" style="display: none;">
        <span>âž•</span>
        <span id="addUnitLabel">Add Another Flight</span>
      </button>
    </div>

    <!-- Markup Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">ðŸ’°</div>
        <h2>Markup Configuration</h2>
      </div>
      <div class="markup-section" style="display: flex; gap: 2rem; align-items: flex-end;">
        <div class="input-group" id="globalMarkupSection">
          <label class="input-label">Global Markup (â‚¹)</label>
          <input type="number" id="markup" class="markup-input" placeholder="Enter markup amount (e.g., 500)" min="0">
        </div>
        <div class="input-group">
          <label class="input-label">Service Charge (Optional)</label>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <input type="number" id="serviceCharge" class="markup-input" placeholder="Enter service charge" min="0"
              oninput="updateGSTDisplay()">
            <span id="gstDisplay" style="font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Parse Button -->
    <div class="section parse-section">
      <button class="btn btn-primary" id="parseBtn" onclick="parseFlights()">
        <span id="parseIcon">ðŸš€</span>
        <span id="parseBtnText">Parse Flights & Generate Itinerary</span>
      </button>
    </div>

    <!-- Flight Cards Section -->
    <div class="section" id="cardsSection" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <div class="section-icon">ðŸŽ«</div>
          <h2>Flight Cards</h2>
        </div>
        <div id="globalEditControls" style="display: none;">
          <button class="btn btn-secondary" id="globalEditBtn" onclick="toggleGlobalEditMode()"
            style="padding: 0.5rem 1rem; font-size: 0.9rem;">
            âœï¸ Edit Fares
          </button>
        </div>
      </div>
      <div id="cards" class="cards-grid" style="gap: 1rem;"></div>
      <div class="actions">
        <button class="btn btn-secondary" onclick="downloadCardsImage()">
          ðŸ“¤ Download Cards Image
        </button>
      </div>
    </div>

    <!-- Output Section -->
    <div class="section" id="outputSection" style="display: none;">
      <div class="section-header">
        <div class="section-icon">ðŸ“‹</div>
        <h2>Final Itinerary Text</h2>
      </div>
      <div id="output" class="output-section">No output yet.</div>
      <div class="actions-group">
        <div class="action-row">
          <button class="btn btn-copy btn-sm" onclick="copyOutput()">
            ðŸ“‹ Copy
          </button>
          <button class="btn btn-whatsapp btn-sm" onclick="shareCombined('whatsapp')">
            ðŸ“± WhatsApp
          </button>
          <button class="btn btn-gmail btn-sm" onclick="shareCombined('email')">
            ðŸ“§ Gmail
          </button>
        </div>
        <div class="save-row">
          <button class="btn btn-save" onclick="openSaveModal()">
            ðŸ’¾ Save Itinerary to Database
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Itinerary Modal -->
  <!-- Save Itinerary Modal V2 (Wizard) -->
  <div id="saveModal" class="modal-overlay">
    <div class="modal-content modal-large" style="max-width: 850px; min-height: 650px;">
      <div class="modal-header">
        <h3 class="modal-title">ðŸ’¾ SAVE <span>ITINERARY</span></h3>
        <button class="modal-close" onclick="closeSaveModal()">âœ•</button>
      </div>

      <div class="modal-body">

        <!-- Steps Indicator -->
        <div class="save-steps"
          style="display:flex; justify-content:space-between; margin-bottom:25px; position:relative;">
          <span id="stepIndicator1" class="step-indicator active" onclick="goToStep(1)"
            style="font-weight:bold; cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; border-bottom: 2px solid #3b82f6; color: #3b82f6;">1.
            Billing</span>
          <span id="stepIndicator2" class="step-indicator" onclick="goToStep(2)"
            style="cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; color: #94a3b8;">2.
            Supplier</span>
          <span id="stepIndicator3" class="step-indicator" onclick="goToStep(3)"
            style="cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; color: #94a3b8;">3.
            Passengers</span>
          <span id="stepIndicator4" class="step-indicator" onclick="goToStep(4)"
            style="cursor: pointer; transition: all 0.3s; flex: 1; text-align: center; color: #94a3b8;">4.
            Reference</span>
        </div>

        <!-- Step 1: Billing -->
        <div id="saveStep1" class="save-step" style="min-height: 450px;">
          <div class="form-group" style="position:relative; margin-bottom: 2rem;">
            <label class="form-label">Search Billing Account</label>
            <div style="position:relative;">
              <div style="display:flex; gap:10px;">
                <input type="text" id="billingSearchInput" class="form-input"
                  placeholder="Search accounts, passengers or corporates..." oninput="searchBillingUnified()"
                  onclick="searchBillingUnified()" onfocus="searchBillingUnified()">
              </div>
              <div id="billingSearchResults" class="search-results"
                style="display:none; width:100%; top:100%; z-index:10000; position:absolute; background:var(--bg-card); border:1px solid var(--border); max-height:200px; overflow-y:auto; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              </div>
            </div>

            <input type="hidden" id="billingAccountSelect">
          </div>

          <!-- New Billing Form -->
          <div id="newBillingForm"
            style="display:none; background:var(--bg-card); padding:15px; margin-top:15px; border-radius:8px; border:1px solid var(--border-color);">
            <h4 style="margin-top:0;">New Billing Account</h4>
            <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
              <div>
                <label class="form-label">Type</label>
                <select id="newBillType" class="form-select" onchange="handleBillTypeChange()">
                  <option value="individual" selected>Individual</option>
                  <option value="corporate">Corporate</option>
                </select>
              </div>
              <div>
                <label class="form-label">Display Name *</label>
                <input id="newBillDisplay" class="form-input" placeholder="e.g. Acme Corp or John Doe">
              </div>
            </div>

            <div id="corporateFields" style="display:none;">
              <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div><label class="form-label">Company Name</label><input id="newBillCompany" class="form-input"></div>
                <div><label class="form-label">Contact Name</label><input id="newBillContact" class="form-input"></div>
              </div>

              <div style="margin-top:10px;">
                <label class="form-label">GST Number</label>
                <input id="newBillGst" class="form-input">
              </div>
            </div>

            <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
              <div><label class="form-label">Email</label><input id="newBillEmail" class="form-input"></div>
              <div><label class="form-label">Phone</label><input id="newBillPhone" class="form-input"></div>
            </div>

            <div style="margin-top:10px;">
              <label class="form-label">Address</label>
              <textarea id="newBillAddress" class="form-textarea" rows="2"></textarea>
            </div>

            <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="saveBillingToDb" checked>
              <label for="saveBillingToDb" style="cursor:pointer; font-weight:500;">Save this billing account for future
                use</label>
            </div>

            <div style="margin-top:15px; text-align:right;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="toggleNewBillingForm()">Cancel</button>
              <button type="button" class="btn btn-primary btn-sm" onclick="useNewBillingAccount()">Use This
                Account</button>
            </div>
          </div>

          <div id="billingSummary"
            style="margin-top:20px; padding:10px; border:1px solid var(--border-color); border-radius:8px; display:none; background:var(--bg-main);">
            <strong>Billing To:</strong> <span id="selectedBillingName"
              style="color:var(--primary-color); font-weight:600;"></span>
            <div id="selectedBillingDetails" style="font-size:0.9em; color:var(--text-secondary); margin-top:5px;">
            </div>
          </div>

          <div class="step-footer" style="margin-top:auto; padding-top:20px; display:flex; justify-content:flex-end;">
            <button class="btn btn-primary" onclick="goToStep(2)">Next: Supplier &rarr;</button>
          </div>
        </div>


        <!-- Step 2: Supplier -->
        <div id="saveStep2" class="save-step" style="display:none; min-height: 450px;">
          <div class="form-group" style="position:relative; margin-bottom: 2rem;">
            <label class="form-label">Search Supplier Account</label>
            <div style="position:relative;">
              <div style="display:flex; gap:10px;">
                <input type="text" id="supplierSearchInput" class="form-input" placeholder="Search supplier accounts..."
                  oninput="searchSupplierUnified()" onclick="searchSupplierUnified()" onfocus="searchSupplierUnified()">
              </div>
              <div id="supplierSearchResults" class="search-results"
                style="display:none; width:100%; top:100%; z-index:10000; position:absolute; background:var(--bg-card); border:1px solid var(--border); max-height:200px; overflow-y:auto; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              </div>
            </div>
            <input type="hidden" id="supplierAccountSelect">
          </div>

          <!-- New Supplier Form -->
          <div id="newSupplierForm"
            style="display:none; background:var(--bg-card); padding:15px; margin-top:15px; border-radius:8px; border:1px solid var(--border-color);">
            <h4 style="margin-top:0;">New Supplier Account</h4>
            <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
              <div>
                <label class="form-label">Type</label>
                <select id="newSupType" class="form-select" onchange="handleSupTypeChange()">
                  <option value="corporate" selected>Corporate</option>
                  <option value="individual">Individual</option>
                </select>
              </div>
              <div>
                <label class="form-label">Display Name *</label>
                <input id="newSupDisplay" class="form-input" placeholder="e.g. Cleartrip">
              </div>
            </div>

            <div id="corporateSupFields">
              <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div><label class="form-label">Company Name</label><input id="newSupCompany" class="form-input"></div>
                <div><label class="form-label">Contact Name</label><input id="newSupContact" class="form-input"></div>
              </div>
              <div style="margin-top:10px;">
                <label class="form-label">GST Number</label>
                <input id="newSupGst" class="form-input">
              </div>
            </div>

            <div class="grid-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
              <div><label class="form-label">Email</label><input type="email" id="newSupEmail" class="form-input"></div>
              <div><label class="form-label">Phone</label><input type="text" id="newSupPhone" class="form-input"></div>
            </div>
            <div style="margin-top:10px;">
              <label class="form-label">Address</label>
              <textarea id="newSupAddress" class="form-input" rows="2"></textarea>
            </div>
          </div>

          <!-- Selected Supplier Summary -->
          <div id="supplierSummary"
            style="display:none; margin-top:15px; padding:15px; background:var(--bg-card); border-radius:8px; border: 1px dashed var(--primary); align-items:flex-start; justify-content:space-between;">
            <div>
              <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">Selected Supplier</div>
              <div id="selectedSupplierName" style="font-size:1.1rem; font-weight:bold;"></div>
              <div id="selectedSupplierDetails" style="font-size:0.85rem; color:var(--text-secondary); margin-top:3px;">
              </div>
            </div>
            <button class="btn-action small" onclick="clearSupplierSelection()"
              style="padding:5px 10px; background:transparent; border:1px solid var(--text-secondary); color:var(--text-secondary);">Clear</button>
          </div>

          <div class="step-actions"
            style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between;">
            <button class="btn btn-secondary" onclick="goToStep(1)">&larr; Back</button>
            <button class="btn btn-primary" onclick="goToStep(3)">Next: Passengers &rarr;</button>
          </div>
        </div>


        <!-- Step 3: Passengers -->
        <div id="saveStep3" class="save-step" style="display:none; min-height: 450px;">
          <div class="form-group" style="position:relative; margin-bottom: 2rem;">
            <label class="form-label" style="display:none;">Search Passenger</label>
            <!-- Hidden label for accessibility/omission -->
            <div style="position:relative;">
              <div style="display:flex; gap:10px;">
                <input type="text" id="savePassengerSearch" class="form-input"
                  placeholder="Search passenger by name, email, phone..." autocomplete="off"
                  onkeyup="handleSavePassengerSearch()" onclick="handleSavePassengerSearch()"
                  onfocus="handleSavePassengerSearch()">
              </div>
              <div id="savePassengerResults" class="search-results custom-scroll"
                style="display:none; width:100%; top:100%; z-index:10000; position:absolute; background:var(--bg-card); border:1px solid var(--border); max-height:200px; overflow-y:auto; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
              </div>
            </div>
          </div>

          <!-- Quick add new passenger form -->
          <div id="quickAddPassengerForm"
            style="display:none; background:var(--bg-card); padding:15px; margin-top:15px; border-radius:8px; border:1px solid var(--border-color); margin-bottom: 15px;">
            <h4 style="margin-top:0; font-size:1rem; margin-bottom:10px;">New Passenger Details</h4>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 10px;">
              <div><label class="form-label">First Name *</label><input id="qaFirst" class="form-input input-sm"></div>
              <div><label class="form-label">Last Name *</label><input id="qaLast" class="form-input input-sm"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 10px;">
              <div><label class="form-label">Email</label><input id="qaEmail" class="form-input input-sm"></div>
              <div><label class="form-label">Phone</label><input id="qaPhone" class="form-input input-sm"></div>
            </div>

            <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="qaSaveToDB" checked>
              <label for="qaSaveToDB" style="cursor:pointer; font-weight:500; margin-bottom:0;">Save to Database</label>
            </div>

            <div style="margin-top:15px; text-align:right; display: flex; justify-content: flex-end; gap: 10px;">
              <button class="btn btn-secondary btn-sm" onclick="toggleQuickAddPassenger()">Cancel</button>
              <button class="btn btn-primary btn-sm" onclick="addQuickPassenger()">Add Passenger</button>
            </div>
          </div>

          <div id="savePassengerList" class="items-list custom-scroll"
            style="margin-top:15px; max-height:220px; overflow-y:auto; padding-right: 5px;">
            <!-- Filled by JS -->
            <div style="text-align: center; color: var(--text-secondary); padding: 20px; font-style: italic;">
              No passengers added yet. Search or create new.
            </div>
          </div>

          <div class="step-footer"
            style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between; align-items:center;">
            <button class="btn btn-secondary" onclick="goToStep(2)">&larr; Back</button>
            <div style="font-size: 0.85rem; color: #64748b; font-weight: 500;">
              <span id="passengerCountDisplay">0</span> Passengers Added
            </div>
            <button class="btn btn-primary" onclick="goToStep(4)">Next: Reference &rarr;</button>
          </div>
        </div>

        <!-- Step 4: Reference -->
        <div id="saveStep4" class="save-step" style="display:none;">
          <div class="form-group">
            <label class="form-label">Itinerary Title / Reference Name *</label>
            <input type="text" id="saveItineraryTitle" class="form-input" placeholder="e.g. Trip to Dubai for John Doe"
              style="font-size:1.1em; padding:10px;" required>
          </div>
          <div class="form-group" style="margin-top:10px;">
            <label class="form-label">Reference Number (optional)</label>
            <input type="text" id="saveReferenceNumber" class="form-input"
              placeholder="e.g. PNR, Booking Ref, Internal ID">
          </div>

          <div class="step-footer"
            style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between;">
            <button class="btn btn-secondary" onclick="goToStep(3)">&larr; Back</button>
            <button class="btn btn-success" id="finalSaveBtn" onclick="submitItinerary()">
              <span id="saveBtnText">ðŸ’¾ Save Itinerary</span>
              <span id="saveBtnLoading" style="display:none;">â³ Saving...</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content" style="text-align: center; max-width: 400px;">
      <h3 style="color: var(--danger); margin-bottom: 0.5rem; font-size: 1.5rem;">ðŸ—‘ï¸</h3>
      <h3 id="deleteModalTitle" style="color: var(--text-primary); margin-bottom: 1rem;">Confirm Deletion</h3>
      <p id="deleteModalMessage" style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.5;">
        Are you sure you want to delete this? This action cannot be undone.
      </p>
      <div class="modal-actions" style="justify-content: center; gap: 1rem;">
        <button class="btn btn-secondary" onclick="closeDeleteModal(false)"
          style="padding: 0.6rem 1.25rem;">Cancel</button>
        <button class="btn btn-danger" style="padding: 0.6rem 1.25rem;" onclick="closeDeleteModal(true)">Delete</button>
      </div>
    </div>
  </div>

  <!-- Warning Modal -->
  <div id="warningModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 480px; text-align: center;">
      <h3 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 2rem;">âš ï¸</h3>
      <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.25rem; font-weight: 700;">Markup Not
        Added</h3>
      <p id="warningMessage"
        style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5;">
        Are you sure you want to proceed without adding any markup?
      </p>
      <div class="modal-actions" style="justify-content: center; margin-top: 1.5rem;">
        <button class="btn btn-secondary" onclick="closeWarningModal(false)" style="min-width: 100px;">Go Back</button>
        <button class="btn btn-primary" onclick="closeWarningModal(true)"
          style="background-color: #f59e0b; border-color: #f59e0b; min-width: 100px;">Proceed</button>
      </div>
    </div>
  </div>

  <!-- Saved Itinerary Success Modal -->
  <!-- Saved Itinerary Success Modal -->
  <div id="savedItineraryModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 480px; text-align: center;">
      <h3 style="color: var(--success); margin-bottom: 0.5rem; font-size: 2rem;">âœ…</h3>
      <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.25rem; font-weight: 700;">Itinerary
        Saved!</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5;">
        Your itinerary has been successfully saved to the database.
      </p>
      <div class="modal-actions" style="justify-content: center; gap: 1rem;">
        <button class="btn btn-secondary" onclick="closeSavedItineraryModal(false)" style="min-width: 100px;">Stay
          Here</button>
        <button class="btn btn-primary" onclick="closeSavedItineraryModal(true)"
          style="min-width: 100px; background-color: var(--success); border-color: var(--success);">View
          Itineraries</button>
      </div>
    </div>
  </div>

  <!-- Login Required Modal -->
  <div id="loginRequiredModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 480px; text-align: center;">
      <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 2rem;">ðŸ‘¤</h3>
      <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.25rem; font-weight: 700;">Login
        Required</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.5;">
        You need to be logged in to save itineraries to the database. Your current work will be saved automatically.
      </p>
      <div class="modal-actions" style="justify-content: center; gap: 1rem;">
        <button class="btn btn-secondary" onclick="closeLoginRequiredModal()" style="min-width: 100px;">Cancel</button>
        <button class="btn btn-primary" onclick="saveDraft(); window.location.href='/login'"
          style="min-width: 100px;">Login/Register</button>
      </div>
    </div>
  </div>

  <script>
    let unitCount = 0;
    let flightCount = 0;
    let isParsing = false;
    let currentFlights = [];
    let currentFinalText = '';
    let currentMarkup = 0;
    let currentServiceCharge = 0;
    let currentGST = 0;
    let activeBillingType = 'passenger';
    let allCustomers = [];
    let currentTripType = 'one_way';
    let unitFlightCounts = {}; // Track flight count per unit for multi-city
    let unitFlights = {}; // Store flights organized by unit
    let isGlobalEditMode = false; // Track if we're in edit mode for fare cards
    let hasUnsavedFareChanges = false; // Track if there are unsaved fare changes
    let billingAccounts = [];
    let savePassengers = []; // Temporary list of passengers to be saved with itinerary
    let saveWizardStep = 1;

    // Check authentication status on load
    window.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      await checkAuth();
      await loadCustomers();
      initializeTripType();
      initializeDarkMode();
      initializeSidebar();

      // ONLY Load draft if explicitly requested (e.g. after login redirect)
      if (urlParams.get('restore') === '1') {
        setTimeout(loadDraft, 500);
      }

      // Check for edit mode from itinerary
      const editId = urlParams.get('edit');
      if (editId) {
        await loadItineraryForEdit(editId);
      }

      // Close modals when clicking outside (on overlay)
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          const overlayId = e.target.id;
          if (overlayId === 'saveModal') {
            closeSaveModal();
          } else if (overlayId === 'loginRequiredModal') {
            closeLoginRequiredModal();
          } else {
            // General fallback
            e.target.classList.remove('active');
            e.target.classList.remove('is-active');
            e.target.style.display = 'none';
          }
        }
      });
    });

    let editingItineraryId = null; // Track if we're editing an existing itinerary

    async function loadItineraryForEdit(id) {
      try {
        const r = await fetch('/api/v2/itineraries/' + id);
        if (!r.ok) { showNotification('Failed to load itinerary for editing', 'error'); return; }
        const it = await r.json();
        editingItineraryId = id;

        // Restore trip type mode using radio buttons
        const tripType = it.trip_type || 'one_way';
        const radio = document.querySelector(`input[name="tripType"][value="${tripType}"]`);
        if (radio) {
          radio.checked = true;
          handleTripType(); // This rebuilds input UI (Unit 1) and resets unitFlights
        }

        // Reconstruct Units (Add missing units)
        // Reconstruct Units (Add missing units and cities)
        // Group flights by unit_id to determine structure
        const flightsByUnit = {};
        (it.flights || []).forEach(f => {
          const uid = f.unit_id || 1;
          if (!flightsByUnit[uid]) flightsByUnit[uid] = [];
          flightsByUnit[uid].push(f);
        });

        const unitIds = Object.keys(flightsByUnit).sort((a, b) => parseInt(a) - parseInt(b));
        const neededUnits = unitIds.length || 1;

        // Create Units (Options)
        for (let i = 1; i < neededUnits; i++) {
          addUnit();
        }

        // For Multi-City, add cities to each unit if needed
        if (tripType === 'multi_city') {
          unitIds.forEach((uid, idx) => {
            const flightCount = flightsByUnit[uid].length;
            // Assuming units are recreated sequentially: index 0 -> Unit 1, index 1 -> Unit 2
            const domUnitId = idx + 1;

            // Add extra cities (first one exists by default)
            for (let k = 1; k < flightCount; k++) {
              addCityToUnit(domUnitId);
            }
          });
        }

        // Restore raw input texts to textareas if available
        if (it.raw_input_data && it.raw_input_data.flight_texts) {
          const textareas = document.querySelectorAll('#flightInputs textarea');
          it.raw_input_data.flight_texts.forEach((text, idx) => {
            if (textareas[idx]) textareas[idx].value = text;
          });
        }

        // Restore flights
        if (it.flights && it.flights.length > 0) {
          currentFlights = it.flights;
          if (it.parser_output_text) {
            const outputEl = document.getElementById('output');
            if (outputEl) outputEl.textContent = it.parser_output_text;
            currentFinalText = it.parser_output_text;
          }

          // Re-render
          renderResults(currentFlights);
          document.getElementById('cardsSection').style.display = 'block';
          document.getElementById('outputSection').style.display = 'block';
        }

        // --- Restore Save Modal Data ---
        document.getElementById('saveItineraryTitle').value = it.title || '';
        if (document.getElementById('saveReferenceNumber')) document.getElementById('saveReferenceNumber').value = it.reference_number || '';
        if (document.getElementById('saveReferenceNumber')) document.getElementById('saveReferenceNumber').value = it.reference_number || '';

        // Restore Passengers
        if (it.passengers_data && Array.isArray(it.passengers_data)) {
          // Map to ensure format matches what renderSavePassengers expects
          savePassengers = it.passengers_data.map(p => {
            const pid = p.passenger_id || p.id;
            const isDb = !!(p.passenger_id || p.is_db === true || (p.id && String(p.id).indexOf('temp_') !== 0));
            return {
              first_name: p.first_name || (p.name ? p.name.split(' ')[0] : ''),
              last_name: p.last_name || (p.name ? p.name.split(' ').slice(1).join(' ') : ''),
              email: p.email || '',
              phone: p.phone || '',
              is_db: isDb,
              id: isDb ? pid : p.id,
              passenger_id: isDb ? pid : null
            };
          });
          renderSavePassengers();

          // Prefill Supplier
          if (it.supplier_account) {
            document.getElementById('supplierSearchInput').value = it.supplier_account.display_name;
            document.getElementById('supplierAccountSelect').value = it.supplier_account.id;
            document.getElementById('selectedSupplierName').textContent = it.supplier_account.display_name;
            document.getElementById('supplierSummary').style.display = 'flex';
          } else if (it.supplier_name) {
            showNewSupplierForm(it.supplier_name);
            document.getElementById('newSupCompany').value = it.supplier_company || '';
            document.getElementById('newSupGst').value = it.supplier_gst || '';
            document.getElementById('newSupEmail').value = it.supplier_email || '';
            document.getElementById('newSupPhone').value = it.supplier_phone || '';
            document.getElementById('newSupAddress').value = it.supplier_address || '';
          }

        }

        // Restore Billing Account Selection
        if (it.billing_account_id && document.getElementById('billingAccountSelect')) {
          document.getElementById('billingAccountSelect').value = it.billing_account_id;
        }
        // --- End Restore ---

        // Update save button text for edit mode
        const saveBtnLabel = document.querySelector('.btn-save');
        if (saveBtnLabel) saveBtnLabel.innerHTML = 'ðŸ”„ Update Itinerary';

        const modalTitle = document.querySelector('#saveModal .modal-title');
        if (modalTitle) modalTitle.textContent = 'ðŸ”„ Update Itinerary';

        showNotification('Itinerary loaded for editing. Make your changes and click Update.', 'info');
      } catch (e) {
        console.error('Edit load error:', e);
        showNotification('Error loading itinerary', 'error');
      }
    }

    // Dark mode functionality
    function initializeDarkMode() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      updateThemeDisplay(savedTheme);

      // Add sidebar click event listener
      document.getElementById('sidebarThemeToggle').addEventListener('click', toggleDarkMode);
    }

    function toggleDarkMode() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeDisplay(newTheme);
    }

    function updateThemeDisplay(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const toggleBtn = document.getElementById('sidebarThemeToggle');
      const text = document.getElementById('themeToggleText');
      const icon = toggleBtn.querySelector('.theme-icon-container');

      if (theme === 'dark') {
        icon.textContent = 'â˜€ï¸';
        text.textContent = 'Light Mode';
        toggleBtn.classList.add('active');
      } else {
        icon.textContent = 'ðŸŒ™';
        text.textContent = 'Dark Mode';
        toggleBtn.classList.remove('active');
      }
    }

    // Sidebar Logic
    function initializeSidebar() {
      const menuToggle = document.getElementById('menuToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebar = document.getElementById('sidebar');

      menuToggle.addEventListener('click', () => {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scroll
      });

      const closeSidebar = () => {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      };

      sidebarClose.addEventListener('click', closeSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);
    }

    function initializeTripType() {
      const tripType = document.querySelector('input[name="tripType"]:checked').value;
      handleTripType();
    }

    async function checkAuth() {
      try {
        const response = await fetch('/api/user');
        if (response.ok) {
          const data = await response.json();
          updateAuthUI(data);
        }
      } catch (error) {
        // Not logged in, that's ok
      }
    }

    function updateAuthUI(user) {
      const sidebarAuthBtn = document.getElementById('sidebarAuthBtn');
      const sidebarUserName = document.getElementById('sidebarUserName');
      const sidebarUserEmail = document.getElementById('sidebarUserEmail');
      const sidebarAvatar = document.getElementById('sidebarAvatar');

      if (user) {
        if (sidebarUserName) sidebarUserName.textContent = user.username;
        if (sidebarUserEmail) sidebarUserEmail.textContent = user.email || 'Member';
        if (sidebarAvatar) sidebarAvatar.textContent = user.username.charAt(0).toUpperCase();

        if (sidebarAuthBtn) {
          sidebarAuthBtn.textContent = 'ðŸšª Logout';
          sidebarAuthBtn.classList.add('logout');
          sidebarAuthBtn.onclick = async () => {
            const confirmed = await showDeleteModal('Logout', 'Are you sure you want to logout?');
            if (confirmed) {
              logout();
            }
          };
        }
      }
    }

    function handleAuthClick() {
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = '/login?next=' + next;
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        showNotification('Logged out successfully', 'success');
        setTimeout(() => window.location.reload(), 1000);
      } catch (error) {
        showNotification('Logout failed', 'error');
      }
    }

    async function loadCustomers() {
      try {
        allCustomers = [];

        // Fetch Passengers from V2 API
        try {
          const passRes = await fetch('/api/v2/passengers');
          if (passRes.ok) {
            const passData = await passRes.json();
            if (passData.passengers) {
              passData.passengers.forEach(p => {
                allCustomers.push({
                  id: p.id,
                  name: p.full_name,
                  email: p.email,
                  phone: p.phone,
                  address: p.address_line1,
                  customer_type: 'passenger',
                  raw: p
                });
              });
            }
          }
        } catch (e) { console.error("Error fetching passengers:", e); }

        // Fetch Corporates from V2 API
        try {
          const corpRes = await fetch('/api/v2/corporates');
          if (corpRes.ok) {
            const corpData = await corpRes.json();
            if (corpData.corporates) {
              corpData.corporates.forEach(c => {
                allCustomers.push({
                  id: c.id,
                  name: c.contact_person_name || 'Contact Person',
                  company_name: c.company_name,
                  gst_number: c.gst_number,
                  email: c.contact_email,
                  phone: c.contact_phone,
                  address: c.billing_address_line1,
                  customer_type: 'corporate',
                  raw: c
                });
              });
            }
          }
        } catch (e) { console.error("Error fetching corporates:", e); }

        populateCustomerSelects();
      } catch (error) {
        console.log('Could not load customers:', error);
      }
    }

    function populateCustomerSelects() {
      const passengerSelect = document.getElementById('passengerCustomerSelect');
      const corporateSelect = document.getElementById('corporateCustomerSelect');

      // Clear existing options except first
      passengerSelect.innerHTML = '<option value="">Select existing passenger or enter new</option>';
      corporateSelect.innerHTML = '<option value="">Select existing corporate or enter new</option>';

      // Add customers to appropriate selects
      allCustomers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.customer_type === 'corporate'
          ? `${customer.company_name} (${customer.name})`
          : customer.name;

        if (customer.customer_type === 'passenger') {
          passengerSelect.appendChild(option);
        } else {
          corporateSelect.appendChild(option);
        }
      });
    }

    async function loadCustomerData(type) {
      const select = document.getElementById(`${type}CustomerSelect`);
      const customerId = select.value;

      if (!customerId) {
        clearForm(type);
        return;
      }

      const customer = allCustomers.find(c => c.id === customerId);
      if (!customer) return;

      if (type === 'passenger') {
        document.getElementById('passengerName').value = customer.name || '';
        document.getElementById('passengerEmail').value = customer.email || '';
        document.getElementById('passengerPhone').value = customer.phone || '';
        document.getElementById('passengerAddress').value = customer.address || '';

        // Fetch full passenger details including preferences & FF
        const extraInfoDiv = document.getElementById('passengerExtraInfo');
        const prefDisplay = document.getElementById('prefDisplay');
        const ffDisplay = document.getElementById('ffDisplay');

        try {
          const response = await fetch(`/api/v2/passengers/${customerId}`);
          if (response.ok) {
            const data = await response.json();

            // 1. Preferences
            let prefHtml = '';
            if (data.preferences) {
              if (data.preferences.meal_preference) {
                prefHtml += `<div><strong>Meal:</strong> ${data.preferences.meal_preference}</div>`;
              }
              if (data.preferences.seat_preference) {
                prefHtml += `<div><strong>Seat:</strong> ${data.preferences.seat_preference}</div>`;
              }
            }
            if (!prefHtml) prefHtml = '<div>No specific preferences found.</div>';
            prefDisplay.innerHTML = prefHtml;


            // 2. Frequent Flyer (Filtered by Airlines in currentFlights)
            let ffHtml = '';
            if (data.frequent_flyer_accounts && data.frequent_flyer_accounts.length > 0) {
              // Get unique airline names from currentFlights
              // Assuming currentFlights has 'airline' property which is the name
              const flightAirlines = [...new Set(currentFlights.map(f => f.airline ? f.airline.toLowerCase() : ''))];

              const relevantFF = data.frequent_flyer_accounts.filter(ff => {
                const ffAirline = ff.airline_name ? ff.airline_name.toLowerCase() : '';
                // Check if flight airline includes FF airline or vice versa
                return flightAirlines.some(fa => fa && (fa.includes(ffAirline) || ffAirline.includes(fa)));
              });

              if (relevantFF.length > 0) {
                relevantFF.forEach(ff => {
                  ffHtml += `<div style="margin-bottom: 0.25rem;">
                      <strong>${ff.airline_name}:</strong> <span style="font-family: monospace; background: var(--bg-card); padding: 2px 4px; border-radius: 4px; border: 1px solid var(--border);">${ff.frequent_flyer_number}</span> 
                      ${ff.tier_status ? `<span style="font-size: 0.75em; color: var(--primary); border: 1px solid var(--primary); padding: 0 4px; border-radius: 99px;">${ff.tier_status}</span>` : ''}
                   </div>`;
                });
              } else {
                ffHtml = '<div>No matching frequent flyer numbers for these flights.</div>';
              }
            } else {
              ffHtml = '<div>No frequent flyer accounts found.</div>';
            }
            ffDisplay.innerHTML = ffHtml;

            extraInfoDiv.style.display = 'grid'; // Show the container
          }
        } catch (e) {
          console.error("Error fetching passenger details:", e);
          extraInfoDiv.style.display = 'none';
        }

      } else {
        document.getElementById('corporateCompany').value = customer.company_name || '';
        document.getElementById('corporateName').value = customer.name || '';
        document.getElementById('corporateEmail').value = customer.email || '';
        document.getElementById('corporatePhone').value = customer.phone || '';
        document.getElementById('corporateGst').value = customer.gst_number || '';
        document.getElementById('corporateAddress').value = customer.address || '';
      }
    }

    function clearForm(type) {
      if (type === 'passenger') {
        document.getElementById('passengerName').value = '';
        document.getElementById('passengerEmail').value = '';
        document.getElementById('passengerPhone').value = '';
        document.getElementById('passengerAddress').value = '';
        document.getElementById('passengerExtraInfo').style.display = 'none';
      } else {
        document.getElementById('corporateCompany').value = '';
        document.getElementById('corporateName').value = '';
        document.getElementById('corporateEmail').value = '';
        document.getElementById('corporatePhone').value = '';
        document.getElementById('corporateGst').value = '';
        document.getElementById('corporateAddress').value = '';
      }
    }

    async function refreshCustomers() {
      await loadCustomers();
      showNotification('Customer list refreshed', 'success');
    }






    // --- Save Wizard Logic ---

    async function openSaveModal() {
      // 1. Check if logged in
      try {
        const authRes = await fetch('/api/user');
        if (!authRes.ok) {
          saveDraft();
          showNotification('Login required to save itineraries. Redirecting...', 'info');
          // Add a special parameter to restore the draft when coming back
          const next = encodeURIComponent(window.location.pathname + '?restore=1&openSave=1');
          setTimeout(() => {
            window.location.href = '/login?next=' + next;
          }, 1500);
          return;
        }
      } catch (e) {
        console.error("Auth check failed:", e);
      }

      // --- Persist Data logic ---
      const hasUnsavedData = savePassengers.length > 0 ||
        document.getElementById('saveItineraryTitle').value.trim() !== '' ||
        document.getElementById('billingAccountSelect').value !== '';

      const isStartingNewSave = !editingItineraryId && !hasUnsavedData;

      if (isStartingNewSave) {
        // Only reset if it's a completely fresh save and we have no unsaved progress
        saveWizardStep = 1;
        savePassengers = [];
        document.getElementById('saveItineraryTitle').value = '';
        document.getElementById('billingAccountSelect').value = '';
        document.getElementById('billingSearchInput').value = '';
        document.getElementById('billingSummary').style.display = 'none';
        document.getElementById('newBillingForm').style.display = 'none';
        document.getElementById('savePassengerList').innerHTML = '';
        tempBillingDetails = null;
        clearSupplierSelection();
      }

      // If we are switching itineraries being edited, we MUST reset
      const lastEditedId = document.getElementById('saveModal').dataset.currentlyEditingId;
      if (editingItineraryId && editingItineraryId !== lastEditedId) {
        saveWizardStep = 1;
        savePassengers = [];
        document.getElementById('saveItineraryTitle').value = '';
        document.getElementById('billingAccountSelect').value = '';
        document.getElementById('billingSearchInput').value = '';
        document.getElementById('billingSummary').style.display = 'none';
        document.getElementById('newBillingForm').style.display = 'none';
        document.getElementById('savePassengerList').innerHTML = '';
        tempBillingDetails = null;
        clearSupplierSelection();
        document.getElementById('saveModal').dataset.currentlyEditingId = editingItineraryId;
      } else if (!editingItineraryId && lastEditedId) {
        // Transitioning from edit mode to new save
        saveWizardStep = 1;
        savePassengers = [];
        document.getElementById('saveItineraryTitle').value = '';
        document.getElementById('billingAccountSelect').value = '';
        document.getElementById('billingSearchInput').value = '';
        document.getElementById('billingSummary').style.display = 'none';
        document.getElementById('newBillingForm').style.display = 'none';
        document.getElementById('savePassengerList').innerHTML = '';
        tempBillingDetails = null;
        clearSupplierSelection();
        delete document.getElementById('saveModal').dataset.currentlyEditingId;
      }

      // Load Data
      await Promise.all([loadBillingAccounts(), loadCustomers(), loadSupplierAccounts()]);

      // If editing, pre-fill saved data
      if (editingItineraryId) {
        try {
          const r = await fetch('/api/v2/itineraries/' + editingItineraryId);
          if (r.ok) {
            const it = await r.json();
            // Pre-fill title and reference
            document.getElementById('saveItineraryTitle').value = it.title || '';
            const refEl = document.getElementById('saveReferenceNumber');
            if (refEl) refEl.value = it.reference_number || '';

            // Pre-fill billing account
            if (it.billing_account_id) {
              document.getElementById('billingAccountSelect').value = it.billing_account_id;
              // Trigger visual update so user sees what's selected
              const acc = billingAccounts.find(a => a.id == it.billing_account_id);
              if (acc) {
                document.getElementById('billingSearchInput').value = acc.display_name;
                document.getElementById('selectedBillingName').textContent = acc.display_name;
                document.getElementById('selectedBillingDetails').innerHTML = `
                      ${acc.company_name ? `<div><strong>Company:</strong> ${acc.company_name}</div>` : ''}
                      ${acc.gst_number ? `<div><strong>GST:</strong> ${acc.gst_number}</div>` : ''}
                      ${acc.email ? `<div><strong>Email:</strong> ${acc.email}</div>` : ''}
                      ${acc.phone ? `<div><strong>Phone:</strong> ${acc.phone}</div>` : ''}
                  `;
                document.getElementById('billingSummary').style.display = 'block';
              }
            } else if (it.bill_to_name) {
              // Manual billing restoration
              tempBillingDetails = {
                display_name: it.bill_to_name,
                company_name: it.bill_to_company,
                address: it.bill_to_address,
                gst_number: it.bill_to_gst,
                email: it.bill_to_email,
                phone: it.bill_to_phone
              };
              renderTempBillingSummary();
              document.getElementById('billingSummary').style.display = 'block';
              document.getElementById('billingSearchInput').value = it.bill_to_name;
            }

            // Pre-fill passengers
            if (it.passengers_data && it.passengers_data.length > 0) {
              savePassengers = it.passengers_data.map(p => {
                const pid = p.passenger_id || p.id;
                const isDb = !!(p.passenger_id || p.is_db === true || (p.id && String(p.id).indexOf('temp_') !== 0));
                return {
                  id: isDb ? pid : p.id,
                  passenger_id: isDb ? pid : null,
                  first_name: p.first_name || (p.name ? p.name.split(' ')[0] : ''),
                  last_name: p.last_name || (p.name ? p.name.split(' ').slice(1).join(' ') : ''),
                  email: p.email,
                  phone: p.phone,
                  is_db: isDb
                };
              });
              renderSavePassengers();

              // Prefill Supplier
              if (it.supplier_account) {
                document.getElementById('supplierSearchInput').value = it.supplier_account.display_name;
                document.getElementById('supplierAccountSelect').value = it.supplier_account.id;
                document.getElementById('selectedSupplierName').textContent = it.supplier_account.display_name;

                let subText = it.supplier_account.account_type === 'corporate' ? 'Corporate' : 'Individual';
                if (it.supplier_account.company_name) subText += ` â€¢ ${it.supplier_account.company_name}`;
                if (it.supplier_account.gst_number) subText += ` â€¢ GST: ${it.supplier_account.gst_number}`;
                document.getElementById('selectedSupplierDetails').textContent = subText;

                document.getElementById('supplierSummary').style.display = 'flex';
              } else if (it.supplier_name) {
                // Manual supplier entry restoration
                tempSupplierDetails = {
                  display_name: it.supplier_name,
                  company_name: it.supplier_company,
                  email: it.supplier_email,
                  phone: it.supplier_phone,
                  gst_number: it.supplier_gst,
                  address: it.supplier_address,
                  account_type: 'corporate'
                };
                document.getElementById('supplierSearchInput').value = it.supplier_name;
                document.getElementById('selectedSupplierName').textContent = it.supplier_name;
                document.getElementById('selectedSupplierDetails').textContent = 'Manual Entry';
                document.getElementById('supplierSummary').style.display = 'flex';
              }
            }

            // Update modal title and button text for edit mode
            const modalTitle = document.querySelector('#saveModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'ðŸ”„ Update Itinerary';
            const saveBtnText = document.getElementById('saveBtnText');
            if (saveBtnText) saveBtnText.textContent = 'ðŸ”„ Update Itinerary';
          }
        } catch (e) { console.error('Error pre-filling edit data:', e); }
      } else {
        // Ensure we show "Save" text for new itineraries
        const modalTitle = document.querySelector('#saveModal .modal-title');
        if (modalTitle) modalTitle.textContent = 'ðŸ’¾ Save Itinerary';
        const saveBtnText = document.getElementById('saveBtnText');
        if (saveBtnText) saveBtnText.textContent = 'ðŸ’¾ Save Itinerary';
      }

      // Show Modal
      document.getElementById('saveModal').classList.add('active');
      goToStep(1);
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    function goToStep(step) {
      saveWizardStep = step;
      document.querySelectorAll('.save-step').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.save-step').forEach(el => {
        el.style.display = 'none';
        el.style.opacity = '0';
        el.style.transform = 'translateY(5px)';
      });

      const targetStep = document.getElementById(`saveStep${step}`);
      targetStep.style.display = 'block';
      // Trigger reflow
      void targetStep.offsetWidth;
      targetStep.style.transition = 'all 0.3s ease';
      targetStep.style.opacity = '1';
      targetStep.style.transform = 'translateY(0)';

      // Update Indicators
      document.querySelectorAll('.step-indicator').forEach(el => {
        el.classList.remove('active');
        el.style.fontWeight = '500';
        el.style.color = '#94a3b8';
        el.style.borderBottom = '2px solid #eee';
        el.style.textShadow = 'none';
      });
      const activeInd = document.getElementById(`stepIndicator${step}`);
      activeInd.classList.add('active');
      activeInd.style.fontWeight = '800';
      activeInd.style.color = '#3b82f6';
      activeInd.style.borderBottom = '2px solid #3b82f6';
      activeInd.style.textShadow = 'none';
    }

    // --- Step 1: Billing ---
    async function loadBillingAccounts() {
      try {
        const response = await fetch('/api/v2/billing-accounts');
        if (response.ok) {
          const data = await response.json();
          billingAccounts = data.billing_accounts || [];
          console.log('Loaded', billingAccounts.length, 'billing accounts');
        }
      } catch (e) {
        console.error('Failed to load billing accounts', e);
      }
    }

    let currentBillingResults = [];

    function searchBillingUnified() {
      const q = document.getElementById('billingSearchInput').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('billingSearchResults');

      // If input value doesn't match currently selected ID's name, clear the ID
      // This ensures that if user types something new, it's treated as unsaved billing
      const currentId = document.getElementById('billingAccountSelect').value;
      if (currentId) {
        const acc = billingAccounts.find(a => a.id == currentId);
        // Check if name matches (case-insensitive to be safe, but input value mimics display name usually)
        if (acc && acc.display_name.toLowerCase() !== q && q.length > 0) { // q.length check to allow clearing field
          // Mismatch: clear ID so it's treated as new/temp
          document.getElementById('billingAccountSelect').value = '';
          document.getElementById('selectedBillingName').textContent = '';
          document.getElementById('selectedBillingDetails').innerHTML = '';
          document.getElementById('billingSummary').style.display = 'none';
          tempBillingDetails = null;
        }
      }

      // Also clear tempBillingDetails if typing something new
      if (!currentId && tempBillingDetails && q.length > 0) {
        tempBillingDetails = null;
        document.getElementById('selectedBillingName').textContent = '';
        document.getElementById('selectedBillingDetails').innerHTML = '';
        document.getElementById('billingSummary').style.display = 'none';
      }

      // Show everything if empty

      currentBillingResults = [];

      // 1. Search existing BillingAccounts
      billingAccounts.forEach(acc => {
        const displayName = (acc.display_name || '').toLowerCase();
        const companyName = (acc.company_name || '').toLowerCase();
        const emailRaw = acc.email || '';
        const phoneRaw = acc.phone || '';
        const email = emailRaw.toLowerCase();
        const phone = phoneRaw.toLowerCase();
        if (!q || displayName.includes(q) || companyName.includes(q) || email.includes(q) || phone.includes(q)) {
          const contactParts = [];
          if (emailRaw) contactParts.push(emailRaw);
          if (phoneRaw) contactParts.push(phoneRaw);
          const contact = contactParts.join(' â€¢ ');
          currentBillingResults.push({
            type: 'billing',
            id: acc.id,
            display: acc.display_name || 'Unnamed Account',
            sub: acc.company_name ? 'B2B Customer' : 'B2C Customer',
            contact: contact,
            raw: acc
          });
        }
      });

      // 2. Search Customers (Passengers/Corporates)
      allCustomers.forEach(c => {
        const name = (c.name || '').toLowerCase();
        const company = (c.company_name || '').toLowerCase();
        const emailRaw = c.email || c.contact_email || '';
        const phoneRaw = c.phone || c.contact_phone || '';
        const email = emailRaw.toLowerCase();
        const phone = phoneRaw.toLowerCase();
        if (!q || name.includes(q) || company.includes(q) || email.includes(q) || phone.includes(q)) {
          const contactParts = [];
          if (emailRaw) contactParts.push(emailRaw);
          if (phoneRaw) contactParts.push(phoneRaw);
          const contact = contactParts.join(' â€¢ ');
          currentBillingResults.push({
            type: c.customer_type,
            id: c.id,
            display: c.customer_type === 'corporate' ? ((c.company_name || '') + (c.name ? ' (' + c.name + ')' : '')) : (c.name || 'Unnamed Passenger'),
            sub: c.customer_type === 'corporate' ? (c.company_name ? 'B2B Customer' : 'B2C Customer') : 'B2C Customer',
            contact: contact,
            raw: c
          });
        }
      });

      if (currentBillingResults.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:15px; text-align:center; color:var(--text-secondary);"><i class="fas fa-search" style="display:block; font-size:1.5rem; margin-bottom:10px; opacity:0.3;"></i>No matches found. Use "+ New" to create.</div>';
      } else {
        resultsDiv.innerHTML = currentBillingResults.slice(0, 10).map((r, idx) => `
            <div class="search-item" onclick="selectBillingRecordByIndex(${idx})" 
                 style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition: background 0.2s;">
                <div class="avatar" style="width:36px; height:36px; border-radius:50%; background:#2563eb; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                  ${(r.display && r.display.trim().length > 0) ? r.display.trim()[0].toUpperCase() : '?'}
                </div>
                <div style="flex-grow:1; line-height:1.4;">
                  <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <div style="font-weight:600; color:var(--text-primary); font-size:0.95rem;">
                      ${r.display}
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-secondary); display:flex; align-items:center; gap:5px;">
                      <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:${r.sub.includes('B2B') ? '#4caf50' : '#2196f3'};"></span>
                      ${r.sub}
                    </div>
                  </div>
                  ${r.contact ? `<div style="font-size:0.75rem; color:var(--text-secondary); margin-top:2px;">${r.contact}</div>` : ''}
                </div>
            </div>
        `).join('');
      }
      resultsDiv.style.display = 'block';
    }

    function selectBillingRecordByIndex(idx) {
      const res = currentBillingResults[idx];
      if (!res) return;

      const resultsDiv = document.getElementById('billingSearchResults');
      const input = document.getElementById('billingSearchInput');
      const container = document.getElementById('billingSummary');
      const idInput = document.getElementById('billingAccountSelect');

      resultsDiv.style.display = 'none';
      tempBillingDetails = null;
      const raw = res.raw;

      if (res.type === 'billing') {
        idInput.value = raw.id;
        input.value = raw.display_name;
        document.getElementById('selectedBillingName').textContent = raw.display_name;
        document.getElementById('selectedBillingDetails').innerHTML = `
                ${raw.company_name ? `<div><strong>Company:</strong> ${raw.company_name}</div>` : ''}
                ${raw.gst_number ? `<div><strong>GST:</strong> ${raw.gst_number}</div>` : ''}
                ${raw.email ? `<div><strong>Email:</strong> ${raw.email}</div>` : ''}
                ${raw.phone ? `<div><strong>Phone:</strong> ${raw.phone}</div>` : ''}
          `;
      } else if (res.type === 'passenger') {
        idInput.value = '';
        input.value = raw.name;
        tempBillingDetails = {
          account_type: 'individual',
          display_name: raw.name,
          contact_name: raw.name,
          email: raw.email,
          phone: raw.phone,
          address: raw.address,
          passenger_id: raw.id
        };
        renderTempBillingSummary();
      } else if (res.type === 'corporate') {
        idInput.value = '';
        input.value = raw.company_name;
        tempBillingDetails = {
          account_type: 'corporate',
          display_name: raw.company_name,
          company_name: raw.company_name,
          contact_name: raw.name,
          email: raw.email,
          phone: raw.phone,
          address: raw.address,
          gst_number: raw.gst_number,
          corporate_id: raw.id
        };
        renderTempBillingSummary();
      }
      container.style.display = 'block';
    }

    function renderTempBillingSummary() {
      if (!tempBillingDetails) return;
      document.getElementById('selectedBillingName').textContent = tempBillingDetails.display_name;
      document.getElementById('selectedBillingDetails').innerHTML = `
            ${tempBillingDetails.company_name ? `<div><strong>Company:</strong> ${tempBillingDetails.company_name}</div>` : ''}
            ${tempBillingDetails.gst_number ? `<div><strong>GST:</strong> ${tempBillingDetails.gst_number}</div>` : ''}
            ${tempBillingDetails.email ? `<div><strong>Email:</strong> ${tempBillingDetails.email}</div>` : ''}
            ${tempBillingDetails.phone ? `<div><strong>Phone:</strong> ${tempBillingDetails.phone}</div>` : ''}
      `;
    }

    function toggleNewBillingForm() {
      const form = document.getElementById('newBillingForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';

      // If closing, maybe clear? No, keep state.
    }

    function prepareNewBillingAccount(name) {
      if (!name) return;
      document.getElementById('billingSearchResults').style.display = 'none';

      const form = document.getElementById('newBillingForm');
      form.style.display = 'block';

      // Detect email or phone
      const isEmail = name.includes('@');
      const isPhone = /^\+?\d{7,15}$/.test(name.replace(/[\s-]/g, ''));

      if (isEmail) {
        document.getElementById('newBillEmail').value = name;
        // Extract display name from email
        const extractedName = name.split('@')[0].replace(/[._]/g, ' ');
        document.getElementById('newBillDisplay').value = extractedName;
      } else if (isPhone) {
        document.getElementById('newBillPhone').value = name;
        document.getElementById('newBillDisplay').value = ''; // Let them fill it
        document.getElementById('newBillDisplay').focus();
        document.getElementById('saveBillingToDb').checked = true;
        return; // Exit early to keep focus
      } else {
        document.getElementById('newBillDisplay').value = name;
      }

      document.getElementById('saveBillingToDb').checked = true;
      if (!document.getElementById('newBillDisplay').value) {
        document.getElementById('newBillDisplay').focus();
      } else {
        // If display name filled, focus on next logical field
        document.getElementById('newBillCompany').focus();
      }
    }

    function searchBillingUnified() {
      const originalVal = document.getElementById('billingSearchInput').value.trim();
      const q = originalVal.toLowerCase();
      const resultsDiv = document.getElementById('billingSearchResults');

      const currentId = document.getElementById('billingAccountSelect').value;
      if (currentId) {
        const acc = billingAccounts.find(a => a.id == currentId);
        if (acc && acc.display_name.toLowerCase() !== q && q.length > 0) {
          document.getElementById('billingAccountSelect').value = '';
          document.getElementById('selectedBillingName').textContent = '';
          document.getElementById('selectedBillingDetails').innerHTML = '';
          document.getElementById('billingSummary').style.display = 'none';
          tempBillingDetails = null;
        }
      }

      if (!currentId && tempBillingDetails && q.length > 0) {
        tempBillingDetails = null;
        document.getElementById('selectedBillingName').textContent = '';
        document.getElementById('selectedBillingDetails').innerHTML = '';
        document.getElementById('billingSummary').style.display = 'none';
      }

      currentBillingResults = [];

      billingAccounts.forEach(acc => {
        const displayName = (acc.display_name || '').toLowerCase();
        const companyName = (acc.company_name || '').toLowerCase();
        if (!q || displayName.includes(q) || companyName.includes(q)) {
          currentBillingResults.push({
            type: 'billing',
            id: acc.id,
            display: acc.display_name || 'Unnamed Account',
            sub: acc.company_name ? 'B2B Customer' : 'B2C Customer',
            raw: acc
          });
        }
      });

      allCustomers.forEach(c => {
        const name = (c.name || '').toLowerCase();
        const company = (c.company_name || '').toLowerCase();
        if (!q || name.includes(q) || company.includes(q)) {
          currentBillingResults.push({
            type: c.customer_type,
            id: c.id,
            display: c.customer_type === 'corporate' ? ((c.company_name || '') + (c.name ? ' (' + c.name + ')' : '')) : (c.name || 'Unnamed Passenger'),
            sub: c.customer_type === 'corporate' ? (c.company_name ? 'B2B Customer' : 'B2C Customer') : 'B2C Customer',
            raw: c
          });
        }
      });

      let html = currentBillingResults.slice(0, 10).map((r, idx) => `
            <div class="search-item" onclick="selectBillingRecordByIndex(${idx})" 
                 style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition: background 0.2s;">
                <div class="avatar" style="width:36px; height:36px; border-radius:50%; background:#2563eb; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                  ${(r.display && r.display.trim().length > 0) ? r.display.trim()[0].toUpperCase() : '?'}
                </div>
                <div style="flex-grow:1; line-height:1.4;">
                  <div style="font-weight:600; color:var(--text-primary); font-size:0.95rem;">${r.display}</div>
                  <div style="font-size:0.8rem; color:var(--text-secondary); display:flex; align-items:center; gap:5px;">
                    <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:${r.sub.includes('B2B') ? '#4caf50' : '#2196f3'};"></span>
                    ${r.sub}
                  </div>
                </div>
            </div>
        `).join('');

      if (q.length > 0) {
        html += `
            <div class="search-item" onclick="prepareNewBillingAccount('${originalVal.replace(/'/g, "\\'")}')" 
                 style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition: background 0.2s; background: rgba(37, 99, 235, 0.05); color: var(--primary);">
                <div class="avatar" style="width:36px; height:36px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:16px;">+</div>
                <div style="flex-grow:1; line-height:1.4;">
                  <div style="font-weight:600; font-size:0.95rem;">Create New: "${originalVal}"</div>
                  <div style="font-size:0.8rem; opacity:0.8;">Open form to add billing details</div>
                </div>
            </div>`;
      } else if (currentBillingResults.length === 0) {
        html = '<div style="padding:15px; text-align:center; color:var(--text-secondary);">Start typing to search...</div>';
      }

      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    let tempBillingDetails = null; // Store ad-hoc details

    async function useNewBillingAccount() {
      const type = document.getElementById('newBillType').value;
      const display = document.getElementById('newBillDisplay').value;
      const saveToDb = document.getElementById('saveBillingToDb').checked;

      if (!display) {
        showNotification('Display Name is required', 'error');
        return;
      }

      const payload = {
        account_type: type,
        display_name: display,
        company_name: document.getElementById('newBillCompany').value,
        contact_name: document.getElementById('newBillContact').value,
        email: document.getElementById('newBillEmail').value,
        phone: document.getElementById('newBillPhone').value,
        gst_number: document.getElementById('newBillGst').value,
        address: document.getElementById('newBillAddress').value
      };

      if (saveToDb) {
        // Create in DB and select it
        try {
          const response = await fetch('/api/v2/billing-accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            const result = await response.json();
            await loadBillingAccounts();
            loadSupplierAccounts();
            loadSupplierAccounts();

            // Set selection in UI
            document.getElementById('billingAccountSelect').value = result.billing_account.id;
            document.getElementById('billingSearchInput').value = result.billing_account.display_name;

            // Render Summary
            document.getElementById('selectedBillingName').textContent = result.billing_account.display_name;
            document.getElementById('selectedBillingDetails').innerHTML = `
                ${result.billing_account.company_name ? `<div>${result.billing_account.company_name}</div>` : ''}
                ${result.billing_account.gst_number ? `<div>GST: ${result.billing_account.gst_number}</div>` : ''}
                ${result.billing_account.email ? `<div>${result.billing_account.email}</div>` : ''}
            `;
            document.getElementById('billingSummary').style.display = 'block';

            toggleNewBillingForm();
            showNotification('Billing Account saved & selected', 'success');
            tempBillingDetails = null; // Clear temp as we are using a real ID
          } else {
            const err = await response.json();
            showNotification(err.error || 'Failed to create account', 'error');
          }
        } catch (e) {
          console.error(e);
          showNotification('Error creating account', 'error');
        }
      } else {
        // Ad-hoc usage
        tempBillingDetails = payload; // Store for submit step

        // Set UI to show this is selected
        document.getElementById('billingAccountSelect').value = ''; // Deselect specific account
        document.getElementById('selectedBillingName').textContent = display + " (Unsaved)";
        document.getElementById('selectedBillingDetails').innerHTML = `
                ${payload.company_name ? `<div>${payload.company_name}</div>` : ''}
                ${payload.gst_number ? `<div>GST: ${payload.gst_number}</div>` : ''}
                ${payload.email ? `<div>${payload.email}</div>` : ''}
          `;
        document.getElementById('billingSummary').style.display = 'block';

        toggleNewBillingForm();
        showNotification('Using temporary billing details', 'info');
      }
    }


    // --- Step 2: Supplier ---
    let supplierAccounts = [];
    let currentSupplierResults = [];
    let tempSupplierDetails = null;

    async function loadSupplierAccounts() {
      try {
        const response = await fetch('/api/v2/supplier-accounts');
        if (response.ok) {
          const data = await response.json();
          supplierAccounts = data.supplier_accounts || [];
        }
      } catch (e) { console.error('Failed to load supplier accounts', e); }
    }

    function searchSupplierUnified() {
      const q = document.getElementById('supplierSearchInput').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('supplierSearchResults');

      const currentId = document.getElementById('supplierAccountSelect').value;
      if (currentId) {
        const acc = supplierAccounts.find(a => a.id == currentId);
        if (acc && acc.display_name.toLowerCase() !== q && q.length > 0) {
          clearSupplierSelection(true);
        }
      }

      if (q.length === 0) {
        resultsDiv.style.display = 'none';
        document.getElementById('newSupplierForm').style.display = 'none';
        return;
      }

      currentSupplierResults = [];
      supplierAccounts.forEach(acc => {
        const displayName = (acc.display_name || '').toLowerCase();
        const companyName = (acc.company_name || '').toLowerCase();
        const gst = (acc.gst_number || '').toLowerCase();
        if (displayName.includes(q) || companyName.includes(q) || gst.includes(q)) {
          currentSupplierResults.push({
            id: acc.id,
            display: acc.display_name,
            sub: acc.account_type === 'corporate' ? 'Corporate' : 'Individual',
            raw: acc
          });
        }
      });

      let html = currentSupplierResults.slice(0, 10).map((r, idx) => {
        return `
        <div class="dropdown-item" onclick="selectSupplierByIndex(${idx})" style="padding:10px; cursor:pointer; border-bottom:1px solid var(--border);">
          <div style="font-weight:600;">${r.display}</div>
          <div style="font-size:0.8rem; color:var(--text-secondary);">${r.sub}</div>
        </div>
        `;
      }).join('');

      html += `
        <div class="dropdown-item" style="padding:10px; cursor:pointer; background:var(--primary-light); color:var(--primary); font-weight:bold;"
             onclick="showNewSupplierForm('${q}')">
          + Create New Supplier Account: "${q}"
        </div>
      `;

      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
      document.getElementById('newSupplierForm').style.display = 'none';
    }

    function selectSupplierByIndex(idx) {
      const res = currentSupplierResults[idx];
      if (!res) return;

      document.getElementById('supplierSearchInput').value = res.display;
      document.getElementById('supplierSearchResults').style.display = 'none';

      document.getElementById('supplierAccountSelect').value = res.id;
      document.getElementById('selectedSupplierName').textContent = res.display;

      let subText = res.sub;
      if (res.raw.company_name) subText += ` â€¢ ${res.raw.company_name}`;
      if (res.raw.gst_number) subText += ` â€¢ GST: ${res.raw.gst_number}`;
      document.getElementById('selectedSupplierDetails').textContent = subText;

      document.getElementById('supplierSummary').style.display = 'flex';
      document.getElementById('newSupplierForm').style.display = 'none';
      tempSupplierDetails = null; // Clear temp if using existing
    }

    function showNewSupplierForm(name) {
      document.getElementById('supplierSearchResults').style.display = 'none';
      document.getElementById('newSupplierForm').style.display = 'block';
      document.getElementById('supplierSummary').style.display = 'none';

      document.getElementById('newSupDisplay').value = name;
      document.getElementById('supplierAccountSelect').value = '';

      if (name.toLowerCase().includes('co') || name.toLowerCase().includes('ltd')) {
        document.getElementById('newSupType').value = 'corporate';
      } else {
        document.getElementById('newSupType').value = 'individual';
      }
      handleSupTypeChange();
    }

    function handleSupTypeChange() {
      const type = document.getElementById('newSupType').value;
      if (type === 'corporate') {
        document.getElementById('corporateSupFields').style.display = 'block';
      } else {
        document.getElementById('corporateSupFields').style.display = 'none';
        document.getElementById('newSupCompany').value = '';
        document.getElementById('newSupGst').value = '';
        document.getElementById('newSupContact').value = '';
      }
      buildTempSupplier();
    }

    function clearSupplierSelection(keepSearchStr = false) {
      if (!keepSearchStr) document.getElementById('supplierSearchInput').value = '';
      document.getElementById('supplierAccountSelect').value = '';
      document.getElementById('selectedSupplierName').textContent = '';
      document.getElementById('selectedSupplierDetails').innerHTML = '';
      document.getElementById('supplierSummary').style.display = 'none';
      tempSupplierDetails = null;
    }

    function buildTempSupplier() {
      const type = document.getElementById('newSupType').value;
      const display = document.getElementById('newSupDisplay').value;
      if (!display) return;
      tempSupplierDetails = {
        account_type: type,
        display_name: display,
        company_name: document.getElementById('newSupCompany').value,
        contact_name: document.getElementById('newSupContact').value,
        email: document.getElementById('newSupEmail').value,
        phone: document.getElementById('newSupPhone').value,
        gst_number: document.getElementById('newSupGst').value,
        address: document.getElementById('newSupAddress').value
      };
    }

    ['newSupDisplay', 'newSupCompany', 'newSupContact', 'newSupEmail', 'newSupPhone', 'newSupGst', 'newSupAddress'].forEach(id => {
      const e = document.getElementById(id);
      if (e) e.addEventListener('input', buildTempSupplier);
    });

    function initSupplierListeners() {
      ['newSupDisplay', 'newSupCompany', 'newSupContact', 'newSupEmail', 'newSupPhone', 'newSupGst', 'newSupAddress'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', buildTempSupplier);
      });
    }

    // --- Step 3: Passengers ---
    // Reuse existing customer loader logic slightly or fetch new
    let allPassengersCache = [];

    function prepareNewPassenger(name) {
      if (!name) return;
      document.getElementById('savePassengerResults').style.display = 'none';

      const form = document.getElementById('quickAddPassengerForm');
      form.style.display = 'block';

      // Detect email or phone
      const isEmail = name.includes('@');
      const isPhone = /^\+?\d{7,15}$/.test(name.replace(/[\s-]/g, ''));

      // Clear previous values first
      document.getElementById('qaFirst').value = '';
      document.getElementById('qaLast').value = '';
      document.getElementById('qaEmail').value = '';
      document.getElementById('qaPhone').value = '';

      if (isEmail) {
        document.getElementById('qaEmail').value = name;
        // Suggest name from email
        const extractedName = name.split('@')[0].replace(/[._]/g, ' ');
        const parts = extractedName.split(' ');
        document.getElementById('qaFirst').value = parts[0];
        if (parts.length > 1) {
          document.getElementById('qaLast').value = parts.slice(1).join(' ');
        }
        document.getElementById('qaLast').focus();
      } else if (isPhone) {
        document.getElementById('qaPhone').value = name;
        document.getElementById('qaFirst').focus();
      } else {
        // Standard Name Input
        const parts = name.trim().split(' ');
        const first = parts[0];
        const last = parts.length > 1 ? parts.slice(1).join(' ') : '';

        document.getElementById('qaFirst').value = first;
        document.getElementById('qaLast').value = last;

        if (!last) document.getElementById('qaLast').focus();
        else document.getElementById('qaEmail').focus();
      }

      document.getElementById('qaSaveToDB').checked = true;
    }

    async function handleSavePassengerSearch() {
      const originalVal = document.getElementById('savePassengerSearch').value.trim();
      const query = originalVal.toLowerCase();
      const resultsDiv = document.getElementById('savePassengerResults');

      // Proceed even if query is short/empty

      if (allPassengersCache.length === 0) {
        const res = await fetch('/api/v2/passengers');
        const data = await res.json();
        allPassengersCache = data.passengers;
      }

      const filtered = allPassengersCache.filter(p =>
        (p.first_name + ' ' + p.last_name).toLowerCase().includes(query) ||
        (p.email && p.email.toLowerCase().includes(query))
      ).slice(0, 5);

      let html = '';

      if (filtered.length > 0) {
        html += filtered.map((p, idx) => `
            <div class="search-item" onclick='addSavePassenger(${JSON.stringify(p).replace(/'/g, "&apos;")})' 
                 style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition: background 0.2s;">
                <div class="avatar" style="width:32px; height:32px; border-radius:50%; background:#8b5cf6; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:13px;">
                  ${(p.first_name || '').charAt(0)}${(p.last_name || '').charAt(0)}
                </div>
                <div style="flex-grow:1; line-height:1.4;">
                  <div style="font-weight:600; color:var(--text-primary); font-size:0.95rem;">${p.first_name} ${p.last_name}</div>
                  <div style="font-size:0.8rem; color:var(--text-secondary);">${p.email || 'No email'} ${p.phone ? 'â€¢ ' + p.phone : ''}</div>
                </div>
            </div>
        `).join('');
      }

      // Append Options
      if (query.trim().length > 0) {
        // Option 2: Create New (Full Record)
        html += `
            <div class="search-item" onclick="prepareNewPassenger('${originalVal.replace(/'/g, "\\'")}')" 
                 style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; transition: background 0.2s; background: rgba(16, 185, 129, 0.05); color: var(--success);">
                <div class="avatar" style="width:32px; height:32px; border-radius:50%; background:var(--success); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:16px;">âœŽ</div>
                <div style="flex-grow:1; line-height:1.4;">
                  <div style="font-weight:600; font-size:0.95rem;">Create New: "${originalVal}"</div>
                  <div style="font-size:0.8rem; opacity:0.8;">Add full details to database</div>
                </div>
            </div>`;

      } else if (filtered.length === 0) {
        html = '<div style="padding:15px; text-align:center; color:var(--text-secondary);">Start typing to search...</div>';
      }

      if (html) {
        resultsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
      } else {
        resultsDiv.style.display = 'none';
      }
    }

    function addTemporaryPassengerFromSearch(name) {
      if (!name) return;
      const parts = name.trim().split(' ');
      const first = parts[0];
      const last = parts.length > 1 ? parts.slice(1).join(' ') : '';

      const newPax = {
        id: 'temp_' + Date.now(),
        first_name: first,
        last_name: last,
        email: '',
        phone: '',
        is_db: false
      };

      addSavePassenger(newPax);
      document.getElementById('savePassengerResults').style.display = 'none';
    }

    function addSavePassenger(p) {
      if (savePassengers.some(existing => existing.id === p.id)) {
        showNotification('Passenger already added', 'warning');
        return;
      }



      // Explicitly mark as DB passenger
      savePassengers.push({
        id: p.id,
        passenger_id: p.id,
        first_name: p.first_name,
        last_name: p.last_name,
        email: p.email,
        phone: p.phone,
        is_db: true
      });

      renderSavePassengers();

      document.getElementById('savePassengerSearch').value = '';
      document.getElementById('savePassengerResults').style.display = 'none';
      showNotification('Passenger added', 'success');
    }

    function updatePassengerCapacity() {
      // Just validation visual if needed
    }

    function toggleQuickAddPassenger() {
      const form = document.getElementById('quickAddPassengerForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    async function addQuickPassenger() {
      const first = document.getElementById('qaFirst').value.trim();
      const last = document.getElementById('qaLast').value.trim();
      const email = document.getElementById('qaEmail').value.trim();
      const phone = document.getElementById('qaPhone').value.trim();
      const saveToDb = document.getElementById('qaSaveToDB').checked;

      if (!first || !last) {
        showNotification('First and Last Name are required', 'warning'); return;
      }

      const newPax = {
        first_name: first,
        last_name: last,
        email: email,
        phone: phone,
        is_db: false
      };

      if (saveToDb) {
        try {
          const r = await fetch('/api/v2/passengers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newPax)
          });

          if (r.ok) {
            const d = await r.json();
            newPax.is_db = true;
            newPax.id = d.passenger.id;
            newPax.passenger_id = d.passenger.id;
            showNotification('Passenger saved to Database', 'success');
            allPassengersCache = []; // Clear cache
          } else if (r.status === 409) {
            const err = await r.json();
            showNotification(err.error || 'Duplicate passenger found. Please check details.', 'error');
            return; // Strict: do not add to list if failed
          } else {
            showNotification('Failed to save to DB. Please try again.', 'error');
            return; // Strict
          }
        } catch (e) {
          console.error(e);
          showNotification('Error saving passenger', 'error');
          return;
        }
      }

      savePassengers.push(newPax);

      renderSavePassengers();

      toggleQuickAddPassenger();

      // Clear form
      document.getElementById('qaFirst').value = '';
      document.getElementById('qaLast').value = '';
      document.getElementById('qaEmail').value = '';
      document.getElementById('qaPhone').value = '';
    }

    function removeSavePassenger(index) {
      savePassengers.splice(index, 1);
      renderSavePassengers();

    }

    function renderSavePassengers() {
      const container = document.getElementById('savePassengerList');
      const countDisplay = document.getElementById('passengerCountDisplay');

      if (countDisplay) countDisplay.textContent = savePassengers.length;

      if (savePassengers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px; font-style: italic;">No passengers added yet. Search above to add.</div>';
        return;
      }

      container.innerHTML = savePassengers.map((p, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid var(--border-color); margin-bottom:8px; border-radius:8px; background:var(--bg-card); box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                <div style="flex-grow:1; display:flex; align-items:center; gap:12px;">
                    <div class="avatar" style="width:36px; height:36px; border-radius:50%; background:${p.is_db ? '#10b981' : '#f59e0b'}; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:14px;">
                      ${(p.first_name || '').charAt(0)}${(p.last_name || '').charAt(0)}
                    </div>
                    <div>
                        <div style="display:flex; align-items:center;">
                            <span style="font-weight:600; color:var(--text-primary); margin-right:8px; font-size:0.95rem;">${p.first_name || ''} ${p.last_name || ''}</span>
                        </div>
                        <div style="font-size:0.85em; color:var(--text-secondary); margin-top:2px;">${p.email || 'No email'} ${p.phone ? ' â€¢ ' + p.phone : ''}</div>
                    </div>
                </div>
                <div>
                   <button onclick="removeSavePassenger(${i})" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; width:32px; height:32px; border-radius:4px; display:flex; align-items:center; justify-content:center; transition:all 0.2s;" onmouseover="this.style.color='var(--danger)';this.style.background='rgba(239, 68, 68, 0.1)'" onmouseout="this.style.color='var(--text-secondary)';this.style.background='none'">
                     âœ•
                   </button>
                </div>
            </div>
        `).join('');
    }

    async function savePaxToDB(index) {
      const p = savePassengers[index];
      if (!p || p.is_db) return;
      try {
        const r = await fetch('/api/v2/passengers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            first_name: p.first_name || '',
            last_name: p.last_name || '',
            email: p.email || '',
            phone: p.phone || ''
          })
        });
        if (r.ok) {
          const data = await r.json();
          // Update the local passenger to reflect DB status
          savePassengers[index].is_db = true;
          savePassengers[index].id = data.passenger ? data.passenger.id : data.id;
          savePassengers[index].passenger_id = data.passenger ? data.passenger.id : data.id;
          renderSavePassengers();

          // Refresh cache
          allPassengersCache = [];
          showNotification('Passenger saved to database!', 'success');
        } else {
          const e = await r.json();
          showNotification(e.error || 'Failed to save passenger', 'error');
        }
      } catch (e) { showNotification('Error saving passenger', 'error'); }
    }

    function calculateTotalAmount() {
      if (!Array.isArray(currentFlights) || currentFlights.length === 0) return 0;

      let grandTotal = 0;
      // Get trip type from radio buttons
      let tripType = 'one_way';
      const tripRadio = document.querySelector('input[name="tripType"]:checked');
      if (tripRadio) tripType = tripRadio.value;

      const globalMU = parseFloat(document.getElementById('markup').value) || 0;
      const globalSVC = parseFloat(document.getElementById('serviceCharge').value) || 0;

      const getFlightTotal = (f) => {
        if (!f) return 0;
        let base = 0;
        let type = 'saver';

        if (f.fares && Object.keys(f.fares).length > 0) {
          type = Object.keys(f.fares)[0];
          base = parseFloat(f.fares[type]) || 0;
        } else {
          base = parseFloat(f.saver_fare) || parseFloat(f.price) || 0;
        }

        const mu = (f.fare_mu && f.fare_mu[type] !== undefined) ? parseFloat(f.fare_mu[type]) : (f.markup !== undefined ? parseFloat(f.markup) : globalMU);
        const svc = (f.fare_svc && f.fare_svc[type] !== undefined) ? parseFloat(f.fare_svc[type]) : (f.service_charge !== undefined ? parseFloat(f.service_charge) : globalSVC);
        const gst = svc > 0 ? Math.round(svc * 0.18) : 0;

        return base + mu + svc + gst;
      };

      if (tripType === 'round_trip') {
        // Use first two segments (assuming they are outbound and return for first option)
        grandTotal = getFlightTotal(currentFlights[0]) + getFlightTotal(currentFlights[1]);
      } else if (tripType === 'multi_city') {
        // Sum segments belonging to the first unit
        const firstUnitId = (currentFlights[0] && currentFlights[0].unit_id) || '1';
        currentFlights.forEach(f => {
          if ((f.unit_id || '1') === firstUnitId) {
            grandTotal += getFlightTotal(f);
          }
        });
      } else {
        // One way: use first flight result as default baseline
        grandTotal = getFlightTotal(currentFlights[0]);
      }

      return grandTotal;
    }

    // --- Final Submit ---
    async function submitItinerary() {
      const btn = document.getElementById('finalSaveBtn');
      const loading = document.getElementById('saveBtnLoading');
      const text = document.getElementById('saveBtnText');
      let title = document.getElementById('saveItineraryTitle').value;
      const billingId = document.getElementById('billingAccountSelect').value;

      if (!title) {
        title = "Itinerary - " + new Date().toLocaleDateString();
      }

      btn.disabled = true;
      loading.style.display = 'block';
      text.style.display = 'none';

      try {
        const firstDbPassenger = savePassengers.find(p => p.is_db);

        // Determine billing details and type
        let finalBillingType = 'passenger';
        const billData = {
          name: null, company: null, address: null,
          gst: null, email: null, phone: null
        };

        if (tempBillingDetails) {
          finalBillingType = tempBillingDetails.company_name ? 'corporate' : 'passenger';
          billData.name = tempBillingDetails.display_name;
          billData.company = tempBillingDetails.company_name;
          billData.address = tempBillingDetails.address;
          billData.gst = tempBillingDetails.gst_number;
          billData.email = tempBillingDetails.email;
          billData.phone = tempBillingDetails.phone;
        } else if (billingId) {
          const acc = billingAccounts.find(a => a.id == billingId);
          if (acc) {
            finalBillingType = acc.company_name ? 'corporate' : 'passenger';
            billData.name = acc.contact_name || acc.display_name;
            billData.company = acc.company_name;
            billData.address = acc.address;
            billData.gst = acc.gst_number;
            billData.email = acc.email;
            billData.phone = acc.phone;
          }
        } else if (document.getElementById('billingSearchInput').value.trim()) {
          // Fallback: use manual unsaved input (Simple Bill To)
          const manualName = document.getElementById('billingSearchInput').value.trim();
          finalBillingType = 'passenger';
          billData.name = manualName;
        }

        // Determine supplier details
        const supplierId = document.getElementById('supplierAccountSelect').value;
        const supData = {
          name: null, email: null, phone: null, address: null, company: null, gst: null
        };

        if (tempSupplierDetails) {
          supData.name = tempSupplierDetails.display_name;
          supData.email = tempSupplierDetails.email;
          supData.phone = tempSupplierDetails.phone;
          supData.address = tempSupplierDetails.address;
          supData.company = tempSupplierDetails.company_name;
          supData.gst = tempSupplierDetails.gst_number;
        } else if (supplierId) {
          const acc = supplierAccounts.find(a => a.id == supplierId);
          if (acc) {
            supData.name = acc.display_name;
            supData.email = acc.email;
            supData.phone = acc.phone;
            supData.address = acc.address;
            supData.company = acc.company_name;
            supData.gst = acc.gst_number;
          }
        }

        // Determine trip type from radio buttons
        let tripType = 'one_way';
        const tripRadio = document.querySelector('input[name="tripType"]:checked');
        if (tripRadio) tripType = tripRadio.value;

        // Capture raw input state for edit capability
        const rawInputData = { mode: tripType };
        try {
          const textareas = document.querySelectorAll('textarea');
          rawInputData.flight_texts = Array.from(textareas).map(ta => ta.value);
        } catch (e) { }

        const payload = {
          title: title,
          reference_number: document.getElementById('saveReferenceNumber') ? document.getElementById('saveReferenceNumber').value : '',
          trip_type: tripType,
          passenger_id: firstDbPassenger ? firstDbPassenger.id : null,
          billing_account_id: billingId || null,
          supplier_account_id: supplierId || null,
          num_passengers: savePassengers.length || 1,
          passengers_data: savePassengers,
          // Flight Data
          flights: currentFlights,
          final_text: currentFinalText,
          raw_input_data: rawInputData,
          // Costing
          markup: parseFloat(document.getElementById('markup').value) || 0,
          service_charge: parseFloat(document.getElementById('serviceCharge').value) || 0,
          total_amount: calculateTotalAmount(),
          // Explicit Billing Details
          bill_to_name: billData.name,
          bill_to_company: billData.company,
          bill_to_address: billData.address,
          bill_to_gst: billData.gst,
          bill_to_email: billData.email,
          bill_to_phone: billData.phone,
          billing_type: finalBillingType,
          // Explicit Supplier Details
          supplier_name: supData.name,
          supplier_email: supData.email,
          supplier_phone: supData.phone,
          supplier_address: supData.address,
          supplier_company: supData.company,
          supplier_gst: supData.gst
        };

        // If editing existing itinerary, update it; otherwise create new
        const isEditing = !!editingItineraryId;
        const apiUrl = isEditing ? '/api/v2/itineraries/' + editingItineraryId : '/api/v2/itineraries';
        const method = isEditing ? 'PUT' : 'POST';

        const response = await fetch(apiUrl, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          const itinId = result.itinerary ? result.itinerary.id : editingItineraryId;
          showNotification(isEditing ? 'Itinerary updated successfully!' : 'Itinerary saved successfully!', 'success');
          closeSaveModal();
          localStorage.removeItem('flight_itinerary_draft');

          // Redirect to the itinerary detail
          setTimeout(() => {
            window.location.href = '/itineraries' + (itinId ? '#' + itinId : '');
          }, 1500);
        } else {
          const err = await response.json();
          showNotification(err.error || 'Failed to save itinerary', 'error');
        }
      } catch (e) {
        console.error(e);
        showNotification('Error saving itinerary', 'error');
      } finally {
        btn.disabled = false;
        text.style.display = 'inline';
        loading.style.display = 'none';
      }
    }

    // --- Modal Logic ---
    let warningModalResolve = null;
    let deleteModalResolve = null;

    function showWarningModal(message) {
      if (message) {
        document.getElementById('warningMessage').textContent = message;
      }
      document.getElementById('warningModal').classList.add('is-active');
      return new Promise((resolve) => {
        warningModalResolve = resolve;
      });
    }

    function closeWarningModal(result) {
      document.getElementById('warningModal').classList.remove('is-active');
      if (warningModalResolve) {
        warningModalResolve(result);
        warningModalResolve = null;
      }
    }

    // --- Saved Itinerary Modal Logic ---
    let savedModalResolve = null;

    function showSavedItineraryModal() {
      document.getElementById('savedItineraryModal').classList.add('is-active');
      return new Promise((resolve) => {
        savedModalResolve = resolve;
      });
    }

    function closeSavedItineraryModal(shouldRedirect) {
      document.getElementById('savedItineraryModal').classList.remove('is-active');
      document.body.style.overflow = '';
      if (savedModalResolve) {
        savedModalResolve(shouldRedirect);
        savedModalResolve = null;
      }
    }

    function showDeleteModal(title, message) {
      if (title) document.getElementById('deleteModalTitle').textContent = title;
      if (message) document.getElementById('deleteModalMessage').textContent = message;
      document.getElementById('deleteModal').classList.add('show');
      return new Promise((resolve) => {
        deleteModalResolve = resolve;
      });
    }

    function closeDeleteModal(result) {
      document.getElementById('deleteModal').classList.remove('show');
      if (deleteModalResolve) {
        deleteModalResolve(result);
        deleteModalResolve = null;
      }
    }

    // Handle trip type changes
    function handleTripType() {
      const tripType = document.querySelector('input[name="tripType"]:checked').value;
      currentTripType = tripType;

      // Reset all flight inputs
      const flightInputs = document.getElementById('flightInputs');
      flightInputs.innerHTML = '';
      unitCount = 0;
      flightCount = 0;
      unitFlightCounts = {};
      unitFlights = {};

      const addUnitBtn = document.getElementById('addUnitBtn');

      if (tripType === 'one_way') {
        addUnitBtn.style.display = 'inline-flex';
        document.getElementById('addUnitLabel').textContent = 'Add Another Option';
        addUnit();
      } else if (tripType === 'round_trip') {
        addUnitBtn.style.display = 'inline-flex';
        document.getElementById('addUnitLabel').textContent = 'Add Another Option';
        addUnit();
      } else if (tripType === 'multi_city') {
        addUnitBtn.style.display = 'inline-flex';
        document.getElementById('addUnitLabel').textContent = 'Add Another Option';
        addUnit();
      }
    }

    // Add a unit based on trip type
    function addUnit() {
      unitCount++;
      const container = document.getElementById('flightInputs');
      const unit = document.createElement('div');
      unit.className = 'flight-unit';
      unit.dataset.unitId = unitCount;

      if (currentTripType === 'one_way') {
        // One Way: 1 unit = 1 flight + shared fares
        unit.innerHTML = createOneWayUnit(unitCount);
      } else if (currentTripType === 'round_trip') {
        // Round Trip: 1 unit = 2 flights (outbound + return) + shared fares
        unit.className += ' row';
        unit.innerHTML = createRoundTripUnit(unitCount);
      } else if (currentTripType === 'multi_city') {
        // Multi City: 1 unit = 1 flight initially, can add more with "Add City" button
        unit.className += ' multi';
        unit.innerHTML = createMultiCityUnit(unitCount);
      }

      container.appendChild(unit);

      // Initialize fares for the new unit
      initializeUnitFares(unitCount);
    }

    function createOneWayUnit(unitId) {
      const flightId = ++flightCount;
      unitFlights[unitId] = [flightId];

      return `
    ${unitId > 1 ? `<div class="flight-unit-header"><h3>Option ${unitId}</h3><button type="button" onclick="removeUnit(${unitId})">ðŸ—‘ï¸ Remove Option</button></div>` : ''}
    ${createFlightBox(flightId, 'Departure', true)}
    ${createSharedFareSection(unitId)}
  `;
    }

    function createRoundTripUnit(unitId) {
      const outboundId = ++flightCount;
      const returnId = ++flightCount;
      unitFlights[unitId] = [outboundId, returnId];

      return `
    ${unitId > 1 ? `<div class="flight-unit-header"><h3>Option ${unitId}</h3><button type="button" onclick="removeUnit(${unitId})">ðŸ—‘ï¸ Remove Option</button></div>` : ''}
    ${createFlightBox(outboundId, 'Outbound Flight')}
    ${createFlightBox(returnId, 'Return Flight')}
    
    <div class="fare-split-control" style="width: 100%; clear: both; margin: 1.5rem 0 1rem 0; padding: 0 0.25rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; cursor: pointer;">
            <input type="checkbox" id="split-fares-toggle-${unitId}" onchange="toggleSplitFares(${unitId})">
            <span>Separate Fares for Outbound & Return</span>
        </label>
    </div>

    <div id="fares-combined-wrapper-${unitId}">
        ${createSharedFareSection(unitId, '', 'ðŸ“Š Fare Options (Combined)')}
    </div>

    <div id="fares-split-wrapper-${unitId}" style="display: none; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            ${createSharedFareSection(unitId, '_out', 'âœˆï¸ Outbound Fares')}
        </div>
        <div style="flex: 1; min-width: 300px;">
             ${createSharedFareSection(unitId, '_ret', 'âœˆï¸ Return Fares')}
        </div>
    </div>
  `;
    }

    function toggleSplitFares(unitId) {
      const toggle = document.getElementById(`split-fares-toggle-${unitId}`);
      const combinedWrapper = document.getElementById(`fares-combined-wrapper-${unitId}`);
      const splitWrapper = document.getElementById(`fares-split-wrapper-${unitId}`);

      if (toggle && toggle.checked) {
        combinedWrapper.style.display = 'none';
        splitWrapper.style.display = 'flex';
      } else {
        combinedWrapper.style.display = 'block';
        splitWrapper.style.display = 'none';
      }
    }

    function createMultiCityUnit(unitId) {
      const flightId = ++flightCount;
      unitFlights[unitId] = [flightId];
      unitFlightCounts[unitId] = 1;

      return `
    <div class="flight-unit-header"><h3>Option ${unitId}</h3><button type="button" onclick="addCityToUnit(${unitId})">âž• Add City</button>${unitId > 1 ? `<button type="button" onclick="removeUnit(${unitId})">ðŸ—‘ï¸ Remove Option</button>` : ''}</div>
    <div id="unit-${unitId}-flights" style="display: contents;">
      ${createFlightBox(flightId, `City 1`)}
    </div>
    ${createSharedFareSection(unitId)}
  `;
    }

    function createFlightBox(flightId, label, showMultipleFlights = false) {
      const multipleFlightsCheckbox = showMultipleFlights ? `
        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; font-size: 0.85rem;">
            <input type="checkbox" class="multiple-flights-checkbox">
            <span>Multiple Flights</span>
        </label>
      ` : '';

      return `
    <div class="flight-block" data-flight-id="${flightId}">
      <div class="flight-header">
        <span class="flight-number">${label}</span>
        <div style="display: flex; gap: 1rem;">
            <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; font-size: 0.85rem;">
                <input type="checkbox" class="layover-checkbox">
                <span>Has Layover</span>
            </label>
            ${multipleFlightsCheckbox}
        </div>
      </div>
      
      <div class="textarea-wrapper">
        <label class="textarea-label">Paste Flight Details (include price if available)</label>
        <textarea placeholder="Paste complete flight information here...
Example: 
Airline: IndiGo
Flight: 6E-123
Departure: Mumbai (BOM) - 10:30 AM
Arrival: Delhi (DEL) - 12:45 PM
Date: 28 Jan 2026
Duration: 2h 15m
Stops: Non-stop
Baggage: 15 Kg
Refundable
Price: â‚¹5,500

For Multiple Flights: Paste each flight's details separated by a blank line."></textarea>
      </div>
    </div>
  `;
    }

    function createSharedFareSection(unitId, suffix = '', labelOverride = '') {
      const isOneWay = currentTripType === 'one_way';
      let headingText = '';

      if (labelOverride) {
        headingText = labelOverride;
      } else {
        headingText = isOneWay ? `Fare Options (Option ${unitId})` : `ðŸ“Š Fare Options for Option ${unitId}`;
      }

      const sectionId = `fare-section-${unitId}${suffix}`;
      const listId = `fare-list-${unitId}${suffix}`;

      return `
    <div class="shared-fare-section expanded" id="${sectionId}" data-unit-id="${unitId}" data-suffix="${suffix}">
      <div class="fare-section-header" onclick="toggleFareSection('${unitId}', '${suffix}')">
          <h4 style="margin: 0;">${headingText}</h4>
          <span class="fare-toggle-icon">â–¼</span>
      </div>
      
      <div class="fare-section-content" id="fare-content-${unitId}${suffix}">
        <div class="fare-types" id="${listId}">
          ${createFareCard('saver', 'Saver Fare', unitId, true, suffix)}
        </div>
        <div class="add-fare-controls" style="margin-top: 1rem; border-top: 1px dashed var(--border); padding-top: 0.75rem;">
           <select class="form-select" style="width: 100%; max-width: 200px; padding: 0.5rem; font-size: 0.9rem; border-radius: 6px; border: 1.5px solid var(--border);" onchange="handleAddFareType(this, ${unitId}, '${suffix}')">
               <option value="">+ Add Fare Type...</option>
               <optgroup label="Fare Types">
                   <option value="corporate">Corporate Fare</option>
                   <option value="sme">SME Fare</option>
                   <option value="coupon">Coupon Fare</option>
                   <option value="flexi">Flexi Fare</option>
               </optgroup>
               <optgroup label="Cabin Classes">
                   <option value="economy">Economy</option>
                   <option value="premium_economy">Premium Economy</option>
                   <option value="business">Business Class</option>
                   <option value="first">First Class</option>
               </optgroup>
               <option value="custom">Custom...</option>
           </select>
        </div>
      </div>
    </div>
  `;
    }

    function formatBaggageInput(input) {
      let val = input.value.trim();
      // If value is just a number (integer or decimal), append 'kg'
      if (/^\d+(\.\d+)?$/.test(val)) {
        input.value = val + 'kg';
      }
    }

    function formatPiecesInput(input) {
      let val = input.value.trim();
      // If value is just a number (integer), append 'pcs'
      if (/^\d+$/.test(val)) {
        input.value = val + 'pcs';
      }
    }


    function toggleFareSection(unitId, suffix = '') {
      const section = document.getElementById(`fare-section-${unitId}${suffix}`);
      if (section) section.classList.toggle('expanded');
    }

    function toggleFareDetails(fareUniqueId) {
      const details = document.getElementById(fareUniqueId);
      const icon = document.getElementById(`fare-toggle-icon-${fareUniqueId}`);
      if (!details) return;

      if (details.style.display === 'none') {
        details.style.display = 'block';
        if (icon) icon.style.transform = 'rotate(180deg)';
      } else {
        details.style.display = 'none';
        if (icon) icon.style.transform = 'rotate(0deg)';
      }
    }

    function createFareCard(key, label, unitId, isChecked, suffix = '') {
      const checkedAttr = isChecked ? 'checked' : '';
      const disabledAttr = isChecked ? '' : 'disabled';
      const cardClass = isChecked ? 'fare-card' : 'fare-card disabled';
      const uniqueKey = `${key}-unit-${unitId}${suffix}`;
      const detailsId = `fare-details-input-${uniqueKey}`;

      return `
        <div class="${cardClass}" data-fare-key="${key}" id="fare-card-${uniqueKey}">
          <div class="fare-card-header">
            <input type="checkbox" id="chk-${uniqueKey}" onchange="toggleFareCard(this, '${key}', ${unitId}, '${suffix}')" ${checkedAttr}>
            <label for="chk-${uniqueKey}">${label}</label>
          </div>
          <div class="fare-card-fields">
            <div class="fare-field-row">
              <span class="fare-field-label">Fare</span>
              <input type="number" class="fare-field-input fare-${uniqueKey}" placeholder="${key === 'saver' ? 'Auto / Manual' : 'â‚¹ 0'}" min="0" ${disabledAttr}>
            </div>
            <div class="fare-field-row">
              <span class="fare-field-label">MU</span>
              <input type="number" class="fare-field-input mu-${uniqueKey}" placeholder="Markup" min="0" ${disabledAttr}>
            </div>
            <div class="fare-field-row">
              <span class="fare-field-label">SVC</span>
              <input type="number" class="fare-field-input svc-${uniqueKey}" placeholder="SVC" min="0" ${disabledAttr}>
            </div>
          </div>
          
          <div class="fare-extras-toggle" style="margin-top: 10px; border-top: 1px solid var(--border); padding-top: 8px;">
            <button type="button" onclick="toggleFareDetails('${detailsId}')" style="background: none; border: none; color: var(--primary); font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 0;">
              <span>âž• Add Baggage & Extras</span>
              <span id="fare-toggle-icon-${detailsId}" style="transition: transform 0.3s ease;">â–¼</span>
            </button>
          </div>
          
          <div id="${detailsId}" style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.02); border-radius: 6px;">
             <!-- Baggage -->
             <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Cabin</label>
                   <input type="text" class="form-input fare-cabin-${uniqueKey}" placeholder="7kg" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatBaggageInput(this)">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Check-in</label>
                   <input type="text" class="form-input fare-checkin-${uniqueKey}" placeholder="15kg" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatBaggageInput(this)">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Pieces</label>
                   <input type="text" class="form-input fare-pcs-${uniqueKey}" placeholder="2pcs" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatPiecesInput(this)">
                </div>
             </div>
             <!-- Meal / Seat -->
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Seat</label>
                   <input type="text" class="form-input fare-seat-${uniqueKey}" placeholder="A12" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Meal</label>
                   <input type="text" class="form-input fare-meal-${uniqueKey}" placeholder="Veg" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
             </div>
             <!-- Charges -->
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Cancel</label>
                   <input type="text" class="form-input fare-cancellation-${uniqueKey}" placeholder="3000" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Change</label>
                   <input type="text" class="form-input fare-penalty-${uniqueKey}" placeholder="5000" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
             </div>
          </div>
        </div>
      `;
    }

    function toggleFareCard(checkbox, fareType, unitId, suffix = '') {
      const uniqueKey = `${fareType}-unit-${unitId}${suffix}`;
      const card = document.getElementById(`fare-card-${uniqueKey}`);
      const fareInput = document.querySelector(`.fare-${uniqueKey}`);
      const muInput = document.querySelector(`.mu-${uniqueKey}`);
      const svcInput = document.querySelector(`.svc-${uniqueKey}`);

      if (checkbox.checked) {
        card.classList.remove('disabled');
        if (fareInput) fareInput.disabled = false;
        if (muInput) muInput.disabled = false;
        if (svcInput) svcInput.disabled = false;
      } else {
        card.classList.add('disabled');
        if (fareInput) fareInput.disabled = true;
        if (muInput) muInput.disabled = true;
        if (svcInput) svcInput.disabled = true;
        if (fareInput) fareInput.value = '';
        if (muInput) muInput.value = '';
        if (svcInput) svcInput.value = '';
      }

      // Check if we need global markup
      updateGlobalMarkupRequirement();
    }

    function updateGlobalMarkupRequirement() {
      // Check if all checked fare types have MU filled
      let allHaveMU = true;
      let anyChecked = false;

      document.querySelectorAll('.fare-card').forEach(card => {
        const checkbox = card.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          anyChecked = true;
          const fareKey = card.dataset.fareKey;
          const section = card.closest('.shared-fare-section');
          if (section) {
            const unitId = section.dataset.unitId;
            const suffix = section.dataset.suffix || '';
            const uniqueKey = `${fareKey}-unit-${unitId}${suffix}`;
            const muInput = document.querySelector(`.mu-${uniqueKey}`);
            if (!muInput || !muInput.value || muInput.value.trim() === '') {
              allHaveMU = false;
            }
          }
        }
      });

      const globalMarkupSection = document.getElementById('globalMarkupSection');
      if (globalMarkupSection) {
        if (anyChecked && allHaveMU) {
          globalMarkupSection.style.opacity = '0.5';
          globalMarkupSection.querySelector('.input-label').innerHTML = 'Global Markup (â‚¹) <span style="color: var(--success); font-size: 0.8rem;">- Not required (all fares have MU)</span>';
        } else {
          globalMarkupSection.style.opacity = '1';
          globalMarkupSection.querySelector('.input-label').innerHTML = 'Global Markup (â‚¹)';
        }
      }
    }

    function handleAddFareType(select, unitId, suffix = '') {
      const val = select.value;
      if (!val) return;

      let key = val;
      const cabinLabels = {
        'economy': 'Economy',
        'premium_economy': 'Premium Economy',
        'business': 'Business Class',
        'first': 'First Class'
      };

      let label = cabinLabels[val] || (val.charAt(0).toUpperCase() + val.slice(1).replace('_', ' ') + ' Fare');

      if (val === 'custom') {
        const customName = prompt("Enter Name for Custom Fare Type:");
        if (!customName || customName.trim() === '') {
          select.value = '';
          return;
        }
        label = customName.trim();
        key = label.toLowerCase().replace(/\s+/g, '_');
      }

      // Check if exists
      const uniqueKey = `${key}-unit-${unitId}${suffix}`;
      if (document.getElementById(`fare-card-${uniqueKey}`)) {
        showNotification('Fare type already exists', 'warning');
        select.value = '';
        return;
      }

      appendFareRow(unitId, key, label, suffix);
      select.value = '';
    }

    function appendFareRow(unitId, key, label, suffix = '') {
      const list = document.getElementById(`fare-list-${unitId}${suffix}`);
      const div = document.createElement('div');
      div.innerHTML = createFareCard(key, label, unitId, true, suffix);
      list.appendChild(div.firstElementChild);

      // Check if we need global markup
      updateGlobalMarkupRequirement();
    }

    function initializeUnitFares(unitId) {
      // Can add initialization logic here if needed
    }

    function addCityToUnit(unitId) {
      const cityCount = (unitFlightCounts[unitId] || 1) + 1;
      unitFlightCounts[unitId] = cityCount;
      const flightId = ++flightCount;

      if (!unitFlights[unitId]) {
        unitFlights[unitId] = [];
      }
      unitFlights[unitId].push(flightId);

      const container = document.querySelector(`#unit-${unitId}-flights`);
      const flightBox = document.createElement('div');
      flightBox.innerHTML = createFlightBox(flightId, `City ${cityCount}`);
      container.appendChild(flightBox.firstElementChild);
    }

    async function removeUnit(unitId) {
      const remainingUnits = document.querySelectorAll('.flight-unit');
      if (remainingUnits.length <= 1) {
        showNotification('You must have at least one option', 'warning');
        return;
      }

      const confirmed = await showDeleteModal('Remove Option', 'Are you sure you want to remove this Entire Option? All nested flights and fares will be lost.');
      if (!confirmed) return;

      const unit = document.querySelector(`[data-unit-id="${unitId}"]`) || document.getElementById(`unit-${unitId}`)?.closest('.flight-unit');
      if (unit) {
        unit.remove();
      }

      // Cleanup mappings
      delete unitFlights[unitId];
      delete unitFlightCounts[unitId];

      // Re-index remaining units' visual labels
      const currentUnits = document.querySelectorAll('.flight-unit');
      currentUnits.forEach((u, idx) => {
        const header = u.querySelector('.flight-unit-header h3');
        if (header) {
          header.textContent = `Option ${idx + 1}`;
        }
      });

      showNotification('Option removed', 'success');
    }

    function toggleUnitFare(checkbox, fareType, unitId) {
      const input = document.querySelector(`.fare-${fareType}-unit-${unitId}`);
      input.disabled = !checkbox.checked;
      if (!checkbox.checked) {
        input.value = '';
      }
    }

    async function parseFlights() {
      if (isParsing) {
        showNotification('Parsing already in progress', 'warning');
        return;
      }

      const markup = document.getElementById("markup").value.trim();
      const serviceChargeInput = document.getElementById("serviceCharge").value.trim();

      // Validation - markup is optional, default to 0 if not entered
      const markupValue = markup === '' ? 0 : Number(markup);
      if (Number.isNaN(markupValue) || markupValue < 0) {
        showNotification('Please enter a valid markup amount', 'error');
        document.getElementById("markup").focus();
        return;
      }

      currentMarkup = markupValue;

      // Service Charge
      const svcValue = serviceChargeInput === '' ? 0 : Number(serviceChargeInput);
      currentServiceCharge = svcValue;
      currentGST = svcValue > 0 ? Math.round(svcValue * 0.18) : 0;

      let hasError = false;
      const flights = [];
      const flightTexturesByUnit = {}; // Map unit IDs to their flight texts and fares

      // Check if any markup is specified anywhere (per-fare or global)
      let hasAnyMarkup = markupValue > 0;
      if (!hasAnyMarkup) {
        // Check for per-fare markups
        document.querySelectorAll('.fare-card').forEach(card => {
          const checkbox = card.querySelector('.fare-card-header input[type="checkbox"]');
          if (checkbox && checkbox.checked) {
            const fareKey = card.dataset.fareKey;
            const section = card.closest('.shared-fare-section');
            if (section) {
              const unitId = section.dataset.unitId;
              const muInput = card.querySelector(`.mu-${fareKey}-unit-${unitId}`);
              if (muInput && muInput.value && muInput.value.trim() !== '' && Number(muInput.value) > 0) {
                hasAnyMarkup = true;
              }
            }
          }
        });
      }

      // Warn if no markup anywhere
      if (!hasAnyMarkup) {
        const proceed = await showWarningModal('Are you sure you want to proceed without adding any markup?');
        if (!proceed) {
          document.getElementById('markup').focus();
          return;
        }
      }

      // Process each unit
      // IMPORTANT: flightUnits needs to be defined/collected correctly
      // Previously, we iterate through unitFlights to build flights. 
      // Actually, looking at code in 2388+, we iterate Object.entries(unitFlights).

      Object.entries(unitFlights).forEach(([unitId, flightIds]) => {
        // Helper to collect fares from a specific list (suffix)
        const collectFares = (suffix) => {
          const fares = {};
          const mus = {};
          const svcs = {};
          const fareExtras = {}; // New object for extra details
          const fareCards = document.querySelectorAll(`#fare-list-${unitId}${suffix} .fare-card`);

          let localError = false;

          fareCards.forEach(card => {
            const checkbox = card.querySelector('.fare-card-header input[type="checkbox"]');
            if (!checkbox || !checkbox.checked) return;

            const fareKey = card.dataset.fareKey;
            const uniqueKey = `${fareKey}-unit-${unitId}${suffix}`;

            const fareInput = card.querySelector(`.fare-${uniqueKey}`);
            const muInput = card.querySelector(`.mu-${uniqueKey}`);
            const svcInput = card.querySelector(`.svc-${uniqueKey}`);

            // Collecting extra fields per fare
            const cabinInp = card.querySelector(`.fare-cabin-${uniqueKey}`);
            const checkinInp = card.querySelector(`.fare-checkin-${uniqueKey}`);
            const pcsInp = card.querySelector(`.fare-pcs-${uniqueKey}`);
            const seatInp = card.querySelector(`.fare-seat-${uniqueKey}`);
            const mealInp = card.querySelector(`.fare-meal-${uniqueKey}`);
            const cancelInp = card.querySelector(`.fare-cancellation-${uniqueKey}`);
            const penInp = card.querySelector(`.fare-penalty-${uniqueKey}`);

            if (fareKey === 'saver') {
              if (fareInput && fareInput.value && fareInput.value.trim() !== '') {
                fares[fareKey] = Number(fareInput.value);
              } else {
                fares[fareKey] = null; // Auto-extract
              }
            } else {
              if (!fareInput || !fareInput.value || fareInput.value.trim() === '' || Number(fareInput.value) < 0) {
                const label = card.querySelector('.fare-card-header label')?.textContent || fareKey;
                showNotification(`Please enter amount for ${label} in Option ${unitId}`, 'error');
                if (fareInput) fareInput.focus();
                localError = true;
                hasError = true;
              } else {
                fares[fareKey] = Number(fareInput.value);
              }
            }

            if (muInput && muInput.value && muInput.value.trim() !== '') {
              mus[fareKey] = Number(muInput.value);
            }
            if (svcInput && svcInput.value && svcInput.value.trim() !== '') {
              svcs[fareKey] = Number(svcInput.value);
            }

            // Only store extra if at least one field is filled
            if (cabinInp?.value || checkinInp?.value || pcsInp?.value || seatInp?.value || mealInp?.value || cancelInp?.value || penInp?.value) {
              fareExtras[fareKey] = {
                baggage_cabin: cabinInp?.value?.trim(),
                baggage_checkin: checkinInp?.value?.trim(),
                baggage_pcs: pcsInp?.value?.trim(),
                seat: seatInp?.value?.trim(),
                meal: mealInp?.value?.trim(),
                cancellation_charges: cancelInp?.value?.trim(),
                penalty_charges: penInp?.value?.trim()
              };
            }
          });

          // Check if at least one fare is selected (if saver not auto-selected)
          // Simplified: If no fares and no saver checked, error.
          // Actually, we rely on the loop above. If fares is empty and 'saver' is not in checked cards...
          // But we iterate over *selected* cards.
          // So just check if fares is empty.
          // However, we need to know if saver was checked.
          // If completely empty -> Error.
          if (Object.keys(fares).length === 0) {
            // Exception: User might want to proceed without fares? 
            // Existing logic allowed proceeding if saver was checked (auto-extract).
            // My logic above adds 'saver': null if checked. So it won't be empty.
            // If completely empty -> Error.
            showNotification(`Please select at least one fare type for Option ${unitId}`, 'error');
            localError = true;
            hasError = true;
          }

          return { fares, mus, svcs, fareExtras, error: localError };
        };

        const isSplit = document.getElementById(`split-fares-toggle-${unitId}`)?.checked;
        let outboundData = null;
        let returnData = null;
        let sharedData = null;

        if (isSplit && flightIds.length === 2) {
          outboundData = collectFares('_out');
          returnData = collectFares('_ret');
          // If error, hasError is already true
        } else {
          sharedData = collectFares('');
        }

        flightIds.forEach((flightId, idx) => {
          const block = document.querySelector(`[data-flight-id="${flightId}"]`);
          if (!block) return;

          const text = block.querySelector("textarea").value.trim();
          const hasLayover = block.querySelector(".layover-checkbox")?.checked || false;
          const isMultiple = block.querySelector(".multiple-flights-checkbox")?.checked || false;

          if (!text) {
            showNotification(`Please paste flight details for flight #${flightId}`, 'error');
            hasError = true;
            return;
          }

          let faresToUse = {};
          let muToUse = {};
          let svcToUse = {};
          let extrasToUse = {};

          if (isSplit && flightIds.length === 2) {
            if (idx === 0 && outboundData) { // Outbound
              faresToUse = outboundData.fares;
              muToUse = outboundData.mus;
              svcToUse = outboundData.svcs;
              extrasToUse = outboundData.fareExtras;
            } else if (idx === 1 && returnData) { // Return
              faresToUse = returnData.fares;
              muToUse = returnData.mus;
              svcToUse = returnData.svcs;
              extrasToUse = returnData.fareExtras;
            }
          } else if (sharedData) {
            faresToUse = sharedData.fares;
            muToUse = sharedData.mus;
            svcToUse = sharedData.svcs;
            extrasToUse = sharedData.fareExtras;
          }

          flightTexturesByUnit[unitId] = flightTexturesByUnit[unitId] || [];
          flightTexturesByUnit[unitId].push(text);

          flights.push({
            text: text,
            fares: faresToUse,
            fare_mu: muToUse,
            fare_svc: svcToUse,
            fare_extra_details: extrasToUse,
            has_layover: hasLayover,
            is_multiple: isMultiple,
            is_split: isSplit, // Track if unit was split
            unitId: unitId
          });
        });
      });

      if (hasError || flights.length === 0) {
        return;
      }

      // Pre-validation for layover flights - prompt user if info seems incomplete
      for (const flight of flights) {
        if (flight.has_layover) {
          const text = flight.text.toLowerCase();

          // Check for minimum layover indicators
          const hasMultipleTimes = (text.match(/\d{1,2}[:\.]?\d{2}\s*(am|pm)?/gi) || []).length >= 4;
          const hasMultipleCities = (text.match(/\b[A-Z]{3}\b/g) || []).length >= 3;
          const hasLayoverKeywords = /layover|via|connect|stop|transit/i.test(text);

          if (!hasMultipleTimes && !hasMultipleCities && !hasLayoverKeywords) {
            const shouldContinue = confirm(
              `âš ï¸ Layover Flight Info Check\n\n` +
              `The layover checkbox is checked, but we couldn't detect:\n` +
              `â€¢ Multiple departure/arrival times (need at least 4)\n` +
              `â€¢ Multiple airport codes (need at least 3)\n` +
              `â€¢ Layover keywords (via, connecting, transit)\n\n` +
              `For accurate layover parsing, please ensure your text includes:\n` +
              `â€¢ Each segment's departure and arrival times\n` +
              `â€¢ Each segment's departure and arrival cities/airports\n` +
              `â€¢ Layover city and duration (if known)\n\n` +
              `Click OK to continue anyway, or Cancel to edit the input.`
            );

            if (!shouldContinue) {
              return;
            }
          }
        }
      }

      // Start parsing
      isParsing = true;
      const parseBtn = document.getElementById('parseBtn');
      const parseIcon = document.getElementById('parseIcon');
      const parseBtnText = document.getElementById('parseBtnText');

      parseBtn.disabled = true;
      parseIcon.innerHTML = '<span class="loading"></span>';
      parseBtnText.textContent = 'Processing...';

      document.getElementById("cards").innerHTML = '';
      document.getElementById("cardsSection").style.display = 'none';
      document.getElementById("outputSection").style.display = 'none';

      try {
        // Send flight texts and their selected fares
        // If saver is checked but empty, parser will try to extract it from text
        const response = await fetch("/parse", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            flights: flights.map(f => f.text),
            fares: flights.map(f => f.fares), // Send user-selected fares for each flight
            fare_mu: flights.map(f => f.fare_mu || {}),  // Per-fare markups
            fare_svc: flights.map(f => f.fare_svc || {}), // Per-fare service charges
            fare_extra_details: flights.map(f => f.fare_extra_details || {}), // Per-fare extra details
            layover_flags: flights.map(f => f.has_layover),
            multiple_flight_flags: flights.map(f => f.is_multiple),
            markup: Number(markup),
            global_svc: svcValue
          })
        });

        const data = await response.json();

        if (!response.ok) {
          showNotification(data.error || 'Failed to parse flights', 'error');
          return;
        }

        // Update the saver fare inputs with extracted values if any
        let flightIndex = 0;
        Object.entries(unitFlights).forEach(([unitId, flightIds]) => {
          let extractedSaverFare = null;

          // Check if any flight in this unit has extracted saver fare
          for (let i = 0; i < flightIds.length; i++) {
            if (flightIndex + i < data.flights.length) {
              const flight = data.flights[flightIndex + i];
              // Check if saver fare was extracted or provided
              if (flight.fares && flight.fares.saver) {
                extractedSaverFare = flight.fares.saver;
                break;
              }
            }
          }

          // If we found a saver fare and the input is empty, auto-fill it
          if (extractedSaverFare) {
            const saverInput = document.querySelector(`.fare-saver-unit-${unitId}`);
            if (saverInput && (!saverInput.value || saverInput.value.trim() === '')) {
              saverInput.value = extractedSaverFare;
              showNotification(`Auto-filled Saver Fare (â‚¹${extractedSaverFare.toLocaleString('en-IN')}) for Option ${unitId}`, 'success');
            }
          }

          flightIndex += flightIds.length;
        });

        // Apply SVC and GST to all flights
        data.flights.forEach(f => {
          f.service_charge = currentServiceCharge;
          f.gst = currentGST;
        });

        // Promote single-fare extras and split flag to results
        data.flights.forEach((f, i) => {
          const userFlight = flights[i];
          if (userFlight) {
            f.is_split = userFlight.is_split; // Propagate split flag
            if (userFlight.fare_extra_details) {
              const fareKeys = Object.keys(userFlight.fares || {});
              if (fareKeys.length === 1) {
                const singleFareType = fareKeys[0];
                const extras = userFlight.fare_extra_details[singleFareType];
                if (extras) {
                  // Copy properties to the main flight object for timeline rendering
                  f.baggage_cabin = extras.baggage_cabin || f.baggage_cabin;
                  f.baggage_checkin = extras.baggage_checkin || f.baggage_checkin;
                  f.baggage_pcs = extras.baggage_pcs || f.baggage_pcs;
                  f.meal = extras.meal || f.meal;
                  f.seat = extras.seat || f.seat;
                  f.cancellation_charges = extras.cancellation_charges || f.cancellation_charges;
                  f.penalty_charges = extras.penalty_charges || f.penalty_charges;
                }
              }
            }
          }
        });

        currentFlights = data.flights;
        // Reset edit mode to false by default for new parse results
        isGlobalEditMode = false;
        renderResults(data.flights);
        showNotification('Flights parsed successfully!', 'success');

      } catch (error) {
        showNotification('Error parsing flights. Please try again.', 'error');
        console.error(error);
      } finally {
        isParsing = false;
        parseBtn.disabled = false;
        parseIcon.innerHTML = 'ðŸš€';
        parseBtnText.textContent = 'Parse Flights & Generate Itinerary';
      }
    }

    function renderResults(flights) {
      if (!flights || flights.length === 0) {
        return;
      }

      // Collect all parse errors for a global notification
      const allErrorsSet = new Set();
      flights.forEach(f => {
        if (f.parse_errors) {
          f.parse_errors.forEach(err => allErrorsSet.add(err));
        }
      });
      if (allErrorsSet.size > 0) {
        const consolidatedErrors = Array.from(allErrorsSet).join(' â€¢ ');
        showNotification(`Input Issue Detected: ${consolidatedErrors}`, 'warning');
      }

      // Show sections
      document.getElementById("cardsSection").style.display = 'block';
      document.getElementById("outputSection").style.display = 'block';

      // Render cards with unit grouping
      const cardsContainer = document.getElementById("cards");
      cardsContainer.innerHTML = '';

      // Check if any flight is editable - show global edit controls
      const hasEditableFlights = flights.some(f => f.is_editable);
      const globalEditControls = document.getElementById('globalEditControls');
      if (hasEditableFlights) {
        globalEditControls.style.display = 'flex';
        globalEditControls.style.gap = '0.5rem';

        // Update button state to reflect current mode
        const globalEditBtn = document.getElementById('globalEditBtn');
        if (isGlobalEditMode) {
          globalEditBtn.innerHTML = 'âœ• Cancel Edit';
          globalEditBtn.classList.add('active');
        } else {
          globalEditBtn.innerHTML = 'âœï¸ Edit Fares';
          globalEditBtn.classList.remove('active');
        }
      } else {
        globalEditControls.style.display = 'none';
        isGlobalEditMode = false;
      }

      // Group flights by unit for display
      let flightIndex = 0;
      Object.entries(unitFlights).forEach(([unitId, flightIds]) => {
        if (currentTripType === 'round_trip' || currentTripType === 'multi_city') {
          const unitContainer = document.createElement('div');
          unitContainer.style.marginBottom = '2rem';
          unitContainer.style.width = '100%';

          const unitHeader = document.createElement('h4');
          unitHeader.style.marginBottom = '1rem';
          unitHeader.style.color = 'var(--primary)';
          unitHeader.style.paddingBottom = '0.5rem';
          unitHeader.style.borderBottom = '2px solid var(--primary)';
          unitHeader.textContent = (currentTripType === 'round_trip' ? 'Round Trip Option ' : 'Multi-City Option ') + unitId;
          unitContainer.appendChild(unitHeader);

          const cardsWrapper = document.createElement('div');
          cardsWrapper.className = 'cards-wrapper';

          // For round trip, we want to combine 2 flights into one card if possible
          if (currentTripType === 'round_trip' && flightIds.length === 2) {
            const outbound = flights[flightIndex];
            const returnFlight = flights[flightIndex + 1];
            if (outbound && returnFlight) {
              const combinedCard = createRoundTripCardWithEditButton(outbound, returnFlight, flightIndex, unitId);
              cardsWrapper.appendChild(combinedCard);
              flightIndex += 2;
            }
          } else if (currentTripType === 'multi_city') {
            // Multi-City Combined Card
            const optionFlights = flights.slice(flightIndex, flightIndex + flightIds.length);
            if (optionFlights.length > 0) {
              const combinedCard = createMultiCityCardWithEditButton(optionFlights, flightIndex, unitId);
              cardsWrapper.appendChild(combinedCard);
              flightIndex += flightIds.length;
            }
          } else {
            // Malformed data fallback: render individual cards
            flightIds.forEach(() => {
              if (flightIndex < flights.length) {
                const flight = flights[flightIndex];
                const card = createCardWithEditButton(flight, flightIndex);
                cardsWrapper.appendChild(card);
                flightIndex++;
              }
            });
          }

          unitContainer.appendChild(cardsWrapper);
          cardsContainer.appendChild(unitContainer);
        } else {
          // One Way
          if (unitId === Object.keys(unitFlights)[0]) {
            for (let fi = 0; fi < flights.length; fi++) {
              cardsContainer.appendChild(createCardWithEditButton(flights[fi], fi));
            }
            flightIndex = flights.length;
          }
        }
      });

      // Render output text using the consolidated logic
      regenerateOutputText();

      // Scroll to results
      document.getElementById("cardsSection").scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function isFieldValid(val) {
      if (!val) return false;
      const s = String(val).trim().toLowerCase();
      return s !== '' && s !== 'n/a' && s !== 'null' && s !== 'undefined' && s !== 'unknown' && s !== 'not specified';
    }

    function getTimeCategory(timeStr) {
      if (!timeStr || timeStr === 'N/A') return '';
      const parts = timeStr.split(':');
      if (parts.length < 2) return '';

      const hour = parseInt(parts[0], 10);

      if (hour >= 0 && hour < 6) return 'Early Morning Flight';
      if (hour >= 6 && hour < 12) return 'Morning Flight';
      if (hour >= 12 && hour < 16) return 'Afternoon Flight';
      if (hour >= 16 && hour < 21) return 'Evening Flight';
      if (hour >= 21) return 'Night Flight';

      return '';
    }

    function generateFlightSummaryHTML(flight, index, uniqueId) {
      // Helper to safely display values - never show undefined, null, N/A
      const safe = (val, fallback = '') => {
        if (val === undefined || val === null || val === 'N/A' || val === 'Not Specified' || val === 'undefined' || val === 'null') {
          return fallback;
        }
        return val;
      };

      const airlineName = safe(flight.airline, 'Airline');
      const flightNumber = safe(flight.flight_number, '');
      const depTime = safe(flight.departure_time, '--:--');
      const arrTime = safe(flight.arrival_time, '--:--');
      const depCity = safe(flight.departure_city, '');
      const arrCity = safe(flight.arrival_city, '');
      const depAirport = safe(flight.departure_airport, '');
      const arrAirport = safe(flight.arrival_airport, '');
      const duration = safe(flight.duration, '--');
      const daysOffset = flight.days_offset || 0;
      const hasSegments = flight.segments && flight.segments.length > 0;
      const displayStops = safe(flight.stops, hasSegments ? `${flight.segments.length - 1} Stop(s)` : 'Direct');
      const isDirect = displayStops.toLowerCase().includes('non-stop') || displayStops.toLowerCase().includes('direct') || (flight.segments && flight.segments.length <= 1);
      const isMissingDate = !flight.departure_date || flight.departure_date === 'N/A';

      // Helper for city display
      const formatCity = (city, airport) => {
        if (!city) return airport || '';
        if (airport && city.includes(airport)) return city;
        if (airport && city.trim() === airport.trim()) return city;
        return `${city} <span class="airport-code-small">(${airport || ''})</span>`;
      };

      return `
        <div class="flight-summary" onclick="toggleDetails('${uniqueId}')">
            <div class="summary-main">
                <div class="summary-airline">
                    <div class="airline-stack">
                        ${(hasSegments && !isDirect)
          ? flight.segments.map(s => `
                              <div class="airline-row">
                                <span class="airline-name-small">${safe(s.airline, 'Airline')}</span>
                                <span class="flight-code-small">${safe(s.flight_number, '')}</span>
                              </div>
                            `).join('')
          : `
                              <div class="airline-name">${airlineName}</div>
                              <div class="flight-code">${flightNumber}</div>
                            `
        }
                    </div>
                    <div id="date-display-${index}" class="summary-date" style="font-size: 0.8rem; font-weight: 600; color: #2563eb; margin-top: 0.25rem;">${isMissingDate ? '' : flight.departure_date}</div>
                </div>
                
                <div class="flight-route-visual">
                    <div class="time-group">
                        <div class="time-big">${depTime}</div>
                        <div class="city-code">${formatCity(depCity, depAirport)}</div>
                    </div>
                    
                    <div class="duration-line-container">
                        <div class="duration-text">${duration}</div>
                        <div class="route-line"></div>
                        <div class="stops-text ${isDirect ? 'direct' : ''}">${displayStops}</div>
                    </div>
                    
                    <div class="time-group">
                        <div class="time-big">${arrTime}${daysOffset > 0 ? `<sup style="color: #f59e0b; font-size: 0.7rem; font-weight: 600; margin-left: 2px;">+${daysOffset}</sup>` : ''}</div>
                        <div class="city-code">${formatCity(arrCity, arrAirport)}</div>
                    </div>
                </div>
            </div>
            <div class="expand-icon" id="arrow-${uniqueId}"></div>
        </div>
      `;
    }

    function generateFareSpecificDetailsHTML(details) {
      const { baggage_cabin, baggage_checkin, baggage_pcs, meal, seat, cancellation_charges, penalty_charges } = details;

      const hasBaggage = baggage_cabin || baggage_checkin || baggage_pcs;
      const hasExtras = meal || seat;
      const hasCharges = cancellation_charges || penalty_charges;

      if (!hasBaggage && !hasExtras && !hasCharges) return '';

      let html = '<div style="display: flex; flex-direction: column; gap: 0.85rem;">';

      // Baggage Grid
      if (hasBaggage) {
        html += `
          <div>
            <div style="font-size: 0.65rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.05em;">Baggage</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                ${baggage_cabin ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Cabin</small><span>${baggage_cabin}</span></div>` : ''}
                ${baggage_checkin ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Check-in</small><span>${baggage_checkin}</span></div>` : ''}
                ${baggage_pcs ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Pieces</small><span>${baggage_pcs}</span></div>` : ''}
            </div>
          </div>
        `;
      }

      // Extras Grid
      if (hasExtras) {
        html += `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
             ${meal ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Meal</small><span style="font-size: 0.85rem;">${meal}</span></div>` : ''}
             ${seat ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Seat</small><span style="font-size: 0.85rem;">${seat}</span></div>` : ''}
          </div>
        `;
      }

      // Charges Grid
      if (hasCharges) {
        html += `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
             ${details.cancellation_charges ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Cancellation</small><span style="font-weight:600; font-size:0.85rem; color:var(--danger);">${details.cancellation_charges} <small style="font-weight:400; color:var(--text-secondary);">+GST</small></span></div>` : ''}
             ${details.penalty_charges ? `<div><small style="color:var(--text-secondary); display:block; font-size: 0.6rem;">Change Penalty</small><span style="font-weight:600; font-size:0.85rem; color:var(--warning);">${details.penalty_charges} <small style="font-weight:400; color:var(--text-secondary);">+GST</small></span></div>` : ''}
          </div>
        `;
      }

      html += '</div>';
      return html;
    }

    function generateFlightTimelineHTML(flight, index, uniqueId) {
      const numFares = Object.keys(flight.fares || {}).length;

      // Helper to safely display values - never show undefined, null, N/A
      const safe = (val, fallback = '') => {
        if (val === undefined || val === null || val === 'N/A' || val === 'Not Specified' || val === 'undefined' || val === 'null') {
          return fallback;
        }
        return val;
      };

      const depTime = safe(flight.departure_time, '--:--');
      const arrTime = safe(flight.arrival_time, '--:--');
      const depCity = safe(flight.departure_city, '');
      const arrCity = safe(flight.arrival_city, '');
      const depAirport = safe(flight.departure_airport, '');
      const arrAirport = safe(flight.arrival_airport, '');
      const airlineName = safe(flight.airline, 'Airline');
      const flightNumber = safe(flight.flight_number, '');
      const duration = safe(flight.duration, '--');
      const baggage = safe(flight.baggage, '');

      const hasSegments = flight.segments && flight.segments.length > 0;
      const displayStops = safe(flight.stops, 'Direct');
      const isDirect = displayStops.toLowerCase().includes('non-stop') || displayStops.toLowerCase().includes('direct') || (flight.segments && flight.segments.length <= 1);

      const formatCity = (city, airport) => {
        if (!city) return airport || '';
        if (airport && city.includes(airport)) return city;
        if (airport && city.trim() === airport.trim()) return city;
        return `${city} <span class="airport-code-small">(${airport || ''})</span>`;
      };

      const calculateTimeDiff = (startTime, endTime) => {
        if (!startTime || !endTime) return null;
        try {
          const parseTime = (t) => {
            const parts = t.match(/(\d+):(\d+)\s*(AM|PM)?/i);
            if (!parts) return null;
            let h = parseInt(parts[1], 10);
            const m = parseInt(parts[2], 10);
            const p = parts[3] ? parts[3].toUpperCase() : null;
            if (p === 'PM' && h < 12) h += 12;
            if (p === 'AM' && h === 12) h = 0;
            return h * 60 + m;
          };
          const startMins = parseTime(startTime);
          const endMins = parseTime(endTime);
          if (startMins === null || endMins === null) return null;
          let diff = endMins - startMins;
          if (diff < 0) diff += 24 * 60;
          const hours = Math.floor(diff / 60);
          const minutes = diff % 60;
          let text = '';
          if (hours > 0) text += `${hours}h `;
          if (minutes > 0) text += `${minutes}m`;
          return { text: text.trim(), minutes: diff };
        } catch (e) { return null; }
      };

      const getLayoverLabel = (minutes) => {
        if (minutes < 60) return { label: 'Short Layover', alertClass: 'short' };
        if (minutes > 300) return { label: 'Long Wait', alertClass: 'long' };
        return { label: 'Layover', alertClass: '' };
      };

      const AIRPORT_TIMEZONES = {
        'CCU': 5.5, 'DEL': 5.5, 'BOM': 5.5, 'BLR': 5.5, 'MAA': 5.5, 'HYD': 5.5, 'AMD': 5.5, 'PNQ': 5.5, 'GOI': 5.5, 'COK': 5.5, 'GAU': 5.5, 'PAT': 5.5,
        'SIN': 8, 'BKK': 7, 'HKG': 8, 'KUL': 8, 'NRT': 9, 'HND': 9, 'ICN': 9, 'PEK': 8, 'PVG': 8, 'CMB': 5.5, 'DAC': 6, 'KTM': 5.75,
        'DXB': 4, 'DOH': 3, 'AUH': 4, 'BAH': 3, 'KWI': 3, 'MCT': 4,
        'LHR': 0, 'CDG': 1, 'FRA': 1, 'AMS': 1, 'FCO': 1, 'IST': 3,
        'JFK': -5, 'LAX': -8, 'SFO': -8, 'ORD': -6, 'YYZ': -5,
        'SYD': 10, 'MEL': 10, 'AKL': 12
      };

      const calculateSegmentDurationWithTimezone = (depT, arrT, depA, arrA) => {
        if (!depT || !arrT) return 'N/A';
        try {
          const parseTime = (t) => {
            const parts = t.match(/(\d+):(\d+)\s*(AM|PM)?/i);
            if (!parts) return null;
            let h = parseInt(parts[1], 10);
            const m = parseInt(parts[2], 10);
            const p = parts[3] ? parts[3].toUpperCase() : null;
            if (p === 'PM' && h < 12) h += 12;
            if (p === 'AM' && h === 12) h = 0;
            return h * 60 + m;
          };
          const dm = parseTime(depT);
          const am = parseTime(arrT);
          if (dm === null || am === null) return 'N/A';
          const dtz = AIRPORT_TIMEZONES[depA?.toUpperCase()] || 5.5;
          const atz = AIRPORT_TIMEZONES[arrA?.toUpperCase()] || 5.5;
          const td = Math.round((atz - dtz) * 60);
          let ad = am - dm;
          if (ad < 0) ad += 24 * 60;
          let actual = ad - td;
          if (actual < 0) actual += 24 * 60;
          if (actual > 24 * 60) actual -= 24 * 60;
          const hrs = Math.floor(actual / 60);
          const mins = actual % 60;
          return `${hrs}h ${mins}m`;
        } catch (e) { return 'N/A'; }
      };

      let html = `<div id="timeline-${uniqueId}" class="flight-timeline-container" style="display: none;">`;
      html += '<div class="flight-timeline">';

      if (hasSegments && !isDirect) {
        flight.segments.forEach((seg, i) => {
          const nextSeg = flight.segments[i + 1];
          let segmentDuration = seg.duration;
          if (!segmentDuration || segmentDuration === 'Duration n/a' || segmentDuration === 'N/A') {
            segmentDuration = calculateSegmentDurationWithTimezone(seg.departure_time, seg.arrival_time, seg.departure_airport, seg.arrival_airport);
          }
          const sAir = safe(seg.airline, safe(flight.airline, 'Airline'));
          const sNum = safe(seg.flight_number, '');
          const sDT = safe(seg.departure_time, '--:--');
          const sAT = safe(seg.arrival_time, '--:--');
          const sDC = safe(seg.departure_city, safe(seg.departure_airport, 'Departure'));
          const sAC = safe(seg.arrival_city, safe(seg.arrival_airport, 'Arrival'));
          const sDA = safe(seg.departure_airport, '');
          const sAA = safe(seg.arrival_airport, '');
          const sDur = safe(segmentDuration, '--');
          const sBag = safe(flight.baggage, '');

          html += `
                        <div class="timeline-segment">
                        <div class="t-dot departure"></div>
                        ${(i === flight.segments.length - 1) ? '<div class="t-dot arrival"></div>' : ''}
                        <div class="t-time-row">
                            <div class="t-time">${sDT}${seg.accumulated_dep_days > 0 ? `<sup style="color: #f59e0b; font-size: 0.65rem; font-weight: 600; margin-left: 2px;">+${seg.accumulated_dep_days}</sup>` : ''}</div>
                            <div class="t-city">${formatCity(sDC, sDA)}</div>
                        </div>
                        <div class="flight-info-block">
                            <div class="info-row">
                                 <div class="info-icon">âœˆ</div>
                                 <span style="font-weight: 600; color: var(--text-primary);">${sAir} ${sNum}</span>
                            </div>
                            <div class="info-row" style="flex-wrap: wrap; gap: 0.5rem 1.25rem;">
                                 <div class="info-icon">â±</div>
                                 <span>${sDur}</span>
                            </div>
                        </div>
                        <div class="t-time-row">
                            <div class="t-time" style="color: var(--text-secondary); font-size: 1rem;">${sAT}${(seg.accumulated_arr_days || seg.days_offset) > 0 ? `<sup style="color: #f59e0b; font-size: 0.65rem; font-weight: 600; margin-left: 2px;">+${seg.accumulated_arr_days || seg.days_offset}</sup>` : ''}</div>
                            <div class="t-city" style="font-weight: 500; color: var(--text-secondary); font-size: 0.95rem;">${formatCity(sAC, sAA)}</div>
                        </div>
                    </div>
                 `;

          if (nextSeg) {
            let dText = safe(nextSeg.layover_duration, '');
            let lText = 'Layover';
            if (!dText) {
              const lDiff = calculateTimeDiff(seg.arrival_time, nextSeg.departure_time);
              if (lDiff) { dText = lDiff.text; lText = getLayoverLabel(lDiff.minutes).label; }
            } else {
              const dM = dText.match(/(\d+)h\s*(\d+)?m?/);
              if (dM) lText = getLayoverLabel(parseInt(dM[1]) * 60 + (parseInt(dM[2]) || 0)).label;
            }
            const lDA = safe(nextSeg.departure_airport, '');
            const lDC = safe(nextSeg.departure_city, lDA);
            html += `
                        <div class="layover-container">
                            <div class="layover-icon-box" title="Layover">
                                <img src="/static/travel.png" alt="Airport">
                            </div>
                            <div class="layover-pill"><span>â±</span><span>${lText} in ${lDC} â€¢ ${dText}</span></div>
                        </div>
                    `;
          }
        });
      } else {
        html += `
                <div class="timeline-segment">
                    <div class="t-dot departure"></div>
                    <div class="t-time-row">
                        <div class="t-time">${depTime}</div>
                        <div class="t-city">${formatCity(depCity, depAirport)}</div>
                    </div>
                    <div class="flight-info-block">
                        <div class="info-row">
                             <div class="info-icon">âœˆ</div>
                             <span style="font-weight: 600; color: var(--text-primary);">${airlineName} ${flightNumber}</span>
                        </div>
                        ${duration && duration !== '--' ? `<div class="info-row"><div class="info-icon">â±</div><span>${duration}</span></div>` : ''}
                    </div>

                    <div class="t-dot arrival"></div>
                    <div class="t-time-row">
                        <div class="t-time">${arrTime}</div>
                        <div class="t-city">${formatCity(arrCity, arrAirport)}</div>
                    </div>
                </div>
            `;
      }

      html += '</div></div>';
      return html;
    }

    function createFlightCard(flight, index) {
      const card = document.createElement('div');
      card.className = 'flight-card';
      card.setAttribute('data-flight-index', index);
      const uniqueId = `flight-${index}-${Math.random().toString(36).substr(2, 9)}`;

      const isMissingDate = !flight.departure_date || flight.departure_date === 'N/A';
      const optionLabelHTML = `<div class="option-label">Option ${index + 1}</div>`;

      let dateHeaderHTML = '';
      if (isMissingDate) {
        dateHeaderHTML = `<div class="date-warning-strip" id="date-warning-${index}"><span>âš ï¸ Date Required</span><button class="date-btn" onclick="promptDateInput(${index})">Select Date</button></div>`;
      }

      const summaryHTML = generateFlightSummaryHTML(flight, index, uniqueId);
      const timelineHTML = generateFlightTimelineHTML(flight, index, uniqueId);

      const faresHTML = generateFaresFooterHTML(flight);

      // Inline editor placeholder
      let inlineEditorPlaceholder = '';
      if (flight.is_editable) {
        inlineEditorPlaceholder = `<div id="inline-editor-${index}" class="inline-fare-editor" style="display: none;"></div>`;
      }

      card.innerHTML = optionLabelHTML + dateHeaderHTML + summaryHTML + timelineHTML + faresHTML + inlineEditorPlaceholder;
      return card;
    }

    function generateFaresFooterHTML(flight, variant = '') {
      let extraClass = '';
      if (variant === 'outbound') extraClass = ' fare-footer-outbound';
      else if (variant === 'return') extraClass = ' fare-footer-return';

      const numFares = Object.keys(flight.fares || {}).length;

      let faresHTML = `<div class="card-footer-fares${extraClass}">`;
      Object.entries(flight.fares).forEach(([type, base]) => {
        const perFareMU = flight.fare_mu && flight.fare_mu[type] !== undefined ? flight.fare_mu[type] : (flight.markup || 0);
        const finalFare = base + perFareMU;
        const perFareSVC = flight.fare_svc && flight.fare_svc[type] !== undefined ? flight.fare_svc[type] : (flight.service_charge || 0);
        const perFareGST = perFareSVC > 0 ? Math.round(perFareSVC * 0.18) : 0;
        let extraText = '';
        if (perFareSVC > 0) {
          extraText = ` <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: normal;">(+ â‚¹${perFareSVC} SVC + â‚¹${perFareGST} GST)</span>`;
        }

        const fareUniqueId = `fare-${type}-${Math.random().toString(36).substr(2, 5)}`;

        // Decide which details to show in the collapsible
        let detailsToRender = (flight.fare_extra_details && flight.fare_extra_details[type]) || {};

        // If single fare, ensure we have the main baggage/extra info if not already there
        if (numFares === 1) {
          detailsToRender = { ...detailsToRender };
          if (!detailsToRender.baggage_cabin && flight.baggage_cabin) detailsToRender.baggage_cabin = flight.baggage_cabin;
          if (!detailsToRender.baggage_checkin && flight.baggage_checkin) detailsToRender.baggage_checkin = flight.baggage_checkin;
          if (!detailsToRender.baggage_pcs && flight.baggage_pcs) detailsToRender.baggage_pcs = flight.baggage_pcs;
          if (!detailsToRender.meal && flight.meal) detailsToRender.meal = flight.meal;
          if (!detailsToRender.seat && flight.seat) detailsToRender.seat = flight.seat;
          if (!detailsToRender.cancellation_charges && flight.cancellation_charges) detailsToRender.cancellation_charges = flight.cancellation_charges;
          if (!detailsToRender.penalty_charges && flight.penalty_charges) detailsToRender.penalty_charges = flight.penalty_charges;
        }

        const fareDetailsHTML = generateFareSpecificDetailsHTML(detailsToRender);
        const hasClickableDetails = fareDetailsHTML.trim().length > 0;

        faresHTML += `
              <div class="footer-fare-item" ${hasClickableDetails ? `onclick="toggleFareDetails('${fareUniqueId}')" style="cursor:pointer;"` : ''}>
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <span class="footer-fare-label">${type}</span>
                    ${hasClickableDetails ? `<span id="fare-toggle-icon-${fareUniqueId}" style="font-size:0.7rem; color:var(--text-secondary); transition: transform 0.3s ease;">â–¼</span>` : ''}
                </div>
                <span class="footer-fare-price">â‚¹ ${finalFare.toLocaleString('en-IN')}${extraText}</span>
                
                ${hasClickableDetails ? `
                <div id="${fareUniqueId}" class="fare-details-collapsible" style="display:none; width:100%; margin-top:0.5rem; border-top:1px solid var(--border); padding-top:0.5rem; text-align: left;">
                    ${fareDetailsHTML}
                </div>
                ` : ''}
              </div>
            `;
      });
      faresHTML += '</div>';
      return faresHTML;
    }

    function createRoundTripFlightCard(outbound, returnFlight, index, unitId) {
      const card = document.createElement('div');
      card.className = 'flight-card combined-flight-card';
      card.setAttribute('data-flight-index', index);

      const outUniqueId = `flight-${index}-out-${Math.random().toString(36).substr(2, 4)}`;
      const retUniqueId = `flight-${index}-ret-${Math.random().toString(36).substr(2, 4)}`;

      const optionLabelHTML = `<div class="option-label">Option ${unitId}</div>`;

      // Outbound Section
      const outSummary = generateFlightSummaryHTML(outbound, index, outUniqueId);
      const outTimeline = generateFlightTimelineHTML(outbound, index, outUniqueId);

      // Return Section
      const retSummary = generateFlightSummaryHTML(returnFlight, index + 1, retUniqueId);
      const retTimeline = generateFlightTimelineHTML(returnFlight, index + 1, retUniqueId);

      // Date warnings
      let dateHeaderHTML = '';
      if ((!outbound.departure_date || outbound.departure_date === 'N/A')) {
        dateHeaderHTML += `<div class="date-warning-strip" id="date-warning-${index}"><span>âš ï¸ Outbound Date Required</span><button class="date-btn" onclick="promptDateInput(${index})">Select</button></div>`;
      }
      if ((!returnFlight.departure_date || returnFlight.departure_date === 'N/A')) {
        dateHeaderHTML += `<div class="date-warning-strip" id="date-warning-${index + 1}"><span>âš ï¸ Return Date Required</span><button class="date-btn" onclick="promptDateInput(${index + 1})">Select</button></div>`;
      }

      // Dividers and Labels
      const outLabel = '<div class="combined-label">Outbound</div>';
      const retLabel = '<div class="combined-label" style="background:var(--secondary);">Return</div>';
      const divider = '<div class="flight-divider"></div>';

      // Check if fares are split
      // We perform a deep comparison of the fares objects to determine if they are identical
      const areFaresInitiallySame = (f1, f2) => {
        const k1 = Object.keys(f1).sort();
        const k2 = Object.keys(f2).sort();
        if (k1.length !== k2.length) return false;
        if (!k1.every((key, i) => key === k2[i])) return false;
        return k1.every(key => f1[key] === f2[key]);
      };

      // Only show split layout if:
      // 1. User original choice was split (is_split)
      // 2. OR the fares are actually different (fallback)
      const areFaresDifferent = (outbound.is_split === true) || !areFaresInitiallySame(outbound.fares, returnFlight.fares);

      let html = optionLabelHTML + dateHeaderHTML;

      if (areFaresDifferent) {
        // Split Layout
        const outFares = generateFaresFooterHTML(outbound, 'outbound');
        const retFares = generateFaresFooterHTML(returnFlight, 'return');

        html += outLabel + outSummary + outTimeline + outFares + divider + retLabel + retSummary + retTimeline + retFares;
      } else {
        // Combined Layout
        const faresHTML = generateFaresFooterHTML(outbound); // Use outbound as shared source
        html += outLabel + outSummary + outTimeline + divider + retLabel + retSummary + retTimeline + faresHTML;
      }

      // Editor placeholders
      if (outbound.is_editable) html += `<div id="inline-editor-${index}" class="inline-fare-editor" style="display: none;"></div>`;
      if (returnFlight.is_editable) html += `<div id="inline-editor-${index + 1}" class="inline-fare-editor" style="display: none;"></div>`;

      card.innerHTML = html;
      return card;
    }

    function createRoundTripCardWithEditButton(outbound, returnFlight, index, unitId) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';
      wrapper.style.marginBottom = '1.5rem';

      if (outbound.is_editable || returnFlight.is_editable) {
        const editBar = document.createElement('div');
        editBar.className = 'card-edit-bar';
        editBar.id = `card-edit-bar-${index}`;
        editBar.style.display = isGlobalEditMode ? 'flex' : 'none';
        editBar.innerHTML = `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="card-edit-btn" onclick="toggleInlineFareEditor(${index})" id="edit-btn-${index}">
                        âœï¸ Edit Fares
                    </button>
                    <button class="card-delete-btn" onclick="deleteFlightOption(${index})" title="Delete This Option">
                        ðŸ—‘ï¸
                    </button>
                </div>
            `;
        wrapper.appendChild(editBar);
      }

      const card = createRoundTripFlightCard(outbound, returnFlight, index, unitId);
      wrapper.appendChild(card);
      return wrapper;
    }

    function createMultiCityFlightCard(flightList, startIndex, unitId) {
      const card = document.createElement('div');
      card.className = 'flight-card combined-flight-card';
      card.setAttribute('data-flight-index', startIndex);

      const optionLabelHTML = `<div class="option-label">Option ${unitId}</div>`;
      let contentHTML = optionLabelHTML;

      flightList.forEach((flight, i) => {
        const flightIndex = startIndex + i;
        const uniqueId = `flight-${flightIndex}-mc-${Math.random().toString(36).substr(2, 4)}`;

        const isMissingDate = !flight.departure_date || flight.departure_date === 'N/A';
        if (isMissingDate) {
          contentHTML += `<div class="date-warning-strip" id="date-warning-${flightIndex}"><span>âš ï¸ Date Required for Flight ${i + 1}</span><button class="date-btn" onclick="promptDateInput(${flightIndex})">Select</button></div>`;
        }

        const label = `<div class="combined-label">Flight ${i + 1}</div>`;
        const summary = generateFlightSummaryHTML(flight, flightIndex, uniqueId);
        const timeline = generateFlightTimelineHTML(flight, flightIndex, uniqueId);
        const divider = i < flightList.length - 1 ? '<div class="flight-divider"></div>' : '';

        contentHTML += label + summary + timeline + divider;
      });

      // Use fares from the first flight (shared for the option)
      const faresHTML = generateFaresFooterHTML(flightList[0]);

      // Editor placeholders
      let editorHTML = '';
      flightList.forEach((f, i) => {
        if (f.is_editable) editorHTML += `<div id="inline-editor-${startIndex + i}" class="inline-fare-editor" style="display: none;"></div>`;
      });

      card.innerHTML = contentHTML + faresHTML + editorHTML;
      return card;
    }

    function createMultiCityCardWithEditButton(flightList, startIndex, unitId) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';
      wrapper.style.marginBottom = '1.5rem';

      const anyEditable = flightList.some(f => f.is_editable);

      if (anyEditable) {
        const editBar = document.createElement('div');
        editBar.className = 'card-edit-bar';
        editBar.id = `card-edit-bar-${startIndex}`;
        editBar.style.display = isGlobalEditMode ? 'flex' : 'none';
        editBar.innerHTML = `
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="card-edit-btn" onclick="toggleInlineFareEditor(${startIndex})" id="edit-btn-${startIndex}">
                        âœï¸ Edit Fares
                    </button>
                    <button class="card-delete-btn" onclick="deleteFlightOption(${startIndex})" title="Delete This Option">
                        ðŸ—‘ï¸
                    </button>
                </div>
            `;
        wrapper.appendChild(editBar);
      }

      const card = createMultiCityFlightCard(flightList, startIndex, unitId);
      wrapper.appendChild(card);
      return wrapper;
    }

    // Creates a wrapper with edit button above the card
    function createCardWithEditButton(flight, index) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';
      wrapper.style.marginBottom = '0.75rem';

      // Add edit button above card if editable (hidden by default, shown in global edit mode)
      if (flight.is_editable) {
        const editBar = document.createElement('div');
        editBar.className = 'card-edit-bar';
        editBar.id = `card-edit-bar-${index}`;
        // Initially hidden - will be shown when global edit mode is activated
        editBar.style.display = isGlobalEditMode ? 'flex' : 'none';
        editBar.innerHTML = `
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="card-edit-btn" onclick="toggleInlineFareEditor(${index})" id="edit-btn-${index}">
              âœï¸ Edit
            </button>
            <button class="card-delete-btn" onclick="deleteFlightOption(${index})" title="Delete This Option">
              ðŸ—‘ï¸
            </button>
          </div>
        `;
        wrapper.appendChild(editBar);
      }

      // Add the flight card
      const card = createFlightCard(flight, index);
      wrapper.appendChild(card);

      return wrapper;
    }

    // Toggle global edit mode for all cards
    function toggleGlobalEditMode() {
      isGlobalEditMode = !isGlobalEditMode;

      const globalEditBtn = document.getElementById('globalEditBtn');

      // Find all card edit bars and toggle their visibility
      currentFlights.forEach((flight, index) => {
        if (flight.is_editable) {
          const editBar = document.getElementById(`card-edit-bar-${index}`);
          if (editBar) {
            editBar.style.display = isGlobalEditMode ? 'flex' : 'none';
          }
          // If turning off edit mode, hide any open editors and reset their buttons
          if (!isGlobalEditMode) {
            const editor = document.getElementById(`inline-editor-${index}`);
            if (editor) {
              editor.style.display = 'none';
              // Reset edit button state
              const editBtn = document.getElementById(`edit-btn-${index}`);
              if (editBtn) {
                editBtn.innerHTML = 'âœï¸ Edit';
                editBtn.classList.remove('active');
              }
            }
          }
        }
      });

      if (isGlobalEditMode) {
        globalEditBtn.innerHTML = 'âœ• Cancel Edit';
        globalEditBtn.classList.add('active');
      } else {
        globalEditBtn.innerHTML = 'âœï¸ Edit Fares';
        globalEditBtn.classList.remove('active');
      }
    }

    // createSegmentsHTML is no longer used separately, integrated into createFlightCard
    function createSegmentsHTML(flight) { return ''; }

    // ============== Inline Fare Editor Functions ==============

    function toggleInlineFareEditor(flightIndex) {
      const editor = document.getElementById(`inline-editor-${flightIndex}`);
      const editBtn = document.getElementById(`edit-btn-${flightIndex}`);

      if (!editor) return;

      if (editor.style.display === 'none') {
        // Show editor
        editor.style.display = 'block';
        editBtn.innerHTML = 'âœ• Cancel';
        editBtn.classList.add('active');

        // Populate editor with current fare data
        populateInlineFareEditor(flightIndex);
      } else {
        // Hide editor
        editor.style.display = 'none';
        editBtn.innerHTML = 'âœï¸ Edit';
        editBtn.classList.remove('active');
      }
    }

    function populateInlineFareEditor(flightIndex) {
      const flight = currentFlights[flightIndex];
      const editor = document.getElementById(`inline-editor-${flightIndex}`);

      if (!editor || !flight) return;

      const isRoundTrip = currentTripType === 'round_trip' && currentFlights[flightIndex + 1];
      let isSplit = false;
      let returnFlight = null;

      if (isRoundTrip) {
        returnFlight = currentFlights[flightIndex + 1];
        // Deep compare fares to see if split
        const areFaresSame = (f1, f2) => {
          const k1 = Object.keys(f1).sort();
          const k2 = Object.keys(f2).sort();
          if (k1.length !== k2.length) return false;
          if (!k1.every((key, i) => key === k2[i])) return false;
          return k1.every(key => f1[key] === f2[key]);
        };
        // Use flag if set, otherwise check content
        isSplit = (flight.is_split === true) || !areFaresSame(flight.fares, returnFlight.fares);
      }

      // Helper to generate a section
      const generateSectionHTML = (fData, fIdx, suffix, title, displayStyle = 'block', hideFares = false) => {
        let html = `<div id="inline-section-${fIdx}${suffix}" style="display: ${displayStyle}; margin-bottom: 1.5rem;">`;
        if (title) html += `<h5 style="margin: 0 0 0.5rem 0; color: var(--text-secondary); border-bottom: 1px dashed var(--border); padding-bottom: 0.25rem;">${title}</h5>`;

        // Add Date Editor
        const dateVal = (!fData.departure_date || fData.departure_date === 'N/A') ? '' : fData.departure_date;
        html += `
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; display: block; margin-bottom: 4px;">Departure Date</label>
                <input type="text" class="form-input inline-date-${fIdx}${suffix}" placeholder="e.g. 12 Feb 26" value="${dateVal}" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
            </div>
        `;

        let faresHTML = '';
        Object.entries(fData.fares).forEach(([fareType, baseFare]) => {
          let mu = fData.fare_mu && fData.fare_mu[fareType] !== undefined ? fData.fare_mu[fareType] : '';
          let svc = fData.fare_svc && fData.fare_svc[fareType] !== undefined ? fData.fare_svc[fareType] : '';
          let extras = fData.fare_extra_details && fData.fare_extra_details[fareType] ? fData.fare_extra_details[fareType] : {};

          // Fallback to global if empty
          if ((mu === '' || mu === undefined) && currentMarkup > 0) mu = currentMarkup;
          if ((svc === '' || svc === undefined) && currentServiceCharge > 0) svc = currentServiceCharge;

          const cabinLabels = {
            'economy': 'Economy',
            'premium_economy': 'Premium Economy',
            'business': 'Business Class',
            'first': 'First Class'
          };
          let label = cabinLabels[fareType] || (fareType.charAt(0).toUpperCase() + fareType.slice(1).replace('_', ' ') + ' Fare');

          faresHTML += createInlineFareCard(fIdx, fareType, label, baseFare, mu, svc, extras, true, suffix);
        });

        const faresStyle = hideFares ? 'display: none;' : '';

        html += `<div class="fare-types" id="inline-fare-list-${fIdx}${suffix}" style="${faresStyle}">${faresHTML}</div>`;

        html += `
            <div class="add-fare-controls" id="inline-fare-controls-${fIdx}${suffix}" style="margin-top: 0.5rem; padding-top: 0.5rem; ${faresStyle}">
               <select class="form-select" style="width: 100%; max-width: 200px; padding: 0.4rem; font-size: 0.85rem; border-radius: 6px; border: 1.5px solid var(--border);" onchange="handleInlineAddFareType(this, ${fIdx}, '${suffix}')">
                 <option value="">+ Add Fare Type...</option>
                 <optgroup label="Fare Types">
                     <option value="corporate">Corporate Fare</option>
                     <option value="sme">SME Fare</option>
                     <option value="coupon">Coupon Fare</option>
                     <option value="flexi">Flexi Fare</option>
                 </optgroup>
                 <optgroup label="Cabin Classes">
                     <option value="economy">Economy</option>
                     <option value="premium_economy">Premium Economy</option>
                     <option value="business">Business Class</option>
                     <option value="first">First Class</option>
                 </optgroup>
                 <option value="custom">Custom...</option>
               </select>
            </div>
          </div>`;
        return html;
      };

      let contentHTML = `
        <div class="inline-fare-editor-header">
          <h4>âœï¸ Edit Fares for Option ${Math.floor(flightIndex / 2) + 1}</h4> <!-- Approximation for unit ID -->
        </div>`;

      if (isRoundTrip) {
        contentHTML += `
            <div style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
               <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; cursor: pointer; font-size: 0.9rem;">
                  <input type="checkbox" id="inline-split-toggle-${flightIndex}" onchange="toggleInlineSplit(${flightIndex})" ${isSplit ? 'checked' : ''}>
                  <span>Separate Fares for Outbound & Return</span>
               </label>
            </div>
          `;

        contentHTML += generateSectionHTML(flight, flightIndex, '_out', isSplit ? 'âœˆï¸ Outbound Fares' : 'ðŸ“Š Combined Fares');
        contentHTML += generateSectionHTML(returnFlight, flightIndex, '_ret', 'âœˆï¸ Return Fares', 'block', !isSplit); // Always show section for Date, hide fares if !isSplit
      } else {
        // Normal One-Way / Multi-City (Single List)
        contentHTML += generateSectionHTML(flight, flightIndex, '', '');
      }

      contentHTML += `
        <div class="inline-fare-editor-actions">
          <button class="btn-cancel" onclick="toggleInlineFareEditor(${flightIndex})">Cancel</button>
          <button class="btn-save" onclick="saveInlineFareChanges(${flightIndex})">ðŸ’¾ Save Changes</button>
        </div>
      `;

      editor.innerHTML = contentHTML;
    }

    function toggleInlineSplit(flightIndex) {
      const toggle = document.getElementById(`inline-split-toggle-${flightIndex}`);
      // Return section is now ALWAYS visible (for Date), but we toggle Fares visibility
      const retFareList = document.getElementById(`inline-fare-list-${flightIndex}_ret`);
      const retControls = document.getElementById(`inline-fare-controls-${flightIndex}_ret`);
      const outHeader = document.querySelector(`#inline-section-${flightIndex}_out h5`);

      if (toggle && toggle.checked) {
        // Show Return Fares
        if (retFareList) retFareList.style.display = 'block';
        if (retControls) retControls.style.display = 'block';
        if (outHeader) outHeader.textContent = 'âœˆï¸ Outbound Fares';
      } else {
        // Hide Return Fares (Date stays)
        if (retFareList) retFareList.style.display = 'none';
        if (retControls) retControls.style.display = 'none';
        if (outHeader) outHeader.textContent = 'ðŸ“Š Combined Fares';
      }
    }

    function createInlineFareCard(flightIndex, key, label, baseFare, mu, svc, extras, isChecked, suffix = '') {
      const checkedAttr = isChecked ? 'checked' : '';
      const disabledAttr = isChecked ? '' : 'disabled';
      const cardClass = isChecked ? 'fare-card' : 'fare-card disabled';
      const uniqueId = `inline-fare-card-${key}-${flightIndex}${suffix}`;
      const detailsId = `inline-details-${uniqueId}`;

      // Extras values
      const val = extras || {};

      return `
        <div class="${cardClass}" data-fare-key="${key}" id="${uniqueId}">
          <div class="fare-card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="chk-${uniqueId}" onchange="toggleInlineFareCard(this, '${key}', ${flightIndex}, '${suffix}')" ${checkedAttr}>
              <label for="chk-${uniqueId}">${label}</label>
            </div>
            <button class="fare-delete-icon-btn" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:1rem;" onclick="removeFareFromInline('${uniqueId}')" title="Remove This Fare Type">
              âœ•
            </button>
          </div>
          <div class="fare-card-fields">
            <div class="fare-field-row">
              <span class="fare-field-label">Fare</span>
              <input type="number" class="fare-field-input inline-fare-${uniqueId}" placeholder="â‚¹ 0" min="0" value="${baseFare !== undefined && baseFare !== null ? baseFare : ''}" ${disabledAttr}>
            </div>
            <div class="fare-field-row">
              <span class="fare-field-label">MU</span>
              <input type="number" class="fare-field-input inline-mu-${uniqueId}" placeholder="Markup" min="0" value="${mu}" ${disabledAttr}>
            </div>
            <div class="fare-field-row">
              <span class="fare-field-label">SVC</span>
              <input type="number" class="fare-field-input inline-svc-${uniqueId}" placeholder="Service Chg" min="0" value="${svc}" ${disabledAttr}>
            </div>
          </div>
          
          <div class="fare-extras-toggle" style="margin-top: 10px; border-top: 1px solid var(--border); padding-top: 8px;">
            <button type="button" onclick="toggleInlineFareDetails('${detailsId}')" style="background: none; border: none; color: var(--primary); font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 0;">
              <span>âž• Add Baggage & Extras</span>
              <span id="inline-toggle-icon-${detailsId}" style="transition: transform 0.3s ease;">â–¼</span>
            </button>
          </div>
          
          <div id="${detailsId}" style="display: none; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.02); border-radius: 6px;">
             <!-- Baggage -->
             <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Cabin</label>
                   <input type="text" class="form-input inline-cabin-${uniqueId}" placeholder="7kg" value="${val.baggage_cabin || ''}" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatBaggageInput(this)">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Check-in</label>
                   <input type="text" class="form-input inline-checkin-${uniqueId}" placeholder="15kg" value="${val.baggage_checkin || ''}" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatBaggageInput(this)">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Pieces</label>
                   <input type="text" class="form-input inline-pcs-${uniqueId}" placeholder="2pcs" value="${val.baggage_pcs || ''}" style="padding: 4px 6px; font-size: 0.75rem;" onblur="formatPiecesInput(this)">
                </div>
             </div>
             <!-- Meal / Seat -->
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Seat</label>
                   <input type="text" class="form-input inline-seat-${uniqueId}" placeholder="A12" value="${val.seat || ''}" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Meal</label>
                   <input type="text" class="form-input inline-meal-${uniqueId}" placeholder="Veg" value="${val.meal || ''}" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
             </div>
             <!-- Charges -->
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Cancel</label>
                   <input type="text" class="form-input inline-cancel-${uniqueId}" placeholder="3000" value="${val.cancellation_charges || ''}" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
                <div>
                   <label style="font-size: 0.65rem; color: var(--text-secondary); display: block;">Change</label>
                   <input type="text" class="form-input inline-penalty-${uniqueId}" placeholder="5000" value="${val.penalty_charges || ''}" style="padding: 4px 6px; font-size: 0.75rem;">
                </div>
             </div>
          </div>
        </div>
      `;
    }

    function toggleInlineFareDetails(detailsId) {
      const details = document.getElementById(detailsId);
      const icon = document.getElementById(`inline-toggle-icon-${detailsId}`);
      if (!details) return;

      if (details.style.display === 'none') {
        details.style.display = 'block';
        if (icon) icon.style.transform = 'rotate(180deg)';
      } else {
        details.style.display = 'none';
        if (icon) icon.style.transform = 'rotate(0deg)';
      }
    }

    function removeFareFromInline(uniqueId) {
      const card = document.getElementById(uniqueId);
      if (card) card.remove();
    }

    function toggleInlineFareCard(checkbox, fareType, flightIndex, suffix = '') {
      const uniqueId = `inline-fare-card-${fareType}-${flightIndex}${suffix}`;
      const card = document.getElementById(uniqueId);
      const fareInput = document.querySelector(`.inline-fare-${uniqueId}`);
      const muInput = document.querySelector(`.inline-mu-${uniqueId}`);
      const svcInput = document.querySelector(`.inline-svc-${uniqueId}`);

      if (checkbox.checked) {
        card.classList.remove('disabled');
        fareInput.disabled = false;
        muInput.disabled = false;
        svcInput.disabled = false;
      } else {
        card.classList.add('disabled');
        fareInput.disabled = true;
        muInput.disabled = true;
        svcInput.disabled = true;
        fareInput.value = '';
        muInput.value = '';
        svcInput.value = '';
      }
    }

    function handleInlineAddFareType(select, flightIndex, suffix = '') {
      const val = select.value;
      if (!val) return;

      let key = val;
      const cabinLabels = {
        'economy': 'Economy',
        'premium_economy': 'Premium Economy',
        'business': 'Business Class',
        'first': 'First Class'
      };

      let label = cabinLabels[val] || (val.charAt(0).toUpperCase() + val.slice(1).replace('_', ' ') + ' Fare');

      if (val === 'custom') {
        const customName = prompt("Enter Name for Custom Fare Type:");
        if (!customName || customName.trim() === '') {
          select.value = '';
          return;
        }
        label = customName.trim();
        key = label.toLowerCase().replace(/\s+/g, '_');
      }

      const uniqueId = `inline-fare-card-${key}-${flightIndex}${suffix}`;
      // Check if exists
      if (document.getElementById(uniqueId)) {
        showNotification('Fare type already exists', 'warning');
        select.value = '';
        return;
      }

      // Add the new fare card
      const list = document.getElementById(`inline-fare-list-${flightIndex}${suffix}`);
      const div = document.createElement('div');
      div.innerHTML = createInlineFareCard(flightIndex, key, label, '', '', '', {}, true, suffix);
      list.appendChild(div.firstElementChild);

      select.value = '';
    }

    async function saveInlineFareChanges(flightIndex) {
      const flight = currentFlights[flightIndex];
      if (!flight) return;

      const isRoundTrip = currentTripType === 'round_trip' && currentFlights[flightIndex + 1];
      const isSplit = isRoundTrip && document.getElementById(`inline-split-toggle-${flightIndex}`)?.checked;

      // Update the split flag
      if (isRoundTrip) {
        flight.is_split = isSplit;
      }

      // Helper to collect data from a specific list
      const collectData = (suffix) => {
        const fareCards = document.querySelectorAll(`#inline-fare-list-${flightIndex}${suffix} .fare-card`);
        const newFares = {};
        const newFareMU = {};
        const newFareSVC = {};
        const newFareExtras = {};
        let hasError = false;

        // Collect Date
        const dateInput = document.querySelector(`.inline-date-${flightIndex}${suffix}`);
        const newDate = dateInput ? dateInput.value.trim() : null;

        fareCards.forEach(card => {
          const checkbox = card.querySelector('.fare-card-header input[type="checkbox"]');
          if (!checkbox || !checkbox.checked) return;

          const fareKey = card.dataset.fareKey;
          const uniqueId = `inline-fare-card-${fareKey}-${flightIndex}${suffix}`;
          const fareInput = document.querySelector(`.inline-fare-${uniqueId}`);
          const muInput = document.querySelector(`.inline-mu-${uniqueId}`);
          const svcInput = document.querySelector(`.inline-svc-${uniqueId}`);

          if (!fareInput || !fareInput.value || fareInput.value.trim() === '') {
            showNotification(`Please enter fare amount for ${fareKey}`, 'error');
            if (fareInput) fareInput.focus();
            hasError = true;
            return;
          }

          newFares[fareKey] = Number(fareInput.value);
          newFareMU[fareKey] = (muInput && muInput.value) ? Number(muInput.value) : 0;
          newFareSVC[fareKey] = (svcInput && svcInput.value) ? Number(svcInput.value) : 0;

          const cabinInp = card.querySelector(`.inline-cabin-${uniqueId}`);
          const checkinInp = card.querySelector(`.inline-checkin-${uniqueId}`);
          const pcsInp = card.querySelector(`.inline-pcs-${uniqueId}`);
          const seatInp = card.querySelector(`.inline-seat-${uniqueId}`);
          const mealInp = card.querySelector(`.inline-meal-${uniqueId}`);
          const cancelInp = card.querySelector(`.inline-cancel-${uniqueId}`);
          const penInp = card.querySelector(`.inline-penalty-${uniqueId}`);

          if (cabinInp?.value || checkinInp?.value || pcsInp?.value || seatInp?.value || mealInp?.value || cancelInp?.value || penInp?.value) {
            newFareExtras[fareKey] = {
              baggage_cabin: cabinInp?.value?.trim(),
              baggage_checkin: checkinInp?.value?.trim(),
              baggage_pcs: pcsInp?.value?.trim(),
              seat: seatInp?.value?.trim(),
              meal: mealInp?.value?.trim(),
              cancellation_charges: cancelInp?.value?.trim(),
              penalty_charges: penInp?.value?.trim()
            };
          }

        });
        return { newFares, newFareMU, newFareSVC, newFareExtras, newDate, hasError };
      };

      // Collect Main (Outbound/Shared)
      const mainSuffix = isRoundTrip ? '_out' : '';
      const mainData = collectData(mainSuffix);
      if (mainData.hasError) return;

      // Save to main flight
      flight.fares = mainData.newFares;
      flight.fare_mu = mainData.newFareMU;
      flight.fare_svc = mainData.newFareSVC;
      flight.fare_extra_details = mainData.newFareExtras;

      if (isRoundTrip) {
        const returnFlight = currentFlights[flightIndex + 1];
        if (isSplit) {
          // Collect Return
          const retData = collectData('_ret');
          if (retData.hasError) return;

          returnFlight.fares = retData.newFares;
          returnFlight.fare_mu = retData.newFareMU;
          returnFlight.fare_svc = retData.newFareSVC;
          returnFlight.fare_extra_details = retData.newFareExtras;
        } else {
          // Copy Main to Return, BUT KEEP RETURN DATE if it exists and wasn't edited in shared mode?
          // If shared mode, we only displayed one date input (main).
          // Assuming shared date input applies to OUTBOUND only?
          // Or should we have displayed two date inputs even in combined mode?
          // The generator uses generateSectionHTML(flight...) and generateSectionHTML(returnFlight...)
          // In combined mode (`isSplit` false), `generateSectionHTML` is called for `flight` (Main) using `_out` suffix (lines 6361).
          // And `returnFlight` section is HIDDEN if `isSplit` is false (line 6362).
          // Wait, `isSplit` affects `display: none` of the return section.
          // IF HIDDEN, the user CANNOT edit the return date.
          // This is a logic gap. A user might want same fares but different dates (obviously).
          // FIX: Always show the Return Date input?
          // Or separate the Date Input from the Fare Section?
          // For now, I will ensure that if `isSplit` is false (Combined Fares), we DO NOT overwrite the Return Date with the Main Date (which makes no sense).
          // But wait, if the section is hidden, `collectData('_ret')` will still find element if it's in DOM (just hidden).
          // Correct. `display: none` elements are still found by querySelector.
          // So if the user edits the main date, and the return section is hidden, the return date input (hidden) remains unchanged.
          // `collectData('_ret')` will pick up the hidden return date.
          // So we should capture it.

          const retData = collectData('_ret'); // This captures the hidden return date input

          returnFlight.fares = JSON.parse(JSON.stringify(mainData.newFares));
          returnFlight.fare_mu = JSON.parse(JSON.stringify(mainData.newFareMU));
          returnFlight.fare_svc = JSON.parse(JSON.stringify(mainData.newFareSVC));
          returnFlight.fare_extra_details = JSON.parse(JSON.stringify(mainData.newFareExtras));
        }
      }

      // Check if dates were changed and trigger recalculation if so
      const needsRecalc = [];
      if (mainData.newDate && mainData.newDate !== flight.departure_date) {
        flight.departure_date = mainData.newDate;
        needsRecalc.push(flightIndex);
      }
      if (isRoundTrip) {
        const returnFlight = currentFlights[flightIndex + 1];
        const retData = collectData('_ret');
        if (retData.newDate && retData.newDate !== returnFlight.departure_date) {
          returnFlight.departure_date = retData.newDate;
          needsRecalc.push(flightIndex + 1);
        }
      }

      if (needsRecalc.length > 0) {
        await recalculateMultipleFlights(needsRecalc);
      } else {
        renderResults(currentFlights);
        regenerateOutputText();
      }

      showNotification('Fares updated successfully', 'success');
      toggleInlineFareEditor(flightIndex);
    }


    async function deleteFlightOption(index) {
      const confirmed = await showDeleteModal('Delete Flight Option', 'Are you sure you want to delete this Entire Flight Option and its fares? This cannot be undone.');
      if (!confirmed) {
        return;
      }

      // Hide editor if open for this index
      const editor = document.getElementById(`inline-editor-${index}`);
      if (editor) editor.style.display = 'none';

      // Remove from currentFlights
      currentFlights.splice(index, 1);

      // Update unitFlights mapping (re-index all references)
      const newUnitFlights = {};
      Object.entries(unitFlights).forEach(([unitId, ids]) => {
        const newIds = ids
          .map(id => id === index ? null : (id > index ? id - 1 : id))
          .filter(id => id !== null);

        if (newIds.length > 0) {
          newUnitFlights[unitId] = newIds;
        }
      });
      unitFlights = newUnitFlights;

      // Re-render
      renderResults(currentFlights);
      regenerateOutputText();

      showNotification('Flight option deleted successfully', 'success');

      // Re-apply global edit mode state if active
      if (isGlobalEditMode) {
        currentFlights.forEach((f, idx) => {
          if (f.is_editable) {
            const editBar = document.getElementById(`card-edit-bar-${idx}`);
            if (editBar) editBar.style.display = 'flex';
          }
        });
      }
    }

    function removeFareFromOption(flightIndex, fareKey) {
      const card = document.getElementById(`inline-fare-card-${fareKey}-${flightIndex}`);
      if (card) {
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'translateX(20px)';
        setTimeout(() => {
          card.remove();
        }, 300);
      }
    }

    function getAirlinesForOption(flights) {
      if (!flights || flights.length === 0) return '';
      const airlines = new Set();
      flights.forEach(f => {
        if (!f) return;
        if (f.segments && f.segments.length > 0) {
          f.segments.forEach(s => { if (s.airline && s.airline !== 'N/A') airlines.add(s.airline); });
        } else if (f.airline && f.airline !== 'N/A') {
          airlines.add(f.airline);
        }
      });
      if (airlines.size === 0) return '';
      return ` (${Array.from(airlines).join(' & ')})`;
    }

    function formatFlightOutput(flight, flightNumber) {
      const dateDisplay = !flight.departure_date || flight.departure_date === 'N/A' ? '[DATE TO BE CONFIRMED]' : flight.departure_date;

      // Check if we have segments (layover/connecting flights)
      const hasSegments = flight.segments && flight.segments.length > 1;

      let output = '';

      // Option header
      const timeCat = getTimeCategory(flight.departure_time);
      const airlineStr = getAirlinesForOption([flight]);
      output += `*OPTION ${flightNumber}${timeCat ? ' - ' + timeCat : ''}${airlineStr}*\n\n`;

      // Route line without emoji
      output += `Flight from ${flight.departure_city} (${flight.departure_airport}) to ${flight.arrival_city} (${flight.arrival_airport}) â€” *${dateDisplay}*\n\n`;

      if (hasSegments) {
        // Multi-segment flight with layovers
        flight.segments.forEach((seg, idx) => {
          output += `*${seg.airline || flight.airline} ${seg.flight_number || ''}*\n`;
          output += `*${seg.departure_airport}* ${seg.departure_time} â†’ *${seg.arrival_airport}* ${seg.arrival_time}\n`;
          if (isFieldValid(seg.duration)) output += `Duration: *${seg.duration}*\n`;

          // Add layover info if not the last segment
          if (idx < flight.segments.length - 1) {
            output += `\n*Layover:* ${seg.arrival_city || seg.arrival_airport}`;
            if (isFieldValid(seg.layover_duration)) output += ` â€” *${seg.layover_duration}*`;
            output += `\n\n`;
          }
        });
      } else {
        // Single segment flight or fallback
        output += `*${flight.airline} ${flight.flight_number}*\n`;
        output += `*${flight.departure_airport}* ${flight.departure_time} â†’ *${flight.arrival_airport}* ${flight.arrival_time}\n`;
        if (isFieldValid(flight.duration)) output += `Duration: *${flight.duration}*\n`;

        if (isFieldValid(flight.stops) && flight.stops !== '0 stops') {
          output += `${flight.stops}\n`;
        } else {
          output += `Non Stop\n`;
        }
      }

      output += `\n`;

      // Fares (no dash separator)
      Object.entries(flight.fares).forEach(([type, base]) => {
        const perFareMU = flight.fare_mu && flight.fare_mu[type] !== undefined ? flight.fare_mu[type] : (flight.markup || 0);
        const finalFare = base + perFareMU;
        const perFareSVC = flight.fare_svc && flight.fare_svc[type] !== undefined ? flight.fare_svc[type] : (flight.service_charge || 0);
        const perFareGST = perFareSVC > 0 ? Math.round(perFareSVC * 0.18) : 0;

        let svcText = '';
        if (perFareSVC > 0) {
          svcText = ` (+ â‚¹${perFareSVC} SVC + â‚¹${perFareGST} GST)`;
        }
        output += `*${type.charAt(0).toUpperCase() + type.slice(1)} Fare:* â‚¹${finalFare.toLocaleString('en-IN')} per person${svcText}\n`;

        // Add baggage/extra info on new lines
        if (flight.fare_extra_details && flight.fare_extra_details[type]) {
          const d = flight.fare_extra_details[type];

          // 1. Baggage Row
          const bagParts = [];
          if (d.baggage_cabin) bagParts.push(`Cabin: ${d.baggage_cabin}`);
          if (d.baggage_checkin) bagParts.push(`Check-in: ${d.baggage_checkin}`);
          if (d.baggage_pcs) bagParts.push(`Pcs: ${d.baggage_pcs}`);
          if (bagParts.length > 0) output += `*Baggage:* ${bagParts.join(' | ')}\n`;

          // 2. Meal Row
          if (d.meal) output += `*Meal:* ${d.meal}\n`;

          // 3. Seat Row
          if (d.seat) output += `*Seat:* ${d.seat}\n`;

          // 4. Cancellation Charges
          if (d.cancellation_charges) output += `*Cancellation Charges:* ${d.cancellation_charges} + GST per pax\n`;

          // 5. Change Penalty
          if (d.penalty_charges) output += `*Changes Penalty:* ${d.penalty_charges} + GST per pax\n`;
        }
        output += `\n`;
      });

      return output;
    }

    function formatFlightOutputWithoutFares(flight, flightNumber) {
      const dateDisplay = !flight.departure_date || flight.departure_date === 'N/A' ? '[DATE TO BE CONFIRMED]' : flight.departure_date;

      let out = `Flight from ${flight.departure_city} (${flight.departure_airport}) to ${flight.arrival_city} (${flight.arrival_airport}) â€” *${dateDisplay}*\n\n`;

      if (flight.segments && flight.segments.length > 1) {
        // Multi-segment detailed layout
        flight.segments.forEach((seg, idx) => {
          // Segment Details
          out += `*${seg.airline || flight.airline} ${seg.flight_number || ''}*\n`;
          out += `*${seg.departure_airport}* ${seg.departure_time} â†’ *${seg.arrival_airport}* ${seg.arrival_time}\n`;
          if (isFieldValid(seg.duration)) out += `Duration: *${seg.duration}*\n`;

          // Layover Info
          if (idx < flight.segments.length - 1) {
            const nextSeg = flight.segments[idx + 1];
            const layoverCity = nextSeg.departure_city || nextSeg.departure_airport;
            const layoverDur = nextSeg.layover_duration || '';

            out += `\n*Layover:* ${layoverCity}`;
            if (layoverDur && layoverDur !== 'N/A') out += ` â€” *${layoverDur}*`;
            out += `\n\n`;
          }
        });

      } else {
        out += `*${flight.airline} ${flight.flight_number}*\n`;
        out += `*${flight.departure_airport}* ${flight.departure_time} â†’ *${flight.arrival_airport}* ${flight.arrival_time}\n`;
        if (isFieldValid(flight.duration)) out += `Duration: *${flight.duration}*\n`;

        if (isFieldValid(flight.stops) && flight.stops !== '0 stops') {
          out += `${flight.stops}\n`;
        } else {
          out += `Non Stop\n`;
        }
      }
      return out;
    }

    function formatFaresOutput(flight) {
      let fareLines = '';
      Object.entries(flight.fares).forEach(([type, base]) => {
        // Use per-fare markup if available, otherwise use global markup
        const perFareMU = flight.fare_mu && flight.fare_mu[type] !== undefined ? flight.fare_mu[type] : (flight.markup || 0);
        const finalFare = base + perFareMU;

        // Use per-fare SVC if available, otherwise use global SVC
        const perFareSVC = flight.fare_svc && flight.fare_svc[type] !== undefined ? flight.fare_svc[type] : (flight.service_charge || 0);
        const perFareGST = perFareSVC > 0 ? Math.round(perFareSVC * 0.18) : 0;

        let extraText = '';
        if (perFareSVC > 0) {
          extraText = ` (+ â‚¹${perFareSVC} SVC + â‚¹${perFareGST} GST)`;
        }

        fareLines += `*${type.charAt(0).toUpperCase() + type.slice(1)} Fare:* â‚¹${finalFare.toLocaleString('en-IN')} per person${extraText}\n`;

        // Add baggage/extra info on new lines
        if (flight.fare_extra_details && flight.fare_extra_details[type]) {
          const d = flight.fare_extra_details[type];

          // 1. Baggage Row
          const bagParts = [];
          if (d.baggage_cabin) bagParts.push(`Cabin: ${d.baggage_cabin}`);
          if (d.baggage_checkin) bagParts.push(`Check-in: ${d.baggage_checkin}`);
          if (d.baggage_pcs) bagParts.push(`Pcs: ${d.baggage_pcs}`);
          if (bagParts.length > 0) fareLines += `*Baggage:* ${bagParts.join(' | ')}\n`;

          // 2. Meal Row
          if (d.meal) fareLines += `*Meal:* ${d.meal}\n`;

          // 3. Seat Row
          if (d.seat) fareLines += `*Seat:* ${d.seat}\n`;

          // 4. Cancellation Charges
          if (d.cancellation_charges) fareLines += `*Cancellation Charges:* ${d.cancellation_charges} + GST per pax\n`;

          // 5. Change Penalty
          if (d.penalty_charges) fareLines += `*Changes Penalty:* ${d.penalty_charges} + GST per pax\n`;
        }
        fareLines += `\n`;
      });
      return fareLines;
    }

    function promptDateInput(flightIndex) {
      const flight = currentFlights[flightIndex];
      const today = new Date();
      const minDate = today.toISOString().split('T')[0];

      // Create modal for date input
      const modalHTML = `
    <div id="dateModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
      <div style="background: var(--bg-card); padding: 2rem; border-radius: 0.8rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 1rem 0; color: var(--primary);">ðŸ“… Enter Flight Date</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
          ${flight.airline} ${flight.flight_number}<br/>
          <strong>${flight.departure_city} â†’ ${flight.arrival_city}</strong>
        </p>
        
        <input type="date" id="flightDateInput" min="${minDate}" style="width: 100%; padding: 0.8rem; border: 2px solid var(--border); border-radius: 0.4rem; font-size: 1rem; box-sizing: border-box; margin-bottom: 1rem; background: var(--bg-card); color: var(--text-primary);" />
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button onclick="closeDateModal()" style="padding: 0.6rem 1.2rem; background: var(--bg-main); border: none; border-radius: 0.3rem; cursor: pointer; color: var(--text-primary);">Cancel</button>
          <button onclick="saveDateInput(${flightIndex})" style="padding: 0.6rem 1.2rem; background: var(--primary); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-weight: bold;">Save Date</button>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.getElementById('flightDateInput').focus();
    }

    function closeDateModal() {
      const modal = document.getElementById('dateModal');
      if (modal) modal.remove();
    }

    function regenerateOutputText() {
      if (!currentFlights || currentFlights.length === 0) {
        console.log('No current flights available');
        return;
      }

      let output = '';
      // Header removed for consistency

      if (currentTripType === 'round_trip') {
        let flightIdx = 0;
        Object.entries(unitFlights).forEach(([unitId, flightIds]) => {
          if (flightIds.length === 2) {
            // Define flights locally
            const outboundFlight = currentFlights[flightIdx];
            const returnFlight = currentFlights[flightIdx + 1];

            const airlineStr = getAirlinesForOption([outboundFlight, returnFlight]);
            const headerText = `*ROUND TRIP OPTION ${unitId}${airlineStr}*`;
            const separator = '_________________________';
            output += `\n${headerText}\n${separator}\n\n`;

            // Deep comparison helper for fares
            const areFaresInitiallySame = (f1, f2) => {
              const k1 = Object.keys(f1).sort();
              const k2 = Object.keys(f2).sort();
              if (k1.length !== k2.length) return false;
              if (!k1.every((key, i) => key === k2[i])) return false;
              return k1.every(key => f1[key] === f2[key]);
            };

            // Are fares different (Split Mode)?
            const areFaresDifferent = (outboundFlight.is_split === true) || !areFaresInitiallySame(outboundFlight.fares, returnFlight.fares);

            if (areFaresDifferent) {
              // Split Logic for Output Text

              // Outbound
              output += `*âœˆï¸ OUTBOUND FLIGHT*\n\n`;
              output += formatFlightOutputWithoutFares(outboundFlight, flightIdx + 1);
              output += `\n`; // Just separation
              output += formatFaresOutput(outboundFlight);
              output += `\n`;

              // Return
              output += `\n*âœˆï¸ RETURN FLIGHT*\n\n`;
              output += formatFlightOutputWithoutFares(returnFlight, flightIdx + 2);
              output += `\n`; // Just separation
              output += formatFaresOutput(returnFlight);

            } else {
              // Combined Logic (Existing)

              // Outbound flight - WITHOUT fares
              output += `*âœˆï¸ OUTBOUND FLIGHT*\n\n`;
              output += formatFlightOutputWithoutFares(outboundFlight, flightIdx + 1);

              // Return flight - WITHOUT fares
              output += `\n*âœˆï¸ RETURN FLIGHT*\n\n`;
              output += formatFlightOutputWithoutFares(returnFlight, flightIdx + 2);

              // Show fares ONCE for the entire option
              output += `\n*ROUND TRIP FARE*\n`;
              output += formatFaresOutput(outboundFlight);
            }

            flightIdx += 2;
          }
        });
      } else if (currentTripType === 'multi_city') {
        let flightIdx = 0;
        Object.entries(unitFlights).forEach(([unitId, flightIds]) => {
          const multiCityFlights = flightIds.map(idx => currentFlights[idx]).filter(Boolean);
          const airlineStr = getAirlinesForOption(multiCityFlights);
          const headerText = `*MULTI-CITY OPTION ${unitId}${airlineStr}*`;
          const separator = '_________________________';
          output += `\n${headerText}\n${separator}\n\n`;

          flightIds.forEach((fid, cityIdx) => {
            if (flightIdx < currentFlights.length) {
              output += `*âœˆï¸ FLIGHT ${cityIdx + 1}*\n\n`;
              const flight = currentFlights[flightIdx];
              // Show flight WITHOUT fares
              output += formatFlightOutputWithoutFares(flight, flightIdx + 1);
              output += '\n';
              flightIdx++;
            }
          });

          // Show fares ONCE for the entire option
          if (flightIdx > 0) {
            output += `*FARES FOR THIS OPTION:*\n`;
            output += formatFaresOutput(currentFlights[flightIdx - 1]);
          }
        });
      } else {
        currentFlights.forEach((flight, index) => {
          output += formatFlightOutput(flight, index + 1);
          if (index < currentFlights.length - 1) {
            output += '\n';
          }
        });
      }

      output += `\n\n*Please Note:*\n_Timings mentioned are in 24 hours clock_\n_No booking has been made yet_\n_Rates and inventory are subject to availability at the time of final booking_`;

      currentFinalText = output.trim();
      const outputElement = document.getElementById("output");
      if (outputElement) {
        outputElement.textContent = currentFinalText;
        console.log('Output text updated');
      }
    }

    async function recalculateFlight(index, skipRender = false) {
      const flight = currentFlights[index];
      if (!flight || !flight.departure_date || flight.departure_date === 'N/A') return;

      try {
        const response = await fetch('/api/recalculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ flight, new_date: flight.departure_date })
        });
        const data = await response.json();
        if (data.flight) {
          // Keep the existing ID and editable status if they were lost or different
          const oldId = flight.id;
          const oldEditable = flight.is_editable;
          const oldFares = flight.fares;
          const oldFareMu = flight.fare_mu;
          const oldFareSvc = flight.fare_svc;
          const oldFareExtras = flight.fare_extra_details;

          currentFlights[index] = data.flight;

          // Restore UI state fields
          currentFlights[index].id = oldId;
          currentFlights[index].is_editable = oldEditable;
          currentFlights[index].fares = oldFares;
          currentFlights[index].fare_mu = oldFareMu;
          currentFlights[index].fare_svc = oldFareSvc;
          currentFlights[index].fare_extra_details = oldFareExtras;

          if (!skipRender) {
            renderResults(currentFlights);
            regenerateOutputText();
          }
        }
      } catch (e) {
        console.error('Recalculation failed:', e);
      }
    }

    async function recalculateMultipleFlights(indices) {
      if (!indices || indices.length === 0) return;

      showLoader(); // Need to ensure showLoader exists or just use a flag

      const promises = indices.map(idx => recalculateFlight(idx, true));
      await Promise.all(promises);

      renderResults(currentFlights);
      regenerateOutputText();
      hideLoader();
    }

    async function saveDateInput(flightIndex) {
      const dateInput = document.getElementById('flightDateInput');
      const selectedDate = dateInput.value.trim();

      if (!selectedDate) {
        showNotification('Please select a date', 'error');
        return;
      }

      // Convert YYYY-MM-DD to "DD Mon YYYY" format
      const dateParts = selectedDate.split('-');
      const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
      const options = { day: '2-digit', month: 'short', year: 'numeric' };
      const formattedDate = dateObj.toLocaleDateString('en-GB', options).replace(/\s+/g, ' ');

      console.log('Saving date:', formattedDate, 'for flight index:', flightIndex);

      // Update the flight data
      if (currentFlights && currentFlights[flightIndex]) {
        currentFlights[flightIndex].departure_date = formattedDate;

        // Recalculate flight details (duration, offsets, layovers)
        await recalculateFlight(flightIndex);

        // Remove the "Enter Date" warning strip if it exists
        const warningStrip = document.getElementById(`date-warning-${flightIndex}`);
        if (warningStrip) {
          warningStrip.remove();
        }

        showNotification(`Date set to ${formattedDate}`, 'success');

        // Check if there are other flights without dates
        const flightsWithoutDate = currentFlights.filter((f, idx) =>
          idx !== flightIndex && (!f.departure_date || f.departure_date === 'N/A')
        );

        if (flightsWithoutDate.length > 0) {
          // Close current modal first
          closeDateModal();

          // Show prompt to apply date to other flights
          setTimeout(() => {
            showApplyDatePrompt(formattedDate, flightIndex, selectedDate);
          }, 300);
          return;
        }
      } else {
        console.log('currentFlights not available or index out of range');
        showNotification('Error updating flight', 'error');
      }

      closeDateModal();
    }

    function showApplyDatePrompt(formattedDate, excludeIndex, rawDate) {
      const flightsWithoutDate = currentFlights
        .map((f, idx) => ({ flight: f, index: idx }))
        .filter(item => item.index !== excludeIndex && (!item.flight.departure_date || item.flight.departure_date === 'N/A'));

      if (flightsWithoutDate.length === 0) return;

      const count = flightsWithoutDate.length;
      const modalHTML = `
        <div id="applyDateModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
          <div style="background: var(--bg-card); padding: 2rem; border-radius: 0.8rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 450px; width: 90%;">
            <h3 style="margin: 0 0 1rem 0; color: var(--primary);">ðŸ“… Apply Date to Other Flights?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
              You have <strong>${count} other flight${count > 1 ? 's' : ''}</strong> without a date set.<br><br>
              Would you like to apply <strong>${formattedDate}</strong> to ${count > 1 ? 'all of them' : 'it'}?
            </p>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; flex-wrap: wrap;">
              <button onclick="closeApplyDateModal()" style="padding: 0.6rem 1.2rem; background: var(--bg-main); border: none; border-radius: 0.3rem; cursor: pointer; color: var(--text-primary);">No, I'll set them manually</button>
              <button onclick="applyDateToAllFlights('${formattedDate}', ${excludeIndex})" style="padding: 0.6rem 1.2rem; background: var(--primary); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-weight: bold;">Yes, apply to all</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeApplyDateModal() {
      const modal = document.getElementById('applyDateModal');
      if (modal) modal.remove();
    }

    async function applyDateToAllFlights(formattedDate, excludeIndex) {
      let updatedIndices = [];

      currentFlights.forEach((flight, idx) => {
        if (idx !== excludeIndex && (!flight.departure_date || flight.departure_date === 'N/A')) {
          flight.departure_date = formattedDate;
          updatedIndices.push(idx);

          // Remove warning strip
          const warningStrip = document.getElementById(`date-warning-${idx}`);
          if (warningStrip) {
            warningStrip.remove();
          }
        }
      });

      if (updatedIndices.length > 0) {
        await recalculateMultipleFlights(updatedIndices);
      } else {
        regenerateOutputText();
      }

      closeApplyDateModal();
      showNotification(`Date applied to ${updatedIndices.length} flight${updatedIndices.length > 1 ? 's' : ''}!`, 'success');
    }

    function toggleDetails(id) {
      const timeline = document.getElementById(`timeline-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);

      if (timeline && timeline.style.display === 'none') {
        timeline.style.display = 'block';
        if (arrow) arrow.classList.add('rotated');
      } else if (timeline) {
        timeline.style.display = 'none';
        if (arrow) arrow.classList.remove('rotated');
      }
    }

    function copyOutput() {
      // Use currentFinalText which is the properly formatted output
      const output = currentFinalText || document.getElementById("output").textContent;

      if (!output || output === 'No output yet.') {
        showNotification('No itinerary to copy. Parse flights first.', 'warning');
        return;
      }

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(output).then(() => {
          showNotification('Copied to clipboard!', 'success');
        }).catch((err) => {
          console.error('Clipboard API failed', err);
          fallbackCopy(output);
        });
      } else {
        fallbackCopy(output);
      }
    }

    function fallbackCopy(text) {
      // Fallback for older browsers or when clipboard API is not available
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      textarea.style.top = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showNotification('Copied to clipboard!', 'success');
        } else {
          showNotification('Failed to copy. Please select and copy manually.', 'error');
        }
      } catch (e) {
        console.error('Fallback copy failed', e);
        showNotification('Failed to copy. Please select and copy manually.', 'error');
      }

      document.body.removeChild(textarea);
    }

    async function ensureHtml2Canvas() {
      if (typeof html2canvas === 'undefined') {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
          script.onload = () => resolve();
          script.onerror = () => reject('Failed to load html2canvas');
          document.head.appendChild(script);
        });
      }
      return Promise.resolve();
    }

    async function generateImageBlob() {
      await ensureHtml2Canvas();
      const cardsContainer = document.getElementById('cards');
      const htmlEl = document.documentElement;

      // 1. Store current theme and Force Light Mode
      const currentTheme = htmlEl.getAttribute('data-theme');
      const isDark = currentTheme === 'dark';

      if (isDark) {
        htmlEl.setAttribute('data-theme', 'light');
      }

      // 2. Add capturing class to remove shadows/blurs
      cardsContainer.classList.add('capturing');

      try {
        // 3. Get Light Mode Background Color
        const lightBg = getComputedStyle(document.body).backgroundColor;

        const canvas = await html2canvas(cardsContainer, {
          backgroundColor: lightBg, // Use proper light background
          scale: 2,
          logging: false,
          useCORS: true,
          allowTaint: true
        });

        // 4. Restore State
        if (isDark) htmlEl.setAttribute('data-theme', 'dark');
        cardsContainer.classList.remove('capturing');

        return new Promise(resolve => {
          canvas.toBlob(blob => resolve(blob), 'image/png');
        });
      } catch (e) {
        if (isDark) htmlEl.setAttribute('data-theme', 'dark');
        cardsContainer.classList.remove('capturing');
        throw e;
      }
    }


    async function shareCombined(type) {
      if (!currentFinalText) {
        showNotification('No itinerary generated yet', 'warning');
        return;
      }

      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      /* =====================================================
        EMAIL ONLY (TEXT, NO IMAGE)
      ===================================================== */
      if (type === 'email') {
        const plainText = currentFinalText.replace(/[*_]/g, '');

        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(plainText);
          } else {
            fallbackCopy(plainText);
          }
          showNotification('Text copied for Email (no formatting)', 'success');
        } catch {
          fallbackCopy(plainText);
        }
        return;
      }

      showNotification('Generating imageâ€¦', 'info');

      let waWindow = null;

      /* =====================================================
        DESKTOP WHATSAPP PRE-OPEN (POPUP SAFE)
      ===================================================== */
      if (type === 'whatsapp' && !isMobile) {
        waWindow = window.open('', '_blank');
        if (waWindow) {
          waWindow.document.write(`
              <html>
                <body style="font-family:sans-serif;text-align:center;margin-top:20%">
                  <h2>Generating itineraryâ€¦</h2>
                </body>
              </html>
            `);
        }
      }

      try {
        const imageBlob = await generateImageBlob();
        const filename = getFlightImageFilename();
        const file = new File([imageBlob], filename, {
          type: 'image/png'
        });

        /* =====================================================
          MOBILE â†’ NATIVE SHARE (IMAGE + TEXT TOGETHER)
        ===================================================== */
        if (
          isMobile &&
          navigator.canShare &&
          navigator.canShare({ files: [file] })
        ) {
          await navigator.share({
            title: 'Flight Itinerary',
            text: currentFinalText, // Keep stars for WhatsApp formatting
            files: [file]
          });

          showNotification('Shared successfully!', 'success');
          return; // â›” STOP here on mobile
        }

        /* =====================================================
          DESKTOP WHATSAPP FALLBACK
        ===================================================== */
        if (type === 'whatsapp') {
          const encodedText = encodeURIComponent(currentFinalText);
          const waUrl = `https://web.whatsapp.com/send?text=${encodedText}`;

          try {
            // Try clipboard image copy
            const item = new ClipboardItem({ 'image/png': imageBlob });
            await navigator.clipboard.write([item]);
            showNotification('Image copied! Paste into WhatsApp (Ctrl+V)', 'success');
          } catch {
            // Fallback: download image
            downloadImage(imageBlob);
            showNotification('Image downloaded. Attach manually.', 'warning');
          }

          if (waWindow) {
            waWindow.location.href = waUrl;
          } else {
            window.open(waUrl, '_blank');
          }
        }

      } catch (error) {
        console.error(error);
        showNotification('Sharing failed', 'error');
        if (waWindow) waWindow.close();
      }
    }

    /* =====================================================
      IMAGE DOWNLOAD HELPER
    ===================================================== */
    function getFlightImageFilename() {
      if (!currentFlights || currentFlights.length === 0) return 'Flight_Itinerary.png';

      const firstFlight = currentFlights[0];
      const dep = firstFlight.departure_airport || 'DEP';

      let typeStr = 'ONE WAY';
      let routeStr = `${dep} â†’ ${firstFlight.arrival_airport || 'ARR'}`;

      if (currentTripType === 'round_trip') {
        typeStr = 'ROUND TRIP';
        routeStr = `${dep} â†” ${firstFlight.arrival_airport || 'ARR'}`;
      } else if (currentTripType === 'multi_city') {
        typeStr = 'MULTI CITY';
        const dests = [dep];
        currentFlights.forEach(f => {
          if (f.arrival_airport && f.arrival_airport !== dests[dests.length - 1]) {
            dests.push(f.arrival_airport);
          }
        });
        routeStr = dests.join(' â†’ ');
      }

      const dateStr = (firstFlight.departure_date || '').replace(/[\/\\]/g, '-').trim() || 'DATE';

      return `${routeStr} (${typeStr}) ${dateStr}.png`.replace('.PNG', '.png');
    }

    function downloadImage(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = getFlightImageFilename();
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* =====================================================
      LEGACY FUNCTIONS
    ===================================================== */
    function shareCardsAsImage() {
      shareCombined('whatsapp');
    }

    async function downloadCardsImage() {
      showNotification('Generating imageâ€¦', 'info');
      try {
        const blob = await generateImageBlob();
        downloadImage(blob);
        showNotification('Image downloaded!', 'success');
      } catch {
        showNotification('Failed to generate image', 'error');
      }
    }
  </script>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Drawer -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" id="sidebarClose">âœ•</button>
    <div class="sidebar-header">
      <div class="user-profile-section">
        <div class="user-avatar" id="sidebarAvatar">ðŸ‘¤</div>
        <div class="user-info">
          <div class="user-name" id="sidebarUserName">Guest User</div>
          <div class="user-email" id="sidebarUserEmail">Welcome!</div>
        </div>
      </div>
      <div class="auth-btn-container">
        <button class="sidebar-auth-btn" id="sidebarAuthBtn" onclick="handleAuthClick()">
          ðŸ” Login / Register
        </button>
      </div>
    </div>
    <div class="sidebar-body">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link active">ðŸ  Home</a>
        <a href="/passengers" class="sidebar-link">ðŸ‘¤ Passengers</a>
        <a href="/corporates" class="sidebar-link">ðŸ¢ Corporates</a>
        <a href="/itineraries-v2" class="sidebar-link">ðŸ“‹ Itineraries</a>
        <div style="margin-top: 1rem; padding: 0 0.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer; color: #ef4444;"
            onclick="clearDraft()">
            ðŸ—‘ï¸ Clear Draft
          </button>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer; color: var(--primary);"
            onclick="saveDraft()">
            ðŸ’¾ Save Draft
          </button>
        </div>
        <div style="margin-top: 1rem; padding: 0 0.5rem;">
          <label class="input-label"
            style="display: block; margin-bottom: 0.75rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);">Appearance</label>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer;" id="sidebarThemeToggle">
            <span class="theme-icon-container">ðŸŒ™</span>
            <span id="themeToggleText">Dark Mode</span>
          </button>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer; margin-top: 0.5rem;"
            id="sidebarValentineToggle">
            <span class="theme-icon-container">ðŸŽ€</span>
            <span id="sidebarValToggleText">Pookie Mode</span>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Sidebar Functionality
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebar = document.getElementById('sidebar');

      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.add('active');
          sidebarOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      }

      const closeSidebar = () => {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      };

      if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

      // Auth for sidebar
      checkSidebarAuthStatus();

      // Theme toggle for sidebar
      const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
      if (sidebarThemeToggle) {
        sidebarThemeToggle.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme');
          const next = current === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', next);
          updateGlobalTheme(next);
        });
      }
    });

    async function checkSidebarAuthStatus() {
      try {
        const response = await fetch('/api/user');
        if (response.ok) {
          const user = await response.json();
          document.getElementById('sidebarUserName').textContent = user.username;
          document.getElementById('sidebarUserEmail').textContent = user.email || 'Member';
          document.getElementById('sidebarAvatar').textContent = user.username.charAt(0).toUpperCase();

          const authBtn = document.getElementById('sidebarAuthBtn');
          authBtn.textContent = 'ðŸšª Logout';
          authBtn.classList.add('logout');
          authBtn.onclick = async () => {
            const confirmed = confirm('Are you sure you want to logout?');
            if (confirmed) {
              await fetch('/api/logout', { method: 'POST' });
              window.location.href = '/login';
            }
          };
        }
      } catch (e) { }
    }

    function updateGlobalTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const text = document.getElementById('themeToggleText');
      const icon = document.querySelector('.theme-icon-container');
      if (text) text.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
      if (icon) icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';

      // Update the main dark mode toggle icon too if it exists
      const mainIcon = document.querySelector('.dark-mode-icon');
      if (mainIcon) mainIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    function handleAuthClick() {
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = '/login?next=' + next;
    }

    // --- Utility Functions for Save Modal ---
    function showLoginRequiredModal() {
      document.getElementById('loginRequiredModal').classList.add('is-active');
      document.body.style.overflow = 'hidden';
    }

    function closeLoginRequiredModal() {
      document.getElementById('loginRequiredModal').classList.remove('is-active');
      document.body.style.overflow = '';
    }

    function switchBillingTab(type) {
      activeBillingType = type;
      document.querySelectorAll('.billing-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll(`.billing-tab[onclick="switchBillingTab('${type}')"]`).forEach(t => t.classList.add('active'));

      document.getElementById('passengerForm').style.display = type === 'passenger' ? 'block' : 'none';
      document.getElementById('corporateForm').style.display = type === 'corporate' ? 'block' : 'none';
    }

    // --- Draft Management ---
    function saveDraft() {
      const draft = {
        tripType: currentTripType,
        markup: document.getElementById('markup').value,
        serviceCharge: document.getElementById('serviceCharge').value,
        units: [],
        // Save parsed state
        currentFlights: currentFlights,
        currentFinalText: currentFinalText,
        unitFlights: unitFlights
      };

      document.querySelectorAll('.flight-unit').forEach(unit => {
        const flightBlocks = [];
        unit.querySelectorAll('.flight-block').forEach(block => {
          flightBlocks.push({
            text: block.querySelector('textarea').value,
            layover: block.querySelector('.layover-checkbox').checked,
            multiple: block.querySelector('.multiple-flights-checkbox')?.checked || false
          });
        });
        draft.units.push({
          flights: flightBlocks,
          unitId: unit.dataset.unitId
        });
      });

      localStorage.setItem('flight_itinerary_draft', JSON.stringify(draft));
      showNotification('Draft saved successfully', 'success');
    }

    async function loadDraft() {
      try {
        const saved = localStorage.getItem('flight_itinerary_draft');
        if (!saved) return;

        const draft = JSON.parse(saved);
        if (!draft || !draft.units || draft.units.length === 0) return;

        showNotification('Restoring your saved draft...', 'info');

        // Restore trip type
        const radio = document.querySelector(`input[name="tripType"][value="${draft.tripType}"]`);
        if (radio) {
          radio.checked = true;
          handleTripType();
        }

        document.getElementById('markup').value = draft.markup || '';
        document.getElementById('serviceCharge').value = draft.serviceCharge || '';
        if (document.getElementById('serviceCharge').value) updateGSTDisplay();

        // The first unit is already added by handleTripType()
        for (let i = 0; i < draft.units.length; i++) {
          const unitData = draft.units[i];
          if (i > 0) addUnit();

          const units = document.querySelectorAll('.flight-unit');
          const unitEl = units[i];
          const unitId = unitEl.dataset.unitId;

          // For multi-city, add extra cities if needed
          if (draft.tripType === 'multi_city') {
            while (unitEl.querySelectorAll('.flight-block').length < unitData.flights.length) {
              addCityToUnit(unitId);
            }
          }

          // Fill in values
          unitData.flights.forEach((f, fIdx) => {
            const block = unitEl.querySelectorAll('.flight-block')[fIdx];
            if (block) {
              block.querySelector('textarea').value = f.text;
              block.querySelector('.layover-checkbox').checked = f.layover;
              const multiCheck = block.querySelector('.multiple-flights-checkbox');
              if (multiCheck) multiCheck.checked = f.multiple;
            }
          });
        }

        // Restore parsed state
        if (draft.currentFlights && draft.currentFlights.length > 0) {
          currentFlights = draft.currentFlights;
          currentFinalText = draft.currentFinalText || '';
          unitFlights = draft.unitFlights || unitFlights;

          renderResults(currentFlights);

          const outputElement = document.getElementById("output");
          if (outputElement && currentFinalText) {
            outputElement.textContent = currentFinalText;
          }
        }

        showNotification('Draft restored!', 'success');

        // Check if we should re-open the save modal
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('openSave') === '1') {
          setTimeout(openSaveModal, 800);
        }

        // ALWAYS clear draft and URL parameters after restoration to prevent loops on refresh
        localStorage.removeItem('flight_itinerary_draft');

        // Remove the restore and openSave params from URL without refreshing the page
        if (urlParams.has('restore') || urlParams.has('openSave')) {
          urlParams.delete('restore');
          urlParams.delete('openSave');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.replaceState({}, '', newUrl);
        }

      } catch (e) {
        console.error("Error loading draft:", e);
      }
    }

    function clearDraft() {
      localStorage.removeItem('flight_itinerary_draft');
      showNotification('Draft cleared', 'success');
      location.reload();
    }

    // --- Notification System ---
    function showNotification(message, type = 'success') {
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        document.body.appendChild(container);
      }

      const notif = document.createElement('div');
      notif.className = `notification ${type}`;

      const icon = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'âœ…';
      notif.innerHTML = `<span>${icon}</span><span>${message}</span>`;

      container.appendChild(notif);

      // Remove after 3s
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // --- Global Loader ---
    function showLoader() {
      let loader = document.getElementById('global-loader');
      if (!loader) {
        loader = document.createElement('div');
        loader.id = 'global-loader';
        loader.className = 'loader-overlay';
        loader.innerHTML = '<div class="loader-spinner"></div>';
        document.body.appendChild(loader);
      }
      // Force reflow
      loader.offsetHeight;
      loader.classList.add('active');
    }

    function hideLoader() {
      const loader = document.getElementById('global-loader');
      if (loader) {
        loader.classList.remove('active');
      }
    }

    // Close search results when clicking outside
    window.addEventListener('click', (e) => {
      // Billing search
      if (!e.target.closest('#billingSearchInput') && !e.target.closest('#billingSearchResults')) {
        const br = document.getElementById('billingSearchResults');
        if (br) br.style.display = 'none';
      }
      // Passenger search
      if (!e.target.closest('#savePassengerSearch') && !e.target.closest('#savePassengerResults')) {
        const pr = document.getElementById('savePassengerResults');
        if (pr) pr.style.display = 'none';
      }
    });
  </script>
  <!-- Particles Background -->
  <div id="tsparticles" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-10;"></div>

  <!-- TSParticles Library -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>

  <script>
    // --- Immediate Theme Initialization (Prevent Glitch) ---
    (function () {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      if (savedTheme === 'dark') {
        document.body.style.background = 'transparent';
      }
    })();

    async function updateParticleVisibility(theme) {
      const particles = document.getElementById('tsparticles');
      if (theme === 'dark') {
        if (particles) particles.style.display = 'block';
        document.body.style.background = 'transparent';
        await tsParticles.load("tsparticles", {
          background: { color: { value: "#020617" } },
          particles: {
            color: { value: ["#38bdf8", "#818cf8", "#c084fc"] },
            links: { color: "#64748b", distance: 150, enable: true, opacity: 0.2, width: 1 },
            move: { enable: true, speed: 0.8 },
            number: { value: 80 },
            opacity: { value: 0.5 },
            size: { value: { min: 1, max: 3 } }
          }
        });
      } else if (theme === 'valentine') {
        if (particles) particles.style.display = 'block';
        document.body.style.background = 'transparent';
        await tsParticles.load("tsparticles", {
          background: { color: { value: "#fff0f3" } },
          particles: {
            color: { value: ["#ff4d6d", "#ff758f", "#ff8da1", "#ffb6c1"] },
            shape: { type: "char", options: { char: { value: ["â¤ï¸", "ðŸ’–", "ðŸŒ¸", "ðŸŒ¹", "ðŸ’"] } } },
            opacity: { value: 0.8 },
            size: { value: { min: 10, max: 20 } },
            move: { enable: true, speed: 2, direction: "top", outModes: "out" },
            number: { value: 40 }
          }
        });
      } else {
        if (particles) particles.style.display = 'none';
        document.body.style.background = 'var(--bg-main)';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Particles are loaded inside updateParticleVisibility now for better switching

      // --- Sidebar & Theme Logic ---
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');

      if (menuToggle && sidebar && sidebarOverlay) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.add('active');
          sidebarOverlay.classList.add('active');
        });
      }

      const closeSidebar = () => {
        if (sidebar) sidebar.classList.remove('active');
        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
      };

      if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
      if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

      // Final theme sync
      const currentTheme = document.documentElement.getAttribute('data-theme');
      updateParticleVisibility(currentTheme);

      const themeToggle = document.getElementById('sidebarThemeToggle');
      const valToggle = document.getElementById('valentineToggle');
      const sidebarValToggle = document.getElementById('sidebarValentineToggle');

      const applyTheme = async (next) => {
        const curtain = document.getElementById('themeCurtain');
        const curtainIcon = document.getElementById('curtainIcon');

        // Only use curtains for Valentine Mode transitions
        if (curtain && (next === 'valentine' || document.documentElement.getAttribute('data-theme') === 'valentine')) {
          curtain.className = 'theme-curtain active';
          if (next === 'valentine') {
            curtain.classList.add('curtain-valentine');
            curtainIcon.textContent = 'ðŸ’–';
          } else if (next === 'dark') {
            curtain.classList.add('curtain-dark');
            curtainIcon.textContent = 'âœˆï¸';
          } else {
            curtain.classList.add('curtain-light');
            curtainIcon.textContent = 'ðŸ ';
          }
          await new Promise(r => setTimeout(r, 800));
        }

        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        await updateParticleVisibility(next);

        // Sync UI toggles immediately
        const activeIcon = document.querySelector('.theme-icon-container');
        const activeText = document.getElementById('themeToggleText');
        if (activeIcon && activeText) {
          activeIcon.textContent = next === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
          activeText.textContent = next === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        if (curtain && curtain.classList.contains('active')) {
          await new Promise(r => setTimeout(r, 100));
          curtain.classList.remove('active');
          setTimeout(() => {
            curtain.classList.remove('curtain-valentine', 'curtain-dark', 'curtain-light');
          }, 800);
        }
      };

      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme');
          const next = current === 'dark' ? 'light' : 'dark';
          applyTheme(next);
        });
      }

      const handleValentine = () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'valentine' ? 'light' : 'valentine';
        applyTheme(next);
      };

      if (valToggle) valToggle.addEventListener('click', handleValentine);
      if (sidebarValToggle) sidebarValToggle.addEventListener('click', handleValentine);
    });
  </script>
  <script>
    // --- Enhanced Billing & Capitalization Logic ---

    // 1. Capitalization Helper
    function capitalizeName(str) {
      if (!str) return '';
      // Capitalize first letter of each word
      return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    // 2. Billing Type Toggle
    function handleBillTypeChange() {
      const typeSelect = document.getElementById('newBillType');
      const corpFields = document.getElementById('corporateFields');
      if (typeSelect && corpFields) {
        const type = typeSelect.value;
        corpFields.style.display = (type === 'corporate') ? 'block' : 'none';
      }
    }

    // 3. Initialize & Attach Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial state for billing type
      handleBillTypeChange();
    });
  </script>
</body>

</html>