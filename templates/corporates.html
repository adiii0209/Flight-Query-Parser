<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Dashboard - Travel Agent Platform</title>
    <meta name="description" content="Manage corporate profiles, employees, promo codes, and billing">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/dashboard.css">
</head>

<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Drawer -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" id="sidebarClose">‚úï</button>
        <div class="sidebar-header">
            <div class="user-profile-section">
                <div class="user-avatar" id="sidebarAvatar">üë§</div>
                <div class="user-info">
                    <div class="user-name" id="sidebarUserName">Guest User</div>
                    <div class="user-email" id="sidebarUserEmail">Welcome!</div>
                </div>
            </div>
            <div class="auth-btn-container">
                <button class="sidebar-auth-btn" id="sidebarAuthBtn" onclick="handleAuthClick()">
                    üîê Login / Register
                </button>
            </div>
        </div>
        <div class="sidebar-body">
            <nav class="sidebar-nav">
                <a href="/" class="sidebar-link">üè† Home</a>
                <a href="/passengers" class="sidebar-link">üë§ Passengers</a>
                <a href="/corporates" class="sidebar-link active">üè¢ Corporates</a>
                <a href="/itineraries" class="sidebar-link">üìã Itineraries</a>
                <a href="/billing" class="sidebar-link">üí∞ Billing</a>
                <div style="margin-top: 1.5rem; padding: 0 0.5rem;">
                    <label class="input-label"
                        style="display: block; margin-bottom: 0.75rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);">Appearance</label>
                    <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer;"
                        id="sidebarThemeToggle">
                        <span class="theme-icon-container">üåô</span>
                        <span id="themeToggleText">Dark Mode</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div class="header-left">
                <h1 class="page-title">
                    <span class="title-icon">üè¢</span>
                    Corporate Dashboard
                </h1>
                <p class="page-subtitle">Manage corporate accounts, employees, and promo codes</p>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openCorporateModal()">
                    <span>‚ûï</span> Add Corporate
                </button>
                <button class="menu-toggle" id="menuToggle" aria-label="Open Menu">
                    <span class="menu-bar"></span>
                    <span class="menu-bar"></span>
                    <span class="menu-bar"></span>
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-info">
                    <div class="stat-value" id="totalCorporates">0</div>
                    <div class="stat-label">Total Corporates</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-info">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Linked Employees</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üé´</div>
                <div class="stat-info">
                    <div class="stat-value" id="totalPromoCodes">0</div>
                    <div class="stat-label">Active Promo Codes</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-info">
                    <div class="stat-value" id="totalCorpItineraries">0</div>
                    <div class="stat-label">Corporate Itineraries</div>
                </div>
            </div>
        </div>

        <!-- Corporates List -->
        <div class="section-header">
            <h2 class="section-title">All Corporates</h2>
            <div class="search-box">
                <input type="text" id="searchCorporates" placeholder="Search by name or GST..."
                    onkeyup="filterCorporates()">
                <span class="search-icon">üîç</span>
            </div>
        </div>

        <div id="corporatesContainer" class="cards-grid">
            <div class="empty-state">
                <div class="empty-icon">üè¢</div>
                <h3>Loading corporates...</h3>
            </div>
        </div>
    </div>

    <!-- Corporate Detail Modal -->
    <div class="modal-overlay" id="corporateDetailModal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2 id="corporateDetailTitle">Corporate Details</h2>
                <button class="modal-close" onclick="closeCorporateDetailModal()">‚úï</button>
            </div>
            <div class="modal-body" id="corporateDetailContent">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Corporate Modal -->
    <div class="modal-overlay" id="corporateModal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2 id="corporateModalTitle">Add Corporate</h2>
                <button class="modal-close" onclick="closeCorporateModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="corporateForm" onsubmit="saveCorporate(event)">
                    <input type="hidden" id="corporateId">

                    <div class="form-section">
                        <h3 class="form-section-title">Company Information</h3>
                        <div class="form-row">
                            <div class="form-group form-group-wide">
                                <label class="form-label required">Company Name</label>
                                <input type="text" id="companyName" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">GST Number</label>
                                <input type="text" id="gstNumber" class="form-input" placeholder="22AAAAA0000A1Z5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PAN Number</label>
                                <input type="text" id="panNumber" class="form-input" placeholder="AAAAA0000A">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Billing Address</h3>
                        <div class="form-row">
                            <div class="form-group form-group-wide">
                                <label class="form-label">Address Line 1</label>
                                <input type="text" id="billingAddress1" class="form-input">
                            </div>
                            <div class="form-group form-group-wide">
                                <label class="form-label">Address Line 2</label>
                                <input type="text" id="billingAddress2" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" id="billingCity" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">State</label>
                                <input type="text" id="billingState" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pincode</label>
                                <input type="text" id="billingPincode" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Country</label>
                                <input type="text" id="billingCountry" class="form-input" value="India">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Contact Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Person</label>
                                <input type="text" id="contactPerson" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="contactEmail" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" id="contactPhone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alternate Phone</label>
                                <input type="tel" id="contactAltPhone" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Payment & Internal</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Credit Limit (‚Çπ)</label>
                                <input type="number" id="creditLimit" class="form-input" step="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Terms (Days)</label>
                                <input type="number" id="paymentTerms" class="form-input" value="30">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group form-group-wide">
                                <label class="form-label">Internal Remarks</label>
                                <textarea id="internalRemarks" class="form-textarea" rows="2"
                                    placeholder="Notes visible only to agents"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCorporateModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Corporate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Link Employee Modal -->
    <div class="modal-overlay" id="linkEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Link Employee</h2>
                <button class="modal-close" onclick="closeLinkEmployeeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="linkEmployeeForm" onsubmit="saveLinkEmployee(event)">
                    <input type="hidden" id="linkCorporateId">

                    <div class="form-group">
                        <label class="form-label required">Select Passenger</label>
                        <select id="linkPassengerId" class="form-select" required>
                            <option value="">Select Passenger</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employee ID</label>
                            <input type="text" id="linkEmployeeId" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <input type="text" id="linkRole" class="form-input" placeholder="e.g., Manager">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" id="linkDepartment" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cost Center</label>
                            <input type="text" id="linkCostCenter" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="linkRequiresApproval">
                                <span>Requires Travel Approval</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Approval Limit (‚Çπ)</label>
                            <input type="number" id="linkApprovalLimit" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remarks</label>
                        <textarea id="linkRemarks" class="form-textarea" rows="2"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="closeLinkEmployeeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Link Employee</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Promo Code Modal -->
    <div class="modal-overlay" id="promoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Promo Code</h2>
                <button class="modal-close" onclick="closePromoModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="promoForm" onsubmit="savePromoCode(event)">
                    <input type="hidden" id="promoCorporateId">

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Airline</label>
                            <select id="promoAirline" class="form-select" required>
                                <option value="">Select Airline</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Promo Code</label>
                            <input type="text" id="promoCode" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Discount Type</label>
                            <select id="promoDiscountType" class="form-select">
                                <option value="">Select</option>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discount Value</label>
                            <input type="number" id="promoDiscountValue" class="form-input" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="promoDescription" class="form-input"
                            placeholder="e.g., 10% off on Business Class">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valid From</label>
                            <input type="date" id="promoValidFrom" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until</label>
                            <input type="date" id="promoValidUntil" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Uses</label>
                        <input type="number" id="promoMaxUses" class="form-input"
                            placeholder="Leave empty for unlimited">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePromoModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Promo Code</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirm</h2>
                <button class="modal-close" onclick="closeConfirmModal(false)">‚úï</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" class="confirm-message"></p>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeConfirmModal(false)">Cancel</button>
                    <button class="btn btn-danger" onclick="closeConfirmModal(true)">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global state
        let corporates = [];
        let passengers = [];
        let airlines = [];
        let currentCorporate = null;
        let confirmResolve = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initializeSidebar();
            await checkAuthStatus();
            await loadAirlines();
            await loadPassengers();
            await loadCorporates();
        });

        // Sidebar & Theme
        function initializeSidebar() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebar = document.getElementById('sidebar');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            const closeSidebar = () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            };

            sidebarClose.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            // Theme toggle
            const savedTheme = localStorage.getItem('theme') || 'light';
            updateTheme(savedTheme);
            document.getElementById('sidebarThemeToggle').addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', next);
                updateTheme(next);
            });
        }

        function updateTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const text = document.getElementById('themeToggleText');
            const icon = document.querySelector('.theme-icon-container');
            if (theme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
            }
        }

        // Auth
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('sidebarUserName').textContent = user.username;
                    document.getElementById('sidebarUserEmail').textContent = user.email || 'Member';
                    document.getElementById('sidebarAvatar').textContent = user.username.charAt(0).toUpperCase();

                    const authBtn = document.getElementById('sidebarAuthBtn');
                    authBtn.textContent = 'üö™ Logout';
                    authBtn.classList.add('logout');
                    authBtn.onclick = async () => {
                        const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?');
                        if (confirmed) {
                            await fetch('/api/logout', { method: 'POST' });
                            window.location.href = '/login';
                        }
                    };
                    return true;
                } else {
                    showLoginPrompt();
                    return false;
                }
            } catch (e) {
                showLoginPrompt();
                return false;
            }
        }

        function handleAuthClick() {
            const next = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = '/login?next=' + next;
        }

        function showLoginPrompt() {
            const next = encodeURIComponent(window.location.pathname + window.location.search);
            document.getElementById('corporatesContainer').innerHTML = `
        <div class="empty-state login-required">
          <div class="empty-icon">üîê</div>
          <h3>Login Required</h3>
          <p>Please login to manage corporates.</p>
          <a href="/login?next=${next}" class="btn btn-primary">Login / Register</a>
        </div>
      `;
        }

        // Load Data
        async function loadAirlines() {
            try {
                const response = await fetch('/api/v2/airlines');
                if (response.ok) {
                    const data = await response.json();
                    airlines = data.airlines;
                    populateAirlineDropdown();
                }
            } catch (e) {
                console.error('Failed to load airlines:', e);
            }
        }

        function populateAirlineDropdown() {
            const select = document.getElementById('promoAirline');
            if (select) {
                select.innerHTML = '<option value="">Select Airline</option>';
                airlines.forEach(airline => {
                    const option = document.createElement('option');
                    option.value = airline.id;
                    option.textContent = `${airline.iata_code} - ${airline.name}`;
                    select.appendChild(option);
                });
            }
        }

        async function loadPassengers() {
            try {
                const response = await fetch('/api/v2/passengers');
                if (response.ok) {
                    const data = await response.json();
                    passengers = data.passengers;
                }
            } catch (e) {
                console.error('Failed to load passengers:', e);
            }
        }

        function populatePassengerDropdown() {
            const select = document.getElementById('linkPassengerId');
            if (select) {
                select.innerHTML = '<option value="">Select Passenger</option>';
                passengers.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.full_name || `${p.first_name} ${p.last_name}`;
                    select.appendChild(option);
                });
            }
        }

        async function loadCorporates() {
            try {
                const response = await fetch('/api/v2/corporates');
                if (response.ok) {
                    const data = await response.json();
                    corporates = data.corporates;
                    renderCorporates();
                    updateStats();
                }
            } catch (e) {
                console.error('Failed to load corporates:', e);
                showNotification('Failed to load corporates', 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalCorporates').textContent = corporates.length;

            let totalEmployees = 0;
            let totalPromos = 0;

            corporates.forEach(c => {
                totalEmployees += c.passengers_count || 0;
                totalPromos += c.promo_codes_count || 0;
            });

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalPromoCodes').textContent = totalPromos;
        }

        function renderCorporates() {
            const container = document.getElementById('corporatesContainer');

            if (corporates.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üè¢</div>
            <h3>No Corporates Yet</h3>
            <p>Add your first corporate account to get started.</p>
            <button class="btn btn-primary" onclick="openCorporateModal()">‚ûï Add Corporate</button>
          </div>
        `;
                return;
            }

            container.innerHTML = corporates.map(c => `
        <div class="card corporate-card" data-id="${c.id}">
          <div class="card-header">
            <div class="card-avatar corporate-avatar">üè¢</div>
            <div class="card-title-section">
              <h3 class="card-title">${c.company_name}</h3>
              <span class="card-subtitle">${c.gst_number || 'No GST'}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="card-info-row">
              <span class="info-label">üë§ Contact</span>
              <span class="info-value">${c.contact_person_name || 'Not specified'}</span>
            </div>
            <div class="card-info-row">
              <span class="info-label">üìß Email</span>
              <span class="info-value">${c.contact_email || 'Not specified'}</span>
            </div>
            <div class="card-info-row">
              <span class="info-label">üìç City</span>
              <span class="info-value">${c.billing_city || 'Not specified'}</span>
            </div>
            <div class="card-badges">
              <span class="badge badge-info">${c.passengers_count || 0} Employees</span>
              <span class="badge badge-success">${c.promo_codes_count || 0} Promo Codes</span>
            </div>
          </div>
          <div class="card-actions">
            <button class="btn btn-icon" onclick="viewCorporateDetails('${c.id}')" title="View Details">üëÅÔ∏è</button>
            <button class="btn btn-icon" onclick="editCorporate('${c.id}')" title="Edit">‚úèÔ∏è</button>
            <button class="btn btn-icon btn-danger-icon" onclick="deleteCorporate('${c.id}')" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
        }

        function filterCorporates() {
            const search = document.getElementById('searchCorporates').value.toLowerCase();
            const filtered = corporates.filter(c =>
                (c.company_name || '').toLowerCase().includes(search) ||
                (c.gst_number || '').toLowerCase().includes(search) ||
                (c.contact_person_name || '').toLowerCase().includes(search) ||
                (c.contact_email || '').toLowerCase().includes(search)
            );

            const container = document.getElementById('corporatesContainer');
            if (filtered.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <h3>No Results</h3>
            <p>No corporates match your search.</p>
          </div>
        `;
                return;
            }

            const tempCorporates = corporates;
            corporates = filtered;
            renderCorporates();
            corporates = tempCorporates;
        }

        // View Corporate Details
        async function viewCorporateDetails(corporateId) {
            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}`);
                if (!response.ok) throw new Error('Failed to load corporate');

                currentCorporate = await response.json();
                renderCorporateDetails();
                document.getElementById('corporateDetailModal').classList.add('active');
            } catch (e) {
                showNotification('Failed to load corporate details', 'error');
            }
        }

        function renderCorporateDetails() {
            const c = currentCorporate;
            const content = document.getElementById('corporateDetailContent');

            document.getElementById('corporateDetailTitle').textContent = c.company_name;

            content.innerHTML = `
        <div class="detail-tabs">
          <button class="tab-btn active" onclick="showDetailTab('profile')">Profile</button>
          <button class="tab-btn" onclick="showDetailTab('employees')">Employees</button>
          <button class="tab-btn" onclick="showDetailTab('promoCodes')">Promo Codes</button>
          <button class="tab-btn" onclick="showDetailTab('itineraries')">Itineraries</button>
          <button class="tab-btn" onclick="showDetailTab('billing')">Billing Summary</button>
        </div>
        
        <div class="detail-content">
          <div id="tab-profile" class="tab-panel active">
            <div class="detail-section">
              <h4>Company Information</h4>
              <div class="detail-grid">
                <div class="detail-item detail-item-wide">
                  <span class="detail-label">Company Name</span>
                  <span class="detail-value">${c.company_name}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">GST Number</span>
                  <span class="detail-value gst-value">${c.gst_number || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">PAN Number</span>
                  <span class="detail-value">${c.pan_number || '-'}</span>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>Billing Address</h4>
              <div class="detail-grid">
                <div class="detail-item detail-item-wide">
                  <span class="detail-label">Address</span>
                  <span class="detail-value">${[c.billing_address_line1, c.billing_address_line2].filter(Boolean).join(', ') || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">City</span>
                  <span class="detail-value">${c.billing_city || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">State</span>
                  <span class="detail-value">${c.billing_state || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Pincode</span>
                  <span class="detail-value">${c.billing_pincode || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Country</span>
                  <span class="detail-value">${c.billing_country || '-'}</span>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>Contact Details</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Contact Person</span>
                  <span class="detail-value">${c.contact_person_name || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Email</span>
                  <span class="detail-value">${c.contact_email || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Phone</span>
                  <span class="detail-value">${c.contact_phone || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Alternate Phone</span>
                  <span class="detail-value">${c.contact_alternate_phone || '-'}</span>
                </div>
              </div>
            </div>
            
            <div class="detail-section">
              <h4>Payment & Internal</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Credit Limit</span>
                  <span class="detail-value">${c.credit_limit ? '‚Çπ' + c.credit_limit.toLocaleString() : '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Payment Terms</span>
                  <span class="detail-value">${c.payment_terms_days || 30} days</span>
                </div>
                <div class="detail-item detail-item-wide">
                  <span class="detail-label">Internal Remarks</span>
                  <span class="detail-value">${c.internal_remarks || '-'}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div id="tab-employees" class="tab-panel">
            <div class="detail-section">
              <div class="section-header-inline">
                <h4>Linked Employees</h4>
                <button class="btn btn-sm btn-primary" onclick="openLinkEmployeeModal('${c.id}')">‚ûï Link Employee</button>
              </div>
              <div id="employeesList" class="items-list">
                ${renderEmployeesList(c.passengers || [])}
              </div>
            </div>
          </div>
          
          <div id="tab-promoCodes" class="tab-panel">
            <div class="detail-section">
              <div class="section-header-inline">
                <h4>Airline Promo Codes</h4>
                <button class="btn btn-sm btn-primary" onclick="openPromoModal('${c.id}')">‚ûï Add Promo Code</button>
              </div>
              <div id="promoCodesList" class="items-list">
                ${renderPromoCodesList(c.promo_codes || [])}
              </div>
            </div>
          </div>
          
          <div id="tab-itineraries" class="tab-panel">
            <div class="detail-section">
              <h4>Corporate Itineraries</h4>
              <div id="corporateItineraries" class="items-list">
                ${renderItinerariesList(c.itineraries || [])}
              </div>
            </div>
          </div>
          
          <div id="tab-billing" class="tab-panel">
            <div class="detail-section">
              <h4>Billing Summary</h4>
              <div class="billing-summary">
                <div class="billing-card">
                  <div class="billing-icon">üìä</div>
                  <div class="billing-info">
                    <div class="billing-value" id="totalBilled">‚Çπ0</div>
                    <div class="billing-label">Total Billed</div>
                  </div>
                </div>
                <div class="billing-card">
                  <div class="billing-icon">üìã</div>
                  <div class="billing-info">
                    <div class="billing-value" id="totalItineraries">${c.itineraries?.length || 0}</div>
                    <div class="billing-label">Total Itineraries</div>
                  </div>
                </div>
                <div class="billing-card">
                  <div class="billing-icon">‚úÖ</div>
                  <div class="billing-info">
                    <div class="billing-value" id="approvedCount">0</div>
                    <div class="billing-label">Approved</div>
                  </div>
                </div>
                <div class="billing-card">
                  <div class="billing-icon">‚è≥</div>
                  <div class="billing-info">
                    <div class="billing-value" id="pendingCount">0</div>
                    <div class="billing-label">Pending Approval</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

            // Calculate billing summary
            if (c.itineraries && c.itineraries.length > 0) {
                let totalBilled = 0;
                let approved = 0;
                let pending = 0;

                c.itineraries.forEach(it => {
                    totalBilled += it.total_amount || 0;
                    if (it.status === 'approved') approved++;
                    if (it.status === 'pending_approval') pending++;
                });

                document.getElementById('totalBilled').textContent = '‚Çπ' + totalBilled.toLocaleString();
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('pendingCount').textContent = pending;
            }
        }

        function renderEmployeesList(employees) {
            if (!employees || employees.length === 0) {
                return '<p class="empty-text">No employees linked. Click "Link Employee" to add.</p>';
            }

            return employees.map(emp => `
        <div class="list-item employee-item">
          <div class="list-item-avatar">${(emp.passenger_name || 'E').charAt(0).toUpperCase()}</div>
          <div class="list-item-info">
            <span class="list-item-title">${emp.passenger_name || 'Unknown'}</span>
            <span class="list-item-subtitle">${emp.role || 'No Role'} ${emp.department ? `‚Ä¢ ${emp.department}` : ''}</span>
            ${emp.employee_id ? `<span class="list-item-meta">ID: ${emp.employee_id}</span>` : ''}
          </div>
          <div class="list-item-actions">
            ${emp.requires_approval ? '<span class="badge badge-warning">Needs Approval</span>' : ''}
            <button class="btn btn-icon btn-danger-icon" onclick="unlinkEmployee('${currentCorporate.id}', '${emp.id}')" title="Unlink">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
        }

        function renderPromoCodesList(promoCodes) {
            if (!promoCodes || promoCodes.length === 0) {
                return '<p class="empty-text">No promo codes added. Click "Add Promo Code" to add.</p>';
            }

            return promoCodes.map(promo => {
                const isExpired = promo.valid_until && new Date(promo.valid_until) < new Date();
                return `
          <div class="list-item promo-item ${isExpired ? 'expired' : ''}">
            <div class="list-item-info">
              <span class="list-item-title">${promo.airline_code} - ${promo.promo_code}</span>
              <span class="list-item-subtitle">${promo.description || 'No description'}</span>
              ${promo.valid_until ? `<span class="list-item-meta">Valid until: ${promo.valid_until}</span>` : ''}
            </div>
            <div class="list-item-actions">
              ${promo.discount_value ? `<span class="badge badge-success">${promo.discount_type === 'percentage' ? promo.discount_value + '%' : '‚Çπ' + promo.discount_value}</span>` : ''}
              ${isExpired ? '<span class="badge badge-danger">Expired</span>' : ''}
              <button class="btn btn-icon btn-danger-icon" onclick="deletePromoCode('${currentCorporate.id}', '${promo.id}')" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
            }).join('');
        }

        function renderItinerariesList(itineraries) {
            if (!itineraries || itineraries.length === 0) {
                return '<p class="empty-text">No itineraries for this corporate yet.</p>';
            }

            return itineraries.map(it => `
        <div class="list-item itinerary-item">
          <div class="list-item-info">
            <span class="list-item-title">${it.title || 'Untitled Itinerary'}</span>
            <span class="list-item-subtitle">${new Date(it.created_at).toLocaleDateString()} ‚Ä¢ ${it.passenger?.full_name || it.passenger?.first_name || 'Unknown Passenger'}</span>
            <span class="list-item-meta">${it.total_amount ? '‚Çπ' + it.total_amount.toLocaleString() : ''}</span>
          </div>
          <div class="list-item-actions">
            <span class="badge badge-status badge-${it.status}">${it.status}</span>
            ${it.status === 'pending_approval' && it.selected_flight_option !== null ? `
              <button class="btn btn-sm btn-success" onclick="approveItinerary('${it.id}')">‚úì Approve</button>
            ` : ''}
            <button class="btn btn-icon" onclick="window.location.href='/itineraries-v2?id=${it.id}'" title="View">üëÅÔ∏è</button>
          </div>
        </div>
      `).join('');
        }

        function showDetailTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function closeCorporateDetailModal() {
            document.getElementById('corporateDetailModal').classList.remove('active');
            currentCorporate = null;
        }

        // Corporate CRUD
        function openCorporateModal(corporate = null) {
            const form = document.getElementById('corporateForm');
            form.reset();

            if (corporate) {
                document.getElementById('corporateModalTitle').textContent = 'Edit Corporate';
                document.getElementById('corporateId').value = corporate.id;
                document.getElementById('companyName').value = corporate.company_name || '';
                document.getElementById('gstNumber').value = corporate.gst_number || '';
                document.getElementById('panNumber').value = corporate.pan_number || '';
                document.getElementById('billingAddress1').value = corporate.billing_address_line1 || '';
                document.getElementById('billingAddress2').value = corporate.billing_address_line2 || '';
                document.getElementById('billingCity').value = corporate.billing_city || '';
                document.getElementById('billingState').value = corporate.billing_state || '';
                document.getElementById('billingPincode').value = corporate.billing_pincode || '';
                document.getElementById('billingCountry').value = corporate.billing_country || 'India';
                document.getElementById('contactPerson').value = corporate.contact_person_name || '';
                document.getElementById('contactEmail').value = corporate.contact_email || '';
                document.getElementById('contactPhone').value = corporate.contact_phone || '';
                document.getElementById('contactAltPhone').value = corporate.contact_alternate_phone || '';
                document.getElementById('creditLimit').value = corporate.credit_limit || '';
                document.getElementById('paymentTerms').value = corporate.payment_terms_days || 30;
                document.getElementById('internalRemarks').value = corporate.internal_remarks || '';
            } else {
                document.getElementById('corporateModalTitle').textContent = 'Add Corporate';
                document.getElementById('corporateId').value = '';
            }

            document.getElementById('corporateModal').classList.add('active');
        }

        function closeCorporateModal() {
            document.getElementById('corporateModal').classList.remove('active');
        }

        async function saveCorporate(event) {
            event.preventDefault();

            const corporateId = document.getElementById('corporateId').value;
            const isEdit = !!corporateId;

            const data = {
                company_name: document.getElementById('companyName').value,
                gst_number: document.getElementById('gstNumber').value,
                pan_number: document.getElementById('panNumber').value,
                billing_address_line1: document.getElementById('billingAddress1').value,
                billing_address_line2: document.getElementById('billingAddress2').value,
                billing_city: document.getElementById('billingCity').value,
                billing_state: document.getElementById('billingState').value,
                billing_pincode: document.getElementById('billingPincode').value,
                billing_country: document.getElementById('billingCountry').value,
                contact_person_name: document.getElementById('contactPerson').value,
                contact_email: document.getElementById('contactEmail').value,
                contact_phone: document.getElementById('contactPhone').value,
                contact_alternate_phone: document.getElementById('contactAltPhone').value,
                credit_limit: document.getElementById('creditLimit').value ? parseFloat(document.getElementById('creditLimit').value) : null,
                payment_terms_days: parseInt(document.getElementById('paymentTerms').value) || 30,
                internal_remarks: document.getElementById('internalRemarks').value
            };

            try {
                const url = isEdit ? `/api/v2/corporates/${corporateId}` : '/api/v2/corporates';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification(`Corporate ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                    closeCorporateModal();
                    await loadCorporates();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save corporate', 'error');
                }
            } catch (e) {
                showNotification('Failed to save corporate', 'error');
            }
        }

        async function editCorporate(corporateId) {
            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}`);
                if (response.ok) {
                    const corporate = await response.json();
                    openCorporateModal(corporate);
                }
            } catch (e) {
                showNotification('Failed to load corporate', 'error');
            }
        }

        async function deleteCorporate(corporateId) {
            const confirmed = await showConfirm('Delete Corporate', 'Are you sure you want to delete this corporate? This will also remove all linked employees and promo codes.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Corporate deleted successfully', 'success');
                    await loadCorporates();
                } else {
                    showNotification('Failed to delete corporate', 'error');
                }
            } catch (e) {
                showNotification('Failed to delete corporate', 'error');
            }
        }

        // Link Employee
        function openLinkEmployeeModal(corporateId) {
            document.getElementById('linkEmployeeForm').reset();
            document.getElementById('linkCorporateId').value = corporateId;
            populatePassengerDropdown();
            document.getElementById('linkEmployeeModal').classList.add('active');
        }

        function closeLinkEmployeeModal() {
            document.getElementById('linkEmployeeModal').classList.remove('active');
        }

        async function saveLinkEmployee(event) {
            event.preventDefault();

            const corporateId = document.getElementById('linkCorporateId').value;
            const data = {
                passenger_id: document.getElementById('linkPassengerId').value,
                employee_id: document.getElementById('linkEmployeeId').value,
                role: document.getElementById('linkRole').value,
                department: document.getElementById('linkDepartment').value,
                cost_center: document.getElementById('linkCostCenter').value,
                requires_approval: document.getElementById('linkRequiresApproval').checked,
                approval_limit: document.getElementById('linkApprovalLimit').value ? parseFloat(document.getElementById('linkApprovalLimit').value) : null,
                remarks: document.getElementById('linkRemarks').value
            };

            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}/passengers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('Employee linked successfully', 'success');
                    closeLinkEmployeeModal();
                    await viewCorporateDetails(corporateId);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to link employee', 'error');
                }
            } catch (e) {
                showNotification('Failed to link employee', 'error');
            }
        }

        async function unlinkEmployee(corporateId, linkId) {
            const confirmed = await showConfirm('Unlink Employee', 'Remove this employee from the corporate?');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}/passengers/${linkId}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Employee unlinked', 'success');
                    await viewCorporateDetails(corporateId);
                }
            } catch (e) {
                showNotification('Failed to unlink employee', 'error');
            }
        }

        // Promo Codes
        function openPromoModal(corporateId) {
            document.getElementById('promoForm').reset();
            document.getElementById('promoCorporateId').value = corporateId;
            document.getElementById('promoModal').classList.add('active');
        }

        function closePromoModal() {
            document.getElementById('promoModal').classList.remove('active');
        }

        async function savePromoCode(event) {
            event.preventDefault();

            const corporateId = document.getElementById('promoCorporateId').value;
            const data = {
                airline_id: document.getElementById('promoAirline').value,
                promo_code: document.getElementById('promoCode').value,
                discount_type: document.getElementById('promoDiscountType').value,
                discount_value: document.getElementById('promoDiscountValue').value ? parseFloat(document.getElementById('promoDiscountValue').value) : null,
                description: document.getElementById('promoDescription').value,
                valid_from: document.getElementById('promoValidFrom').value || null,
                valid_until: document.getElementById('promoValidUntil').value || null,
                max_uses: document.getElementById('promoMaxUses').value ? parseInt(document.getElementById('promoMaxUses').value) : null
            };

            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}/promo-codes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification('Promo code added', 'success');
                    closePromoModal();
                    await viewCorporateDetails(corporateId);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to add promo code', 'error');
                }
            } catch (e) {
                showNotification('Failed to add promo code', 'error');
            }
        }

        async function deletePromoCode(corporateId, promoId) {
            const confirmed = await showConfirm('Delete Promo Code', 'Delete this promo code?');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/v2/corporates/${corporateId}/promo-codes/${promoId}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Promo code deleted', 'success');
                    await viewCorporateDetails(corporateId);
                }
            } catch (e) {
                showNotification('Failed to delete promo code', 'error');
            }
        }

        // Approve Itinerary
        async function approveItinerary(itineraryId) {
            const confirmed = await showConfirm('Approve Itinerary', 'Approve this itinerary? This action cannot be undone.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/v2/itineraries/${itineraryId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showNotification('Itinerary approved', 'success');
                    await viewCorporateDetails(currentCorporate.id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to approve', 'error');
                }
            } catch (e) {
                showNotification('Failed to approve itinerary', 'error');
            }
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.add('active');
            });
        }

        function closeConfirmModal(result) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }
    </script>
</body>

</html>