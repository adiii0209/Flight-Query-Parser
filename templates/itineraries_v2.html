<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Itineraries - Travel Agent Platform</title>
  <meta name="description" content="Manage flight itineraries, approvals, and bookings">
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/static/dashboard.css">
  <style>
    /* Passenger Management Styles */
    .passenger-manager-section {
      margin-top: 2rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1.5rem;
    }

    /* Pax Detail Modal Tabs */
    .detail-tabs {
      display: flex;
      gap: 1rem;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
    }

    .detail-tabs .tab-btn {
      background: none;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      font-family: inherit;
    }

    .detail-tabs .tab-btn.active {
      color: var(--primary-color);
    }

    .detail-tabs .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -0.5rem;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-color);
    }

    .pax-tab-panel {
      display: none;
    }

    .pax-tab-panel.active {
      display: block;
    }

    .ff-badge,
    .doc-badge {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg-main);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
    }

    .btn-delete-small {
      background: none;
      border: none;
      color: var(--accent-danger);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1rem;
      margin-left: auto;
    }

    .passenger-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .passenger-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .passenger-mini-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      transition: all 0.2s;
    }

    .passenger-mini-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      background: var(--hover-bg);
    }

    .passenger-mini-card .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .passenger-mini-card .info {
      flex: 1;
    }

    .passenger-mini-card .name {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .passenger-mini-card .type {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .btn-remove-p {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.25rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .btn-remove-p:hover {
      opacity: 1;
    }

    .search-dropdown-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .text-muted {
      color: var(--text-secondary);
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: var(--hover-bg);
    }

    .num-passengers-input {
      width: 80px;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .add-new-p-form {
      background: var(--hover-bg);
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .passenger-mini-card .name-link {
      color: var(--primary-color);
      cursor: pointer;
      text-decoration: none;
      transition: color 0.2s;
    }

    .passenger-mini-card .name-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .btn-quick-add {
      background: var(--accent-success-light);
      color: var(--accent-success);
      border: 1px solid var(--accent-success);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
      margin-left: auto;
    }

    .btn-quick-add:hover {
      background: var(--accent-success);
      color: white;
      transform: scale(1.1);
    }

    .profile-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .profile-section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.25rem;
    }

    .profile-item {
      margin-bottom: 0.75rem;
    }

    .profile-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .profile-value {
      display: block;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .ff-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .pref-tag {
      display: inline-block;
      padding: 0.25rem 0.65rem;
      background: var(--accent-info-light);
      color: var(--accent-info);
      border-radius: 4px;
      margin-right: 0.4rem;
      margin-bottom: 0.4rem;
      font-size: 0.75rem;
    }

    /* Collapsible Section Styles */
    .detail-section.collapsible {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1.5rem;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: var(--bg-tertiary);
      cursor: pointer;
      margin: 0 !important;
      transition: background 0.2s;
    }

    .collapsible-header:hover {
      background: var(--hover-bg);
    }

    .collapsible-content {
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .collapsible-content.collapsed {
      display: none;
    }

    .collapse-icon {
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: transform 0.3s;
    }
  </style>
</head>

<body>
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Drawer -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" id="sidebarClose">‚úï</button>
    <div class="sidebar-header">
      <div class="user-profile-section">
        <div class="user-avatar" id="sidebarAvatar">üë§</div>
        <div class="user-info">
          <div class="user-name" id="sidebarUserName">Guest User</div>
          <div class="user-email" id="sidebarUserEmail">Welcome!</div>
        </div>
      </div>
      <div class="auth-btn-container">
        <button class="sidebar-auth-btn" id="sidebarAuthBtn" onclick="handleAuthClick()">
          üîê Login / Register
        </button>
      </div>
    </div>
    <div class="sidebar-body">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link">üè† Home</a>
        <a href="/passengers" class="sidebar-link">üë§ Passengers</a>
        <a href="/corporates" class="sidebar-link">üè¢ Corporates</a>
        <a href="/itineraries-v2" class="sidebar-link active">üìã Itineraries</a>
        <div style="margin-top: 1.5rem; padding: 0 0.5rem;">
          <label class="input-label"
            style="display: block; margin-bottom: 0.75rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);">Appearance</label>
          <button class="sidebar-link" style="width: 100%; border: none; cursor: pointer;" id="sidebarThemeToggle">
            <span class="theme-icon-container">üåô</span>
            <span id="themeToggleText">Dark Mode</span>
          </button>
        </div>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="page-header">
      <div class="header-left">
        <h1 class="page-title">
          <span class="title-icon">üìã</span>
          Itineraries
        </h1>
        <p class="page-subtitle">Manage and track all flight itineraries</p>
      </div>
      <div class="header-right">
        <a href="/" class="btn btn-primary">
          <span>‚úàÔ∏è</span> Create Itinerary
        </a>
        <button class="menu-toggle" id="menuToggle" aria-label="Open Menu">
          <span class="menu-bar"></span>
          <span class="menu-bar"></span>
          <span class="menu-bar"></span>
        </button>
      </div>
    </header>

    <!-- Stats Cards -->
    <div class="stats-row">
      <div class="stat-card clickable" onclick="filterByStatus('')">
        <div class="stat-icon">üìã</div>
        <div class="stat-info">
          <div class="stat-value" id="totalItineraries">0</div>
          <div class="stat-label">Total</div>
        </div>
      </div>
      <div class="stat-card clickable" onclick="filterByStatus('draft')">
        <div class="stat-icon">üìù</div>
        <div class="stat-info">
          <div class="stat-value" id="draftCount">0</div>
          <div class="stat-label">Drafts</div>
        </div>
      </div>
      <div class="stat-card clickable" onclick="filterByStatus('pending_approval')">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-info">
          <div class="stat-value" id="pendingCount">0</div>
          <div class="stat-label">Pending</div>
        </div>
      </div>
      <div class="stat-card clickable" onclick="filterByStatus('approved')">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
          <div class="stat-value" id="approvedCount">0</div>
          <div class="stat-label">Approved</div>
        </div>
      </div>
    </div>

    <!-- Filters & Search -->
    <div class="filters-row">
      <div class="filter-group">
        <select id="statusFilter" class="filter-select" onchange="applyFilters()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="pending_approval">Pending Approval</option>
          <option value="approved">Approved</option>
          <option value="booked">Booked</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <select id="billingFilter" class="filter-select" onchange="applyFilters()">
          <option value="">All Billing Types</option>
          <option value="passenger">Individual</option>
          <option value="corporate">Corporate</option>
        </select>
      </div>
      <div class="search-box">
        <input type="text" id="searchItineraries" placeholder="Search itineraries..." onkeyup="applyFilters()">
        <span class="search-icon">üîç</span>
      </div>
    </div>

    <!-- Itineraries List -->
    <div id="itinerariesContainer" class="itineraries-list">
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>Loading itineraries...</h3>
      </div>
    </div>
  </div>

  <!-- Itinerary Detail Modal -->
  <div class="modal-overlay" id="itineraryDetailModal">
    <div class="modal-content modal-xl">
      <div class="modal-header">
        <h2 id="itineraryDetailTitle">Itinerary Details</h2>
        <button class="modal-close" onclick="closeItineraryDetailModal()">‚úï</button>
      </div>
      <div class="modal-body" id="itineraryDetailContent">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Passenger Management Modal -->
  <div class="modal-overlay" id="passengerManagementModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Manage Passengers</h2>
        <button class="modal-close" onclick="closePassengerManagementModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <h3 class="form-section-title">Number of Passengers</h3>
          <div class="form-group">
            <label class="form-label">Total Passengers</label>
            <input type="number" id="manageNumPassengers" class="form-input num-passengers-input" min="1" value="1">
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Add / Select Passengers</h3>

          <div class="search-dropdown-container">
            <input type="text" id="passengerSearchInput" class="form-input" placeholder="Search existing passengers..."
              oninput="handlePassengerSearch()" onclick="handlePassengerSearch()" onfocus="handlePassengerSearch()">
            <div id="passengerSearchResults" class="search-results">
              <!-- Search results will appear here -->
            </div>
          </div>

          <div class="or-divider"
            style="text-align: center; margin: 1rem 0; color: var(--text-secondary); font-size: 0.8rem;">OR</div>

          <button class="btn btn-secondary btn-sm" onclick="toggleNewPassengerForm()" style="width: 100%;">
            <span>‚ûï</span> Add New Temporary Passenger Info
          </button>

          <div id="newPassengerForm" class="add-new-p-form" style="display: none;">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" id="newPFirstName" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" id="newPLastName" class="form-input">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="newPEmail" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" id="newPPhone" class="form-input">
              </div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="addNewTempPassenger()" style="margin-top: 1rem;">
              Add to List
            </button>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Assigned Passengers</h3>
          <div id="assignedPassengersList" class="passenger-grid">
            <!-- Assigned passengers will appear here -->
          </div>
        </div>
      </div>
      <div class="modal-footer"
        style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem;">
        <button class="btn btn-secondary" onclick="closePassengerManagementModal()">Cancel</button>
        <button class="btn btn-primary" onclick="savePassengerChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Billing Management Modal -->
  <div class="modal-overlay" id="billingManagementModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Manage Billing</h2>
        <button class="modal-close" onclick="closeBillingManagementModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label class="form-label">Search Billing Account / Customer</label>
          <div style="position:relative;">
            <input type="text" id="manageBillingSearchInput" class="form-input" placeholder="Start typing to search..."
              oninput="searchBillingInManager()" onclick="searchBillingInManager()" onfocus="searchBillingInManager()">
            <div id="manageBillingSearchResults" class="search-results"
              style="display:none; width:100%; top:100%; z-index:10000; position:absolute; background:var(--bg-card); border:1px solid var(--border); max-height:200px; overflow-y:auto;">
            </div>
          </div>
          <input type="hidden" id="manageSelectedBillingId">
        </div>

        <div id="manageBillingSummary"
          style="margin-top:20px; padding:15px; border:1px solid var(--border); border-radius:8px; display:none; background:var(--bg-main);">
          <strong>Selected Billing:</strong> <span id="manageSelectedName"
            style="color:var(--primary); font-weight:600;"></span>
          <div id="manageSelectedDetails" style="font-size:0.9em; color:var(--text-secondary); margin-top:5px;"></div>
        </div>
      </div>
      <div class="modal-footer"
        style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem;">
        <button class="btn btn-secondary" onclick="closeBillingManagementModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBillingChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Full Passenger Management Modal -->
  <div class="modal-overlay" id="paxDetailModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="paxDetailTitle">Manage Passenger</h2>
        <button class="modal-close" onclick="closePaxDetailModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="detail-tabs">
          <button class="tab-btn active" id="btn-tab-profile" onclick="showPaxTab('profile')">Profile</button>
          <button class="tab-btn" id="btn-tab-documents" onclick="showPaxTab('documents')">Documents</button>
          <button class="tab-btn" id="btn-tab-ff" onclick="showPaxTab('ff')">Frequent Flyer</button>
          <button class="tab-btn" id="btn-tab-prefs" onclick="showPaxTab('prefs')">Preferences</button>
        </div>

        <!-- Profile Tab -->
        <div id="pax-tab-profile" class="pax-tab-panel active">
          <form id="paxProfileForm" onsubmit="savePaxProfile(event)">
            <input type="hidden" id="editPaxId">
            <div class="form-section">
              <h3 class="form-section-title">Personal Information</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Title</label>
                  <select id="editPaxTitle" class="form-select">
                    <option value="">Select</option>
                    <option value="Mr">Mr</option>
                    <option value="Mrs">Mrs</option>
                    <option value="Ms">Ms</option>
                    <option value="Dr">Dr</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">First Name</label>
                  <input type="text" id="editPaxFirstName" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Middle Name</label>
                  <input type="text" id="editPaxMiddleName" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Last Name</label>
                  <input type="text" id="editPaxLastName" class="form-input" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Date of Birth</label>
                  <input type="date" id="editPaxDOB" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Gender</label>
                  <select id="editPaxGender" class="form-select">
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nationality</label>
                  <input type="text" id="editPaxNationality" class="form-input">
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Contact Information</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" id="editPaxEmail" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" id="editPaxPhone" class="form-input">
                </div>
              </div>
            </div>

            <div class="modal-footer"
              style="padding: 1.5rem 0 0 0; display: flex; justify-content: flex-end; gap: 1rem;">
              <button type="submit" class="btn btn-primary">Update Profile</button>
            </div>
          </form>
        </div>

        <!-- Documents Tab -->
        <div id="pax-tab-documents" class="pax-tab-panel">
          <div id="paxDocList" style="margin-bottom: 1.5rem;"></div>

          <div class="form-section" style="border-top: 1px solid var(--border-light); padding-top: 1rem;">
            <h3 class="form-section-title">Add Travel Document</h3>
            <form id="paxDocForm" onsubmit="savePaxDoc(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Type</label>
                  <select id="docType" class="form-select" required>
                    <option value="PASSPORT">Passport</option>
                    <option value="VISA">Visa</option>
                    <option value="ID_CARD">National ID</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Number</label>
                  <input type="text" id="docNumber" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Expiry Date</label>
                  <input type="date" id="docExpiry" class="form-input" required>
                </div>
              </div>
              <button type="submit" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">Add Document</button>
            </form>
          </div>
        </div>

        <!-- FF Tab -->
        <div id="pax-tab-ff" class="pax-tab-panel">
          <div id="paxFfList" style="margin-bottom: 1.5rem;"></div>

          <div class="form-section" style="border-top: 1px solid var(--border-light); padding-top: 1rem;">
            <h3 class="form-section-title">Add Frequent Flyer Account</h3>
            <form id="paxFfForm" onsubmit="savePaxFf(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Airline</label>
                  <select id="ffAirline" class="form-select" required>
                    <option value="">Select Airline</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">FF Number</label>
                  <input type="text" id="ffNumber" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Tier</label>
                  <input type="text" id="ffTier" class="form-input" placeholder="e.g. Gold">
                </div>
              </div>
              <button type="submit" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">Add FF Account</button>
            </form>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div id="pax-tab-prefs" class="pax-tab-panel">
          <form id="paxPrefsForm" onsubmit="savePaxPrefs(event)">
            <div class="form-section">
              <h3 class="form-section-title">Meal & Seat</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Meal Preference</label>
                  <select id="editPrefsMeal" class="form-select">
                    <option value="">No Preference</option>
                    <option value="Vegetarian">Vegetarian</option>
                    <option value="Non-Vegetarian">Non-Vegetarian</option>
                    <option value="Vegan">Vegan</option>
                    <option value="Jain">Jain</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Seat Preference</label>
                  <select id="editPrefsSeat" class="form-select">
                    <option value="">No Preference</option>
                    <option value="Window">Window</option>
                    <option value="Aisle">Aisle</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-top:1rem;">
                <label class="form-label">Special Meal Request</label>
                <input type="text" id="editPrefsMealReq" class="form-input">
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Assistance & Airlines</h3>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Assistance Type</label>
                  <select id="editPrefsAssistance" class="form-select">
                    <option value="">None</option>
                    <option value="WCHR">WCHR - Wheelchair</option>
                    <option value="BLND">BLND - Blind</option>
                    <option value="DEAF">DEAF - Deaf</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="checkbox-label"
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 2rem;">
                    <input type="checkbox" id="editPrefsWheelchair">
                    <span>Wheelchair Required</span>
                  </label>
                </div>
              </div>
              <div class="form-row" style="margin-top:1rem;">
                <div class="form-group">
                  <label class="form-label">Preferred Airlines</label>
                  <input type="text" id="editPrefsPrefAir" class="form-input" placeholder="AI, UK">
                </div>
                <div class="form-group">
                  <label class="form-label">Avoid Airlines</label>
                  <input type="text" id="editPrefsAvoidAir" class="form-input" placeholder="SG">
                </div>
              </div>
            </div>

            <div class="modal-footer"
              style="padding: 1.5rem 0 0 0; display: flex; justify-content: flex-end; gap: 1rem;">
              <button type="submit" class="btn btn-primary">Save Preferences</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
        <button class="modal-close" onclick="closeConfirmModal(false)">‚úï</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="confirm-message"></p>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeConfirmModal(false)">Cancel</button>
          <button class="btn btn-danger" onclick="closeConfirmModal(true)">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script>
    // Global state
    let itineraries = [];
    let filteredItineraries = [];
    let currentItinerary = null;
    let currentPassenger = null;
    let airlines = [];
    let confirmResolve = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      initializeSidebar();
      await checkAuthStatus();
      await loadAirlines();
      await loadItineraries();

      // Check URL for specific itinerary
      const urlParams = new URLSearchParams(window.location.search);
      const itineraryId = urlParams.get('id');
      if (itineraryId) {
        viewItineraryDetails(itineraryId);
      }
    });

    // Sidebar & Theme
    function initializeSidebar() {
      const menuToggle = document.getElementById('menuToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebar = document.getElementById('sidebar');

      menuToggle.addEventListener('click', () => {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      const closeSidebar = () => {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      };

      sidebarClose.addEventListener('click', closeSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);

      // Theme toggle
      const savedTheme = localStorage.getItem('theme') || 'light';
      updateTheme(savedTheme);
      document.getElementById('sidebarThemeToggle').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', next);
        updateTheme(next);
      });
    }

    function updateTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const text = document.getElementById('themeToggleText');
      const icon = document.querySelector('.theme-icon-container');
      if (theme === 'dark') {
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Light Mode';
      } else {
        icon.textContent = 'üåô';
        text.textContent = 'Dark Mode';
      }
    }

    // Auth
    async function checkAuthStatus() {
      try {
        const response = await fetch('/api/user');
        if (response.ok) {
          const user = await response.json();
          document.getElementById('sidebarUserName').textContent = user.username;
          document.getElementById('sidebarUserEmail').textContent = user.email || 'Member';
          document.getElementById('sidebarAvatar').textContent = user.username.charAt(0).toUpperCase();

          const authBtn = document.getElementById('sidebarAuthBtn');
          authBtn.textContent = 'üö™ Logout';
          authBtn.classList.add('logout');
          authBtn.onclick = async () => {
            const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?');
            if (confirmed) {
              await fetch('/api/logout', { method: 'POST' });
              window.location.href = '/login';
            }
          };
          return true;
        } else {
          showLoginPrompt();
          return false;
        }
      } catch (e) {
        showLoginPrompt();
        return false;
      }
    }

    function handleAuthClick() {
      window.location.href = '/login';
    }

    function showLoginPrompt() {
      document.getElementById('itinerariesContainer').innerHTML = `
        <div class="empty-state login-required">
          <div class="empty-icon">üîê</div>
          <h3>Login Required</h3>
          <p>Please login to manage itineraries.</p>
          <a href="/login" class="btn btn-primary">Login / Register</a>
        </div>
      `;
    }

    // Load Data
    async function loadItineraries() {
      try {
        const response = await fetch('/api/v2/itineraries');
        if (response.ok) {
          const data = await response.json();
          itineraries = data.itineraries;
          filteredItineraries = [...itineraries];
          updateStats();
          renderItineraries();
        }
      } catch (e) {
        console.error('Failed to load itineraries:', e);
        showNotification('Failed to load itineraries', 'error');
      }
    }

    function updateStats() {
      document.getElementById('totalItineraries').textContent = itineraries.length;
      document.getElementById('draftCount').textContent = itineraries.filter(i => i.status === 'draft').length;
      document.getElementById('pendingCount').textContent = itineraries.filter(i => i.status === 'pending_approval').length;
      document.getElementById('approvedCount').textContent = itineraries.filter(i => i.status === 'approved').length;
    }

    function filterByStatus(status) {
      document.getElementById('statusFilter').value = status;
      applyFilters();
    }

    function applyFilters() {
      const status = document.getElementById('statusFilter').value;
      const billing = document.getElementById('billingFilter').value;
      const search = document.getElementById('searchItineraries').value.toLowerCase();

      filteredItineraries = itineraries.filter(it => {
        if (status && it.status !== status) return false;
        if (billing && it.billing_type !== billing) return false;
        if (search) {
          const searchFields = [
            it.title,
            it.bill_to_name,
            it.bill_to_company,
            it.bill_to_gst,
            it.passenger?.full_name,
            it.corporate?.company_name
          ].filter(Boolean).join(' ').toLowerCase();
          if (!searchFields.includes(search)) return false;
        }
        return true;
      });

      renderItineraries();
    }

    function renderItineraries() {
      const container = document.getElementById('itinerariesContainer');

      if (filteredItineraries.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>No Itineraries Found</h3>
            <p>Create your first itinerary or adjust filters.</p>
            <a href="/" class="btn btn-primary">‚úàÔ∏è Create Itinerary</a>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredItineraries.map(it => `
        <div class="itinerary-card ${it.status}" data-id="${it.id}">
          <div class="itinerary-header">
            <div class="itinerary-title-section">
              <h3 class="itinerary-title">${it.title || 'Untitled Itinerary'}</h3>
              <div class="itinerary-meta">
                <span class="meta-item">üìÖ ${new Date(it.created_at).toLocaleDateString()}</span>
                ${it.updated_at ? `<span class="meta-item">‚úèÔ∏è ${new Date(it.updated_at).toLocaleDateString()}</span>` : ''}
              </div>
            </div>
            <div class="itinerary-badges">
              <span class="badge badge-status badge-${it.status}">${formatStatus(it.status)}</span>
              <span class="badge badge-billing">${it.billing_type === 'corporate' ? 'üè¢ Corporate' : 'üë§ Individual'}</span>
            </div>
          </div>
          
          <div class="itinerary-body">
            <div class="itinerary-details">
              <div class="detail-column">
                <h4>Passenger</h4>
                ${it.passenger ? `
                  <div class="detail-value">
                    <span class="avatar-sm">${(it.passenger.first_name || 'P').charAt(0)}</span>
                    ${it.passenger.full_name || `${it.passenger.first_name} ${it.passenger.last_name}`}
                  </div>
                ` : '<span class="detail-value text-muted">Not specified</span>'}
              </div>
              
              ${it.billing_type === 'corporate' ? `
                <div class="detail-column">
                  <h4>Corporate</h4>
                  ${it.corporate ? `
                    <div class="detail-value">
                      <span class="icon-sm">üè¢</span>
                      ${it.corporate.company_name}
                    </div>
                    ${it.bill_to_gst ? `<div class="detail-sub">GST: ${it.bill_to_gst}</div>` : ''}
                  ` : '<span class="detail-value text-muted">Not specified</span>'}
                </div>
              ` : `
                <div class="detail-column">
                  <h4>Bill To</h4>
                  <div class="detail-value">${it.bill_to_name || 'Not specified'}</div>
                </div>
              `}
              
              <div class="detail-column">
                <h4>Amount</h4>
                <div class="detail-value amount">${it.total_amount ? '‚Çπ' + it.total_amount.toLocaleString() : '-'}</div>
              </div>
            </div>
            
            ${it.selected_flight_option !== null ? `
              <div class="selected-flight-indicator">
                <span class="indicator-icon">‚úì</span>
                Flight option ${it.selected_flight_option + 1} selected
              </div>
            ` : ''}
          </div>
          
          <div class="itinerary-actions">
            <button class="btn btn-secondary" onclick="viewItineraryDetails('${it.id}')">
              <span>üëÅÔ∏è</span> View
            </button>
            <button class="btn btn-secondary" onclick="editItinerary('${it.id}')">
              <span>‚úèÔ∏è</span> Edit
            </button>
            ${it.status === 'pending_approval' && it.selected_flight_option !== null ? `
              <button class="btn btn-success" onclick="approveItinerary('${it.id}')">
                <span>‚úì</span> Approve
              </button>
            ` : ''}
            <button class="btn btn-danger-outline" onclick="deleteItinerary('${it.id}')">
              <span>üóëÔ∏è</span>
            </button>
          </div>
        </div>
      `).join('');
    }

    function formatStatus(status) {
      const statusLabels = {
        'draft': 'Draft',
        'pending_approval': 'Pending Approval',
        'approved': 'Approved',
        'booked': 'Booked',
        'cancelled': 'Cancelled',
        'completed': 'Completed'
      };
      return statusLabels[status] || status;
    }

    // View Itinerary Details
    async function viewItineraryDetails(itineraryId) {
      try {
        const response = await fetch(`/api/v2/itineraries/${itineraryId}`);
        if (!response.ok) throw new Error('Failed to load itinerary');

        currentItinerary = await response.json();
        renderItineraryDetails();
        document.getElementById('itineraryDetailModal').classList.add('active');
      } catch (e) {
        showNotification('Failed to load itinerary details', 'error');
      }
    }

    function renderItineraryDetails() {
      const it = currentItinerary;
      const content = document.getElementById('itineraryDetailContent');

      document.getElementById('itineraryDetailTitle').innerHTML = `
        ${it.title || 'Itinerary Details'}
        <span onclick="editItineraryTitle()" style="cursor:pointer; font-size:0.5em; margin-left:10px; opacity:0.6;" title="Edit Title">‚úèÔ∏è</span>
      `;

      const flights = it.flights || [];

      content.innerHTML = `
        <div class="detail-header-row">
          <div class="status-badges">
            <span class="badge badge-lg badge-status badge-${it.status}">${formatStatus(it.status)}</span>
            <span class="badge badge-lg badge-billing">${(it.billing_account && it.billing_account.company_name) || it.bill_to_company ? 'üè¢ B2B' : 'üë§ B2C'}</span>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="editItinerary('${it.id}'); closeItineraryDetailModal();">
              <span>‚úèÔ∏è</span> Full Edit
            </button>
            ${it.status === 'pending_approval' && it.selected_flight_option !== null ? `
              <button class="btn btn-success" onclick="approveItinerary('${it.id}')">
                <span>‚úì</span> Approve
              </button>
            ` : ''}
          </div>
        </div>
        
        <div class="detail-sections">
          <!-- Passenger & Billing -->
          <div class="detail-section">
            <div class="passenger-list-header">
               <h4>Passenger & Itinerary Details</h4>
               <div style="display:flex; gap:10px;">
                 <button class="btn btn-secondary btn-sm" onclick="openBillingManager()">
                   <span>üí≥</span> Manage Billing
                 </button>
                 <button class="btn btn-secondary btn-sm" onclick="openPassengerManager()">
                   <span>üë•</span> Manage Passengers
                 </button>
               </div>
            </div>
            
            <div class="detail-grid detail-grid-3">
              <div class="detail-item">
                <span class="detail-label">Main Passenger</span>
                <span class="detail-value">
                  ${it.passenger ? `
                    <a class="name-link" onclick="handlePassengerClick('${it.passenger.id}', ${JSON.stringify(it.passenger).replace(/'/g, "&apos;")})">
                      ${it.passenger.full_name || `${it.passenger.first_name} ${it.passenger.last_name}`}
                    </a>
                  ` : (it.passengers_data && it.passengers_data.length > 0 ?
          `<a class="name-link" onclick="handlePassengerClick('${it.passengers_data[0].id || ''}', ${JSON.stringify(it.passengers_data[0]).replace(/'/g, "&apos;")})">
            ${it.passengers_data[0].first_name} ${it.passengers_data[0].last_name}
          </a>`
          : (it.bill_to_name || 'Not specified'))}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Total Passengers</span>
                <span class="detail-value">${it.num_passengers || 1}</span>
              </div>
              
                <div class="detail-item">
                  <span class="detail-label">Billing To</span>
                  <span class="detail-value">
                    ${it.billing_account ?
          `<strong>${it.billing_account.display_name}</strong><br>
                         <span class="text-xs text-muted">
                           ${it.billing_account.company_name ? it.billing_account.company_name + '<br>' : ''}
                           ${it.billing_account.gst_number ? `GST: ${it.billing_account.gst_number}<br>` : ''}
                           ${it.billing_account.email ? it.billing_account.email + '<br>' : ''}
                           ${it.billing_account.phone ? it.billing_account.phone : ''}
                         </span>`
          :
          (it.bill_to_name ?
            `<strong>${it.bill_to_name}</strong><br>
                             <span class="text-xs text-muted">
                               ${it.bill_to_company ? it.bill_to_company + '<br>' : ''}
                               ${it.bill_to_gst ? `GST: ${it.bill_to_gst}<br>` : ''}
                               ${it.bill_to_email ? it.bill_to_email + '<br>' : ''}
                               ${it.bill_to_phone ? it.bill_to_phone : ''}
                             </span>`
            : 'Not specified')
        }
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Billing Type</span>
                  <span class="detail-value">
                     ${(it.billing_account && it.billing_account.company_name) || it.bill_to_company ? 'B2B Customer' : 'B2C Customer'}
                  </span>
                </div>
            </div>
          </div>

          <!-- Additional Passengers (Collapsible) -->
          ${it.passengers_data && it.passengers_data.length > 0 ? `
            <div class="detail-section collapsible">
              <h4 class="collapsible-header" onclick="toggleSection(this)">
                <span>üë• Additional Passengers Details (${it.passengers_data.length})</span>
                <span class="collapse-icon">‚ñ∂</span>
              </h4>
              <div class="collapsible-content collapsed">
                <div class="passenger-grid">
                  ${it.passengers_data.map(p => {
          const isRegistered = !!(p.id || p.is_db);
          const pId = p.id || '';
          return `
                    <div class="passenger-mini-card">
                      <div class="avatar">${(p.first_name || 'P').charAt(0)}</div>
                      <div class="info">
                        <span class="name">
                          <a class="name-link" onclick="handlePassengerClick('${pId}', ${JSON.stringify(p).replace(/'/g, "&apos;")})">
                            ${p.first_name} ${p.last_name || ''}
                          </a>
                        </span>
                        <span class="type">${isRegistered ? '‚úÖ Registered' : 'üìù Temporary'}</span>
                      </div>
                      ${!isRegistered ? `
                        <button class="btn-quick-add" onclick="quickRegister('${p.first_name}', '${p.last_name || ''}', '${p.email || ''}', '${p.phone || ''}')" title="Add to Registered Passengers">+</button>
                      ` : ''}
                    </div>
                  `}).join('')}
                </div>
              </div>
            </div>
          ` : ''}
          
          <!-- Financials -->
          <div class="detail-section">
            <h4>Financial Summary</h4>
            <div class="financial-grid">
              <div class="financial-item">
                <span class="financial-label">Total Amount</span>
                <span class="financial-value">${it.total_amount ? '‚Çπ' + it.total_amount.toLocaleString() : '-'}</span>
              </div>
              <div class="financial-item">
                <span class="financial-label">Markup</span>
                <span class="financial-value">${it.markup ? '‚Çπ' + it.markup.toLocaleString() : '-'}</span>
              </div>
              <div class="financial-item">
                <span class="financial-label">Service Charge</span>
                <span class="financial-value">${it.service_charge ? '‚Çπ' + it.service_charge.toLocaleString() : '-'}</span>
              </div>
              <div class="financial-item">
                <span class="financial-label">GST Amount</span>
                <span class="financial-value">${it.gst_amount ? '‚Çπ' + it.gst_amount.toLocaleString() : '-'}</span>
              </div>
              ${it.promo_code_used ? `
                <div class="financial-item">
                  <span class="financial-label">Promo Code</span>
                  <span class="financial-value promo">${it.promo_code_used}</span>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- Flight Options -->
          <div class="detail-section">
            <h4>Flight Options ${it.selected_flight_option !== null ? `<span class="selected-badge">Option ${it.selected_flight_option + 1} selected</span>` : ''}</h4>
            <div class="flight-options">
              ${flights.length > 0 ? flights.map((flight, index) => `
                <div class="flight-option-card ${it.selected_flight_option === index ? 'selected' : ''}">
                  <div class="flight-option-header">
                    <span class="option-number">Option ${index + 1}</span>
                    ${it.selected_flight_option === index ? '<span class="selected-indicator">‚úì Selected</span>' : ''}
                  </div>
                  <div class="flight-details">
                    <div class="flight-route">
                      <div class="airport-info">
                        <span class="airport-code">${flight.source || flight.departure?.code || '-'}</span>
                        <span class="airport-time">${flight.departure_time || flight.departure?.time || '-'}</span>
                      </div>
                      <div class="flight-path">
                        <span class="airline-info">
                          ${flight.airline_code || flight.airline || ''}
                          ${flight.flight_number || flight.flight_no || ''}
                        </span>
                        <div class="path-line">
                          <span class="path-dot"></span>
                          <span class="path-dashed"></span>
                          <span class="path-dot"></span>
                        </div>
                        <span class="flight-duration">${flight.duration || '-'}</span>
                      </div>
                      <div class="airport-info">
                        <span class="airport-code">${flight.destination || flight.arrival?.code || '-'}</span>
                        <span class="airport-time">${flight.arrival_time || flight.arrival?.time || '-'}</span>
                      </div>
                    </div>
                    <div class="flight-meta">
                      <span class="meta-badge">${flight.date || '-'}</span>
                      ${flight.cabin_class ? `<span class="meta-badge">${flight.cabin_class}</span>` : ''}
                      ${flight.stops !== undefined ? `<span class="meta-badge">${flight.stops === 0 ? 'Non-stop' : flight.stops + ' stop(s)'}</span>` : ''}
                    </div>
                    <div class="flight-fares">
                      ${flight.fares ? Object.entries(flight.fares).map(([type, amount]) => `
                        <div class="fare-option">
                          <span class="fare-type">${type}</span>
                          <span class="fare-amount">‚Çπ${amount?.toLocaleString() || 0}</span>
                        </div>
                      `).join('') : '<span class="text-muted">No fares</span>'}
                    </div>
                  </div>
                </div>
              `).join('') : '<p class="empty-text">No flight options available.</p>'}
            </div>
          </div>
          
          <!-- Timestamps -->
          <div class="detail-section">
            <h4>Timeline</h4>
            <div class="timeline">
              <div class="timeline-item">
                <span class="timeline-label">Created</span>
                <span class="timeline-value">${new Date(it.created_at).toLocaleString()}</span>
              </div>
              ${it.updated_at ? `
                <div class="timeline-item">
                  <span class="timeline-label">Last Updated</span>
                  <span class="timeline-value">${new Date(it.updated_at).toLocaleString()}</span>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function toggleSection(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.collapse-icon');
      content.classList.toggle('collapsed');
      icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function closeItineraryDetailModal() {
      document.getElementById('itineraryDetailModal').classList.remove('active');
      currentItinerary = null;

      // Clear URL parameter
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.replaceState({}, '', url);
    }

    // --- Full Passenger Management logic ---
    async function loadAirlines() {
      try {
        const response = await fetch('/api/v2/airlines');
        if (response.ok) {
          const data = await response.json();
          airlines = data.airlines;
          populateAirlineDropdowns();
        }
      } catch (e) {
        console.error('Failed to load airlines:', e);
      }
    }

    function populateAirlineDropdowns() {
      const select = document.getElementById('ffAirline');
      if (select) {
        select.innerHTML = '<option value="">Select Airline</option>';
        airlines.forEach(airline => {
          const option = document.createElement('option');
          option.value = airline.id;
          option.textContent = `${airline.iata_code} - ${airline.name}`;
          select.appendChild(option);
        });
      }
    }

    async function handlePassengerClick(id, data) {
      if (!id) {
        showNotification('No details found for unregistered passenger', 'info');
        return;
      }

      try {
        const response = await fetch(`/api/v2/passengers/${id}`);
        if (!response.ok) throw new Error('Failed to load passenger');

        currentPassenger = await response.json();
        openPaxDetailModal();
      } catch (e) {
        console.error(e);
        showNotification('Failed to load passenger details', 'error');
      }
    }

    function openPaxDetailModal() {
      const p = currentPassenger;
      if (!p) return;

      document.getElementById('paxDetailTitle').textContent = `Manage: ${p.first_name} ${p.last_name}`;

      // Populate Profile Tab
      document.getElementById('editPaxId').value = p.id;
      document.getElementById('editPaxTitle').value = p.title || '';
      document.getElementById('editPaxFirstName').value = p.first_name || '';
      document.getElementById('editPaxMiddleName').value = p.middle_name || '';
      document.getElementById('editPaxLastName').value = p.last_name || '';
      document.getElementById('editPaxDOB').value = p.date_of_birth || '';
      document.getElementById('editPaxGender').value = p.gender || '';
      document.getElementById('editPaxNationality').value = p.nationality || '';
      document.getElementById('editPaxEmail').value = p.email || '';
      document.getElementById('editPaxPhone').value = p.phone || '';

      // Populate Prefs Tab
      const prefs = p.preferences || {};
      document.getElementById('editPrefsMeal').value = prefs.meal_preference || '';
      document.getElementById('editPrefsMealReq').value = prefs.meal_special_request || '';
      document.getElementById('editPrefsSeat').value = prefs.seat_preference || '';
      document.getElementById('editPrefsAssistance').value = prefs.special_assistance_type || '';
      document.getElementById('editPrefsWheelchair').checked = prefs.wheelchair_required || false;
      document.getElementById('editPrefsPrefAir').value = prefs.preferred_airlines || '';
      document.getElementById('editPrefsAvoidAir').value = prefs.avoid_airlines || '';

      // Render Lists
      renderPaxDocs();
      renderPaxFF();

      showPaxTab('profile');
      document.getElementById('paxDetailModal').classList.add('active');
    }

    function closePaxDetailModal() {
      document.getElementById('paxDetailModal').classList.remove('active');
    }

    function showPaxTab(tabName) {
      document.querySelectorAll('.pax-tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.detail-tabs .tab-btn').forEach(b => b.classList.remove('active'));

      document.getElementById(`pax-tab-${tabName}`).classList.add('active');
      const btn = document.getElementById(`btn-tab-${tabName}`);
      if (btn) btn.classList.add('active');
    }

    function renderPaxDocs() {
      const list = document.getElementById('paxDocList');
      const docs = currentPassenger.travel_documents || [];

      if (docs.length === 0) {
        list.innerHTML = '<p style="color:var(--text-secondary); font-size:0.9rem;">No documents added.</p>';
        return;
      }

      list.innerHTML = docs.map(d => `
        <div class="doc-badge">
          <div style="font-weight:600;">${d.document_type}</div>
          <div style="color:var(--text-secondary);">${d.document_number}</div>
          <div style="font-size:0.75rem; color:var(--accent-danger);">Exp: ${d.expiry_date || 'N/A'}</div>
          <button class="btn-delete-small" onclick="deletePaxDoc('${d.id}')" title="Delete">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderPaxFF() {
      const list = document.getElementById('paxFfList');
      const accounts = currentPassenger.frequent_flyer_accounts || [];

      if (accounts.length === 0) {
        list.innerHTML = '<p style="color:var(--text-secondary); font-size:0.9rem;">No frequent flyer accounts.</p>';
        return;
      }

      list.innerHTML = accounts.map(a => `
        <div class="ff-badge">
          <div style="font-weight:600;">${a.airline_code}</div>
          <div style="color:var(--text-secondary);">${a.frequent_flyer_number}</div>
          ${a.tier_status ? `<span class="badge" style="background:var(--bg-tertiary); color:var(--text-primary); font-size:0.7rem;">${a.tier_status}</span>` : ''}
          <button class="btn-delete-small" onclick="deletePaxFF('${a.id}')" title="Delete">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    async function savePaxProfile(event) {
      event.preventDefault();
      const id = document.getElementById('editPaxId').value;
      const data = {
        title: document.getElementById('editPaxTitle').value,
        first_name: document.getElementById('editPaxFirstName').value,
        middle_name: document.getElementById('editPaxMiddleName').value,
        last_name: document.getElementById('editPaxLastName').value,
        date_of_birth: document.getElementById('editPaxDOB').value || null,
        gender: document.getElementById('editPaxGender').value,
        nationality: document.getElementById('editPaxNationality').value,
        email: document.getElementById('editPaxEmail').value,
        phone: document.getElementById('editPaxPhone').value
      };

      try {
        const response = await fetch(`/api/v2/passengers/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          showNotification('Profile updated successfully', 'success');
          const p = await (await fetch(`/api/v2/passengers/${id}`)).json();
          currentPassenger = p;
        } else {
          showNotification('Failed to update profile', 'error');
        }
      } catch (e) {
        showNotification('Update failed', 'error');
      }
    }

    async function savePaxPrefs(event) {
      event.preventDefault();
      const id = currentPassenger.id;
      const data = {
        meal_preference: document.getElementById('editPrefsMeal').value,
        meal_special_request: document.getElementById('editPrefsMealReq').value,
        seat_preference: document.getElementById('editPrefsSeat').value,
        special_assistance_type: document.getElementById('editPrefsAssistance').value,
        wheelchair_required: document.getElementById('editPrefsWheelchair').checked,
        preferred_airlines: document.getElementById('editPrefsPrefAir').value,
        avoid_airlines: document.getElementById('editPrefsAvoidAir').value
      };

      try {
        const response = await fetch(`/api/v2/passengers/${id}/preferences`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          showNotification('Preferences updated', 'success');
        } else {
          showNotification('Failed to save preferences', 'error');
        }
      } catch (e) {
        showNotification('Save failed', 'error');
      }
    }

    async function savePaxDoc(event) {
      event.preventDefault();
      const id = currentPassenger.id;
      const data = {
        document_type: document.getElementById('docType').value,
        document_number: document.getElementById('docNumber').value,
        expiry_date: document.getElementById('docExpiry').value
      };

      try {
        const response = await fetch(`/api/v2/passengers/${id}/documents`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          showNotification('Document added', 'success');
          const p = await (await fetch(`/api/v2/passengers/${id}`)).json();
          currentPassenger.travel_documents = p.travel_documents;
          renderPaxDocs();
          document.getElementById('paxDocForm').reset();
        }
      } catch (e) {
        showNotification('Add failed', 'error');
      }
    }

    async function savePaxFf(event) {
      event.preventDefault();
      const id = currentPassenger.id;
      const data = {
        airline_id: document.getElementById('ffAirline').value,
        frequent_flyer_number: document.getElementById('ffNumber').value,
        tier_status: document.getElementById('ffTier').value
      };

      try {
        const response = await fetch(`/api/v2/passengers/${id}/frequent-flyer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          showNotification('FF account added', 'success');
          const p = await (await fetch(`/api/v2/passengers/${id}`)).json();
          currentPassenger.frequent_flyer_accounts = p.frequent_flyer_accounts;
          renderPaxFF();
          document.getElementById('paxFfForm').reset();
        }
      } catch (e) {
        showNotification('Add failed', 'error');
      }
    }

    async function deletePaxDoc(docId) {
      if (!confirm('Are you sure you want to delete this document?')) return;
      try {
        const response = await fetch(`/api/v2/passengers/${currentPassenger.id}/documents/${docId}`, { method: 'DELETE' });
        if (response.ok) {
          showNotification('Document deleted', 'success');
          currentPassenger.travel_documents = currentPassenger.travel_documents.filter(d => d.id !== docId);
          renderPaxDocs();
        }
      } catch (e) { }
    }

    async function deletePaxFF(ffId) {
      if (!confirm('Are you sure you want to delete this FF account?')) return;
      try {
        const response = await fetch(`/api/v2/passengers/${currentPassenger.id}/frequent-flyer/${ffId}`, { method: 'DELETE' });
        if (response.ok) {
          showNotification('FF account deleted', 'success');
          currentPassenger.frequent_flyer_accounts = currentPassenger.frequent_flyer_accounts.filter(a => a.id !== ffId);
          renderPaxFF();
        }
      } catch (e) { }
    }


    async function viewPassengerProfile(passengerId) {
      try {
        const response = await fetch(`/api/v2/passengers/${passengerId}`);
        if (!response.ok) throw new Error('Failed to load profile');

        const p = await response.json();
        const content = document.getElementById('profileModalContent');

        document.getElementById('profileModalTitle').textContent = `${p.first_name} ${p.last_name}'s Profile`;

        content.innerHTML = `
          <div class="profile-info-grid">
            <div>
              <h4 class="profile-section-title">Personal Info</h4>
              <div class="profile-item"><span class="profile-label">Full Name</span><span class="profile-value">${p.title || ''} ${p.first_name} ${p.middle_name || ''} ${p.last_name}</span></div>
              <div class="profile-item"><span class="profile-label">Email</span><span class="profile-value">${p.email || '-'}</span></div>
              <div class="profile-item"><span class="profile-label">Phone</span><span class="profile-value">${p.phone || '-'}</span></div>
              <div class="profile-item"><span class="profile-label">Nationality</span><span class="profile-value">${p.nationality || '-'}</span></div>
            </div>
            <div>
              <h4 class="profile-section-title">Preferences</h4>
              ${p.preferences ? `
                <div class="pref-list" style="margin-top:0.5rem;">
                  ${p.preferences.meal_preference ? `<span class="pref-tag">üç¥ ${p.preferences.meal_preference}</span>` : ''}
                  ${p.preferences.seat_preference ? `<span class="pref-tag">üí∫ ${p.preferences.seat_preference}</span>` : ''}
                  ${p.preferences.special_assistance ? `<span class="pref-tag">‚ôø ${p.preferences.special_assistance}</span>` : ''}
                   ${p.preferences.home_airport ? `<span class="pref-tag">üè† ${p.preferences.home_airport}</span>` : ''}
                </div>
                ${p.preferences.remarks ? `<p style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.5rem;">Note: ${p.preferences.remarks}</p>` : ''}
              ` : '<p style="font-size:0.85rem; color:var(--text-secondary);">No preferences set.</p>'}
            </div>
          </div>

          <div>
            <h4 class="profile-section-title">Frequent Flyer Accounts</h4>
            <div style="display:flex; flex-wrap:wrap;">
              ${p.frequent_flyer_accounts && p.frequent_flyer_accounts.length > 0 ?
            p.frequent_flyer_accounts.map(ff => `
                  <div class="ff-badge">
                    <span style="font-weight:700;">${ff.airline_code || ff.airline}</span>
                    <span style="color:var(--text-secondary);">${ff.ff_number}</span>
                    ${ff.tier ? `<span class="badge badge-tier" style="margin-left:0.5rem; transform:scale(0.8);">${ff.tier}</span>` : ''}
                  </div>
                `).join('')
            : '<p style="font-size:0.85rem; color:var(--text-secondary);">No accounts linked.</p>'}
            </div>
          </div>

          <div style="margin-top:1.5rem;">
            <h4 class="profile-section-title">Travel Documents</h4>
            <div style="display:flex; flex-wrap:wrap;">
               ${p.travel_documents && p.travel_documents.length > 0 ?
            p.travel_documents.map(td => `
                  <div class="ff-badge">
                    <span style="font-weight:700;">${td.doc_type}</span>
                    <span style="color:var(--text-secondary);">${td.doc_number}</span>
                     ${td.expiry_date ? `<span style="font-size:0.7rem; color:var(--accent-danger); margin-left:0.5rem;">Exp: ${new Date(td.expiry_date).toLocaleDateString()}</span>` : ''}
                  </div>
                `).join('')
            : '<p style="font-size:0.85rem; color:var(--text-secondary);">No documents added.</p>'}
            </div>
          </div>
        `;

        document.getElementById('passengerProfileModal').classList.add('active');
      } catch (e) {
        console.error(e);
        showNotification('Failed to load passenger profile', 'error');
      }
    }

    function closePassengerProfileModal() {
      document.getElementById('passengerProfileModal').classList.remove('active');
    }

    async function quickRegister(first, last, email, phone) {
      // Create URL with parameters for pre-filling the registration form
      const params = new URLSearchParams({
        quick: 'true',
        first: first || '',
        last: last || '',
        email: email || '',
        phone: phone || '',
        itinerary_id: currentItinerary ? currentItinerary.id : ''
      });

      // Redirect to passenger page
      window.location.href = `/passengers?${params.toString()}`;
    }

    // Edit Itinerary - Redirect to main page with state
    function editItinerary(itineraryId) {
      // Store the itinerary ID in session storage and redirect to home
      sessionStorage.setItem('editItineraryId', itineraryId);
      window.location.href = '/?edit=' + itineraryId;
    }

    // Approve Itinerary
    async function approveItinerary(itineraryId) {
      const confirmed = await showConfirm('Approve Itinerary', 'Are you sure you want to approve this itinerary? This action cannot be undone.');
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/v2/itineraries/${itineraryId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          showNotification('Itinerary approved successfully', 'success');
          closeItineraryDetailModal();
          await loadItineraries();
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to approve itinerary', 'error');
        }
      } catch (e) {
        showNotification('Failed to approve itinerary', 'error');
      }
    }

    // Delete Itinerary
    async function deleteItinerary(itineraryId) {
      const confirmed = await showConfirm('Delete Itinerary', 'Are you sure you want to delete this itinerary? This action cannot be undone.');
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/v2/itineraries/${itineraryId}`, { method: 'DELETE' });
        if (response.ok) {
          showNotification('Itinerary deleted successfully', 'success');
          await loadItineraries();
        } else {
          showNotification('Failed to delete itinerary', 'error');
        }
      } catch (e) {
        showNotification('Failed to delete itinerary', 'error');
      }
    }

    // Utility functions
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function showConfirm(title, message) {
      return new Promise(resolve => {
        confirmResolve = resolve;
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.add('active');
      });
    }

    function closeConfirmModal(result) {
      document.getElementById('confirmModal').classList.remove('active');
      if (confirmResolve) {
        confirmResolve(result);
        confirmResolve = null;
      }
    }

    // --- Passenger Management Logic ---
    let allPassengersList = []; // For search
    let tempPassengerData = []; // Local modifications before saving
    let tempMainPassenger = null; // Main passenger for corporate billing

    async function openPassengerManager() {
      if (!currentItinerary) return;

      const modal = document.getElementById('passengerManagementModal');
      const numInput = document.getElementById('manageNumPassengers');

      // Default to 1 if individual billing
      if (currentItinerary.billing_type === 'passenger') {
        numInput.value = 1;
        numInput.disabled = true;
      } else {
        numInput.value = currentItinerary.num_passengers || 1;
        numInput.disabled = false;
      }

      // Load current passengers into temp state
      tempPassengerData = JSON.parse(JSON.stringify(currentItinerary.passengers_data || []));

      // We also need to keep track of the main passenger in the modal
      tempMainPassenger = currentItinerary.passenger ? {
        id: currentItinerary.passenger.id,
        first_name: currentItinerary.passenger.first_name,
        last_name: currentItinerary.passenger.last_name,
        email: currentItinerary.passenger.email,
        phone: currentItinerary.passenger.phone,
        is_db: true,
        is_main: true
      } : null;

      renderAssignedPassengers();

      // Load all passengers for search if not already loaded
      if (allPassengersList.length === 0) {
        try {
          const response = await fetch('/api/v2/passengers');
          if (response.ok) {
            const data = await response.json();
            allPassengersList = data.passengers;
          }
        } catch (e) {
          console.error('Failed to load passengers for search', e);
        }
      }

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePassengerManagementModal() {
      document.getElementById('passengerManagementModal').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('newPassengerForm').style.display = 'none';
      document.getElementById('passengerSearchInput').value = '';
      document.getElementById('passengerSearchResults').classList.remove('active');
    }

    function handlePassengerSearch() {
      const query = document.getElementById('passengerSearchInput').value.toLowerCase();
      const resultsContainer = document.getElementById('passengerSearchResults');
      const num_passengers = parseInt(document.getElementById('manageNumPassengers').value) || 1;

      // Proceed even if empty

      // Check if we can add more passengers
      const currentTotal = (tempMainPassenger ? 1 : 0) + tempPassengerData.length;
      if (currentTotal >= num_passengers) {
        resultsContainer.innerHTML = '<div class="search-result-item">Max passengers reached. Increase "Total Passengers" to add more.</div>';
        resultsContainer.classList.add('active');
        return;
      }

      const filtered = allPassengersList.filter(p =>
        p.first_name.toLowerCase().includes(query) ||
        p.last_name.toLowerCase().includes(query) ||
        (p.email && p.email.toLowerCase().includes(query))
      ).slice(0, 5);

      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No passengers found</div>';
      } else {
        resultsContainer.innerHTML = filtered.map(p => `
          <div class="search-result-item" onclick='addPassengerFromSearch(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
            <div class="avatar" style="width:30px; height:30px; font-size:0.8rem;">${p.first_name.charAt(0)}</div>
            <div>
              <div style="font-weight:600; font-size:0.85rem;">${p.first_name} ${p.last_name}</div>
              <div style="font-size:0.75rem; color:var(--text-secondary);">${p.email || 'No email'}</div>
            </div>
          </div>
        `).join('');
      }
      resultsContainer.classList.add('active');
    }

    function addPassengerFromSearch(p) {
      // Check if already in list
      if (tempPassengerData.find(tp => tp.id === p.id)) {
        showNotification('Passenger already added', 'warning');
        return;
      }

      tempPassengerData.push({
        id: p.id,
        first_name: p.first_name,
        last_name: p.last_name,
        email: p.email,
        phone: p.phone,
        is_db: true
      });

      renderAssignedPassengers();
      document.getElementById('passengerSearchInput').value = '';
      document.getElementById('passengerSearchResults').classList.remove('active');
    }

    function toggleNewPassengerForm() {
      const num_passengers = parseInt(document.getElementById('manageNumPassengers').value) || 1;
      const currentTotal = (tempMainPassenger ? 1 : 0) + tempPassengerData.length;

      if (currentTotal >= num_passengers) {
        showNotification('Max passengers reached. Increase "Total Passengers" to add more.', 'warning');
        return;
      }

      const form = document.getElementById('newPassengerForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function addNewTempPassenger() {
      const first_name = document.getElementById('newPFirstName').value;
      const last_name = document.getElementById('newPLastName').value;
      const email = document.getElementById('newPEmail').value;
      const phone = document.getElementById('newPPhone').value;

      if (!first_name) {
        showNotification('First name is required', 'warning');
        return;
      }

      tempPassengerData.push({
        first_name,
        last_name,
        email,
        phone,
        is_db: false
      });

      renderAssignedPassengers();

      // Clear form
      document.getElementById('newPFirstName').value = '';
      document.getElementById('newPLastName').value = '';
      document.getElementById('newPEmail').value = '';
      document.getElementById('newPPhone').value = '';
      document.getElementById('newPassengerForm').style.display = 'none';
    }

    function removePassenger(index) {
      tempPassengerData.splice(index, 1);
      renderAssignedPassengers();
    }

    function promoteToMain(index) {
      if (currentItinerary.billing_type === 'passenger') return;

      const selected = tempPassengerData[index];
      if (!selected.is_db) {
        showNotification('Only registered passengers can be set as the Main Passenger.', 'warning');
        return;
      }

      // Current main becomes a secondary passenger
      if (tempMainPassenger) {
        const oldMain = { ...tempMainPassenger };
        delete oldMain.is_main;
        tempPassengerData.push(oldMain);
      }

      // Selected becomes main
      tempMainPassenger = { ...selected, is_main: true };
      tempPassengerData.splice(index, 1);

      renderAssignedPassengers();
      showNotification(`${tempMainPassenger.first_name} set as main passenger`, 'info');
    }

    function renderAssignedPassengers() {
      const container = document.getElementById('assignedPassengersList');
      const html = [];

      // Show main passenger first
      if (tempMainPassenger) {
        html.push(`
          <div class="passenger-mini-card main-p" style="border: 2px solid var(--primary-color);">
            <div class="avatar" style="background: var(--primary-color); color: white;">${tempMainPassenger.first_name.charAt(0)}</div>
            <div class="info">
              <span class="name">${tempMainPassenger.first_name} ${tempMainPassenger.last_name || ''}</span>
              <span class="type" style="color: var(--primary-color); font-weight: 600;">üëë Main Traveler</span>
            </div>
            ${currentItinerary.billing_type === 'corporate' ? `
              <div style="font-size: 0.7rem; color: var(--text-secondary); margin-left: auto;">Primary</div>
            ` : ''}
          </div>
        `);
      }

      tempPassengerData.forEach((p, index) => {
        html.push(`
          <div class="passenger-mini-card">
            <div class="avatar">${p.first_name.charAt(0)}</div>
            <div class="info">
              <span class="name">${p.first_name} ${p.last_name || ''}</span>
              <span class="type">${p.is_db ? '‚úÖ Registered' : 'üìù Temporary'}</span>
            </div>
            <div class="actions" style="display: flex; gap: 0.5rem; margin-left: auto;">
              ${p.is_db && currentItinerary.billing_type === 'corporate' ? `
                <button class="btn btn-icon btn-sm" onclick="promoteToMain(${index})" title="Set as Main" style="font-size: 0.8rem;">‚≠ê</button>
              ` : ''}
              <button class="btn-remove-p" onclick="removePassenger(${index})">‚úï</button>
            </div>
          </div>
        `);
      });

      if (html.length === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-secondary);">No passengers assigned.</div>';
      } else {
        container.innerHTML = html.join('');
      }
    }

    async function savePassengerChanges() {
      const num_passengers = parseInt(document.getElementById('manageNumPassengers').value) || 1;

      // Validation: count must match num_passengers? 
      // User said "number of passengers being added should not be more than total passengers"
      const totalCount = (tempMainPassenger ? 1 : 0) + tempPassengerData.length;
      if (totalCount > num_passengers) {
        showNotification(`You have ${totalCount} passengers but "Total Passengers" is set to ${num_passengers}`, 'warning');
        return;
      }

      try {
        const payload = {
          num_passengers: num_passengers,
          passengers_data: tempPassengerData,
          passenger_id: tempMainPassenger ? tempMainPassenger.id : null
        };

        const response = await fetch(`/api/v2/itineraries/${currentItinerary.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          showNotification('Passengers updated successfully', 'success');
          const result = await response.json();

          // Update local state from response
          currentItinerary = result.itinerary;

          // Update global list
          const idx = itineraries.findIndex(it => it.id === currentItinerary.id);
          if (idx !== -1) itineraries[idx] = result.itinerary;

          renderItineraryDetails();
          closePassengerManagementModal();
        } else {
          showNotification('Failed to update passengers', 'error');
        }
      } catch (e) {
        console.error('Save error', e);
        showNotification('Error saving changes', 'error');
      }
    }
    // --- Billing Management & Title Editing Logic ---
    let allBillingAccounts = [];
    let allCustomersList = [];
    let currentManageBillingResults = [];

    async function editItineraryTitle() {
      const it = currentItinerary;
      const newTitle = prompt("Enter new title for this itinerary:", it.title || "");
      if (newTitle === null || newTitle.trim() === "") return;

      try {
        const response = await fetch(`/api/v2/itineraries/${it.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: newTitle.trim() })
        });

        if (response.ok) {
          showNotification('Title updated', 'success');
          const data = await response.json();
          currentItinerary = data.itinerary;
          renderItineraryDetails();
          // Update global list
          const idx = itineraries.findIndex(i => i.id === currentItinerary.id);
          if (idx !== -1) itineraries[idx] = currentItinerary;
        } else {
          showNotification('Failed to update title', 'error');
        }
      } catch (e) {
        showNotification('Error updating title', 'error');
      }
    }

    async function openBillingManager() {
      const modal = document.getElementById('billingManagementModal');
      document.getElementById('manageBillingSearchInput').value = '';
      document.getElementById('manageBillingSearchResults').style.display = 'none';
      document.getElementById('manageBillingSummary').style.display = 'none';
      document.getElementById('manageSelectedBillingId').value = '';

      // Set initial state if it has billing info
      if (currentItinerary.billing_account_id) {
        document.getElementById('manageSelectedBillingId').value = currentItinerary.billing_account_id;
        document.getElementById('manageSelectedName').textContent = currentItinerary.billing_account ? currentItinerary.billing_account.display_name : 'Saved Account';
        document.getElementById('manageBillingSummary').style.display = 'block';
      }

      // Pre-load data
      try {
        const res = await fetch('/api/v2/billing-accounts');
        if (res.ok) {
          const data = await res.json();
          allBillingAccounts = data.billing_accounts;
        }
      } catch (e) { }

      if (allCustomersList.length === 0) {
        // Combination of passengers and corporates
        allCustomersList = [];
        try {
          const pRes = await fetch('/api/v2/passengers');
          const cRes = await fetch('/api/v2/corporates');
          if (pRes.ok) {
            const pData = await pRes.json();
            pData.passengers.forEach(p => allCustomersList.push({ ...p, customer_type: 'passenger' }));
          }
          if (cRes.ok) {
            const cData = await cRes.json();
            cData.corporates.forEach(c => allCustomersList.push({ ...c, customer_type: 'corporate' }));
          }
        } catch (e) { }
      }

      modal.classList.add('active');
    }

    function closeBillingManagementModal() {
      document.getElementById('billingManagementModal').classList.remove('active');
    }

    function searchBillingInManager() {
      const q = document.getElementById('manageBillingSearchInput').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('manageBillingSearchResults');

      // Proceed even if empty

      currentManageBillingResults = [];

      allBillingAccounts.forEach(acc => {
        const displayName = (acc.display_name || '').toLowerCase();
        const companyName = (acc.company_name || '').toLowerCase();
        if (!q || displayName.includes(q) || companyName.includes(q)) {
          currentManageBillingResults.push({
            type: 'billing',
            id: acc.id,
            display: acc.display_name || 'Unnamed Account',
            sub: acc.company_name ? 'B2B Customer' : 'B2C Customer',
            raw: acc
          });
        }
      });

      allCustomersList.forEach(c => {
        const name = (c.first_name ? c.first_name + ' ' + (c.last_name || '') : (c.contact_person_name || '')).toLowerCase();
        const company = (c.company_name || '').toLowerCase();
        if (!q || name.includes(q) || company.includes(q)) {
          currentManageBillingResults.push({
            type: c.customer_type,
            id: c.id,
            display: c.customer_type === 'corporate' ? ((c.company_name || '') + (name ? ' (' + name + ')' : '')) : (c.first_name + ' ' + (c.last_name || '')),
            sub: c.customer_type === 'corporate' ? (c.company_name ? 'B2B Customer' : 'B2C Customer') : 'B2C Customer',
            raw: c
          });
        }
      });

      resultsDiv.innerHTML = currentManageBillingResults.slice(0, 15).map((r, i) => `
          <div onclick="selectBillingInManagerByIndex(${i})" 
               style="padding:12px 15px; cursor:pointer; border-bottom:1px solid var(--border-light); display:flex; align-items:center; gap:12px; transition: background 0.2s;">
            <div class="avatar" style="width:36px; height:36px; border-radius:50%; background:#6366f1; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              ${(r.display && r.display.trim().length > 0) ? r.display.trim()[0].toUpperCase() : '?'}
            </div>
            <div style="flex-grow:1; line-height:1.4;">
              <div style="font-weight:600; color:var(--text-primary); font-size:0.9rem;">${r.display}</div>
              <div style="font-size:0.75rem; color:var(--text-secondary); display:flex; align-items:center; gap:5px;">
                <span style="display:inline-block; width:6px; height:6px; border-radius:50%; background:${r.sub.includes('B2B') ? '#4caf50' : '#2196f3'};"></span>
                ${r.sub}
              </div>
            </div>
          </div>
        `).join('');
      resultsDiv.style.display = 'block';
    }

    let tempManagerBillingSelection = null;

    function selectBillingInManagerByIndex(i) {
      const res = currentManageBillingResults[i];
      if (!res) return;

      tempManagerBillingSelection = res;
      document.getElementById('manageBillingSearchResults').style.display = 'none';
      document.getElementById('manageSelectedName').textContent = res.display;

      const raw = res.raw;
      const email = raw.email || raw.contact_email || '';
      const phone = raw.phone || raw.contact_phone || '';
      const gst = raw.gst_number || raw.gst || '';
      const company = raw.company_name || '';

      const detailsHtml = `
        <div style="font-size:0.85em; color:var(--text-secondary); margin-top:5px;">
          ${company ? `<div><strong>Company:</strong> ${company}</div>` : ''}
          ${gst ? `<div><strong>GST:</strong> ${gst}</div>` : ''}
          ${email ? `<div><strong>Email:</strong> ${email}</div>` : ''}
          ${phone ? `<div><strong>Phone:</strong> ${phone}</div>` : ''}
          <div style="margin-top:5px; padding-top:5px; border-top:1px dashed var(--border); font-style:italic;">${res.sub}</div>
        </div>
      `;
      document.getElementById('manageSelectedDetails').innerHTML = detailsHtml;
      document.getElementById('manageBillingSummary').style.display = 'block';
    }

    async function saveBillingChanges() {
      if (!tempManagerBillingSelection && !document.getElementById('manageSelectedBillingId').value) {
        showNotification('Please select a billing option', 'warning');
        return;
      }

      const it = currentItinerary;
      let payload = {};

      if (tempManagerBillingSelection) {
        if (tempManagerBillingSelection.type === 'billing') {
          payload.billing_account_id = tempManagerBillingSelection.id;
          payload.bill_to_name = null; // Clear ad-hoc
        } else {
          // It's a customer, we treat as ad-hoc update for now unless we create a billing account on the fly.
          // To match index.html logic, let's just update the bill_to fields.
          const c = allCustomersList.find(x => x.id === tempManagerBillingSelection.id && x.customer_type === tempManagerBillingSelection.type);
          payload.billing_account_id = null;
          payload.bill_to_name = tempManagerBillingSelection.display;
          payload.bill_to_email = c.email || c.contact_email;
          payload.bill_to_phone = c.phone || c.contact_phone;
          payload.bill_to_company = c.company_name;
          payload.bill_to_gst = c.gst_number;
          payload.billing_type = c.customer_type;
        }
      }

      try {
        const response = await fetch(`/api/v2/itineraries/${it.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const data = await response.json();
          currentItinerary = data.itinerary;
          renderItineraryDetails();
          showNotification('Billing details updated', 'success');
          closeBillingManagementModal();
          // Update global list
          const idx = itineraries.findIndex(i => i.id === currentItinerary.id);
          if (idx !== -1) itineraries[idx] = currentItinerary;
        } else {
          showNotification('Update failed', 'error');
        }
      } catch (e) {
        showNotification('Error updating billing', 'error');
      }
    }

    // --- End Billing Management Logic ---

    // Close search results when clicking outside
    window.addEventListener('click', (e) => {
      // Passenger search
      if (!e.target.closest('#passengerSearchInput') && !e.target.closest('#passengerSearchResults')) {
        document.getElementById('passengerSearchResults').classList.remove('active');
      }
      // Billing search
      if (!e.target.closest('#manageBillingSearchInput') && !e.target.closest('#manageBillingSearchResults')) {
        const results = document.getElementById('manageBillingSearchResults');
        if (results) results.style.display = 'none';
      }
    });
  </script>
</body>

</html>